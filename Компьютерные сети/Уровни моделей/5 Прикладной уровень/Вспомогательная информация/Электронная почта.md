## Архитектура и службы

Система e-mail состоит из двух подсистем: 
- **Пользовательские агенты (user agents)/Пользовательский агент (MUA)**, позволяют пользователям читать и отправлять письма
- **Агенты передачи сообщений (message transfer agents)/Агент передачи почты (MTA)**, пересылают письма от отправителя к получателю или ещё их называют **почтовыми серверами (mail servers)**.
![[Pasted image 20250107204325.png]]


#### Взаимодействие между агентами

1. **Пользовательский агент (MUA)**: Это программа или приложение, которое позволяет пользователю получать и управлять своей почтой. Примеры включают Microsoft Outlook, Mozilla Thunderbird и веб-интерфейсы, такие как Gmail.

2. **Агент передачи почты (MTA)**: Это сервер, который принимает и отправляет электронные письма. Он использует протокол SMTP (Simple Mail Transfer Protocol) для передачи сообщений между серверами.


==SMTP== был впервые описан в RFC 821. Позже в него вносились изменения вплоть до текущей редакции RFC 5321. **Он отправляет сообщения по соединениям и высылает обратно отчеты о статусе доставки и любых возникших ошибках**.

RFC 5322; в нее включена поддержка мультимедиа-контента и международный текст. Эта схема получила название «MIME».

**В основе формата сообщений лежит четкое разграничение между конвертом (envelope) и его наполнением.** 
- **Конверт** содержит в себе сообщение, а также всю информацию, необходимую для его доставки: адрес получателя, приоритет, уровень секретности и т. п. Все эти сведения отделены от самого сообщения. **Агенты передачи сообщений используют конверт для маршрутизации**, аналогично тому, как это делает обычная почтовая служба. 
- **Сообщение** внутри конверта состоит из двух отдельных частей: 
	- заголовка (header) - указана управляющая информация для пользовательских агентов.
	- тела (body) - тело письма целиком предназначается для человека адресата.
![[Pasted image 20250107205212.png]]


## Пользовательский агент

Пользовательский агент — это программа (иногда ее называют «почтовиком» — email reader), выполняющая разнообразные команды для составления и получения сообщений, ответа на них, а также для управления почтовыми ящиками. Существует множество популярных пользовательских агентов, включая Google Gmail, Microsoft Outlook, Mozilla Thunderbird и Apple Mail. 

Пользовательские агенты должны отображать входящие сообщения так, чтобы почту можно было читать. Обычно формат таков:  From (От кого), Subject (Тема) и Received (Получено дата).


## Форматы сообщений

Чтобы сообщения, отсылаемые пользовательским агентом, обрабатывались агентами передачи сообщений, они должны быть оформлены в соответствии с определенными стандартами.
-  Базовый [[Кодировки|ASCII-формат]] электронного письма стандарта RFC 5322. последний вариант оригинального формата интернет-сообщений, описанного в стандарте RFC 822 и его многочисленных обновлениях.
- MIME — многоцелевые расширения интернет-почты


#### RFC 5322 — формат интернет-сообщений

Сообщения состоят из примитивного конверта (в RFC 5321 он описан как
часть SMTP), нескольких полей заголовка, пустой строки и тела сообщения.

Основные поля заголовка, связанные с транспортировкой сообщения.
![[Pasted image 20250107223439.png]]
- **Поле To: (Кому)** 
	содержит адрес электронной почты основного получателя (их может быть несколько). 
- **В поле Cc: (Carbon copy Копия; буквально «под копирку»)** 
	указываются адреса дополнительных получателей. С точки зрения доставки никаких отличий между основным и дополнительными получателями нет. Разница между ними чисто психологическая и важна только для людей, но не для почтовой системы. Обозначение Cc: несколько устарело, ведь компьютеры не используют копировальную бумагу, но термин прижился.
- **Поле Bcc: (Blind carbon copy — Скрытая копия)** 
	аналогично предыдущему, но в этом случае строка поля удаляется из всех экземпляров сообщения, отправленных как основному, так и дополнительным получателям. Это позволяет рассылать письмо одновременно нескольким получателям, и они не будут знать, что это письмо отправлено кому-то еще. 
-  **From: (От) и Sender: (Отправитель)**
	сообщают, соответственно, кто составил и отправил сообщение. Это могут быть разные люди. Например, написать письмо может руководитель предприятия, а отослать — его секретарь. В этом случае в поле From: будет указано имя руководителя, а в поле Sender: — имя секретаря. Поле From: является обязательным, тогда как поле Sender: может быть опущено, если его содержимое не отличается от содержимого поля From:. **Эти поля нужны на случай, если сообщение доставить невозможно и об этом нужно проинформировать отправителя. Кроме того, на адреса, указанные в этих полях, может быть выслан ответ.**
- **Поле Received: (Получено)**
	добавляется каждым агентом передачи сообщений на пути следования письма. В это поле **помещается идентификатор агента, дата и время получения сообщения, а также другая информация, которая может быть использована для исправления неисправностей в системе маршрутизации.** 
- **Поле Return-Path: (Обратный путь)**
	добавляется последним агентом передачи сообщений. Предполагалось, что это поле будет сообщать, как добраться до отправителя. Теоретически эта информация может быть собрана из всех полей Received: (кроме имени почтового ящика отправителя), но на практике оно редко заполняется и обычно просто содержит адрес отправителя.

Помимо данных полей, сообщения стандарта RFC 5322 могут также включать широкий спектр полей заголовка, используемых пользовательским агентом или самим пользователем. Наиболее распространенные поля заголовка:
![[Pasted image 20250107224129.png]]

#### MIME — многоцелевые расширения интернет-почты

На заре существования сети ARPANET электронная почта состояла исключительно из текстовых сообщений на английском языке, представленных символами [[Кодировки#ASCII|ASCII]].

**Многоцелевых расширений интернет-почты (Multipurpose Internet Mail Extensions, MIME)**. Он широко применяется как для сообщений электронной почты, передаваемых по интернету, так и для описания контента в других случаях, например при просмотре сайтов. Изначально MIME описан в RFC 2045, а последующие его версии — в RFC 4288 и 4289.

==Основная идея стандарта MIME сводилась к тому, чтобы продолжить использование формата RFC 822, но при этом придать структуру телу сообщения и определить правила кодирования для пересылки сообщений без ASCII- символов.== Не отклоняясь от стандарта RFC 822, MIME-сообщения могут передаваться с помощью обычных агентов передачи сообщений и протоколов (ранее основанных на RFC 821, а сейчас на RFC 5321).

MIME задает пять новых заголовков сообщений
![[Pasted image 20250107224531.png]]

- **Заголовок ( MIME-Version:)** 
	просто информирует пользовательского агента, что он имеет дело с сообщением MIME, и указывает номер версии MIME. Если в сообщении нет такого заголовка, то оно считается написанным на английском языке (или по крайней мере использующим только ASCII-символы) и обрабатывается со- ответственно

- **Заголовок Content-Description: (Описание содержимого)** 
	представляет собой ASCII-строку, информирующую о том, что находится в сообщении. Он позволяет пользователю принять решение о том, нужно ли ему декодировать и читать сообщение. Если в строке сказано: «Фото хомяка Арона», а получатель не любит хомяков, скорее всего, он сразу удалит это сообщение и не станет перекодировать его в цветную фотографию высокого разрешения.

- **Заголовок Content-Id: (Идентификатор содержимого)** 
	идентифицирует данные в сообщении. В нем используется тот же формат, что и в стандартном заголовке Message-Id:.

- **В заголовке Content-Transfer-Encoding: (Кодировка содержимого для передачи)**
	предоставляет пять схем кодирования для передачи данных. Самая простая:
	- 7-битный (7bit):  Обычные текстовые сообщения ASCII. 
		Символы ASCII используют 7 бит и могут передаваться напрямую протоколом электронной почты, при условии, что строка не превышает 1000 символов.
	- 8-битный (8bit) Схема аналогична предыдущей, но использует 8-битные символы
		Все значения байта от 0 до 255 включительно. Сообщения в 8-битной кодировке также должны соблюдать правило о максимальной длине строки.
	- **[[Кодировки#BASE64|Base64]]:  Кодировка бинарных данных в формате ASCII называется 64-символьной кодировкой (|base64 encoding)**
		При использовании данного метода группы по 24 бита разбиваются на четыре единицы по 6 бит, каждая из которых передается в виде обычного разрешенного ASCII-символа. В этой кодировке 6-битный символ 0 кодируется ASCII-символом A, 1 — ASCII-символом B и т. д. Затем следуют 26 строчных букв, затем 10 цифр и, наконец, + для кодирования 62 и / для 63. Последовательности == и = говорят о том, что последняя группа содержит только 8 или 16 бит соответственно. Символы перевода строки и возврата каретки игнорируются, поэтому их можно вставлять в любом месте закодированного потока символов, чтобы строки были достаточно короткими. 
	- Quoted-printable (Q): 
		Эта схема кодирования предназначена для передачи текстовых данных, которые могут содержать символы, не поддерживаемые в 7-битной кодировке. Она позволяет передавать текст, используя ASCII для большинства символов, но заменяет не ASCII-символы на их шестнадцатеричные представления, предваряемые знаком =. Например, символ é может быть представлен как =C3=A9. Эта кодировка особенно полезна для сообщений, содержащих много читаемого текста с небольшим количеством специальных символов.
	- Binary (B): 
		Схема позволяет передавать данные в двоичном формате без каких-либо преобразований. Однако многие почтовые серверы могут не поддерживать эту кодировку, так как она может содержать недопустимые символы или нарушать правила передачи. Поэтому использование этой схемы часто ограничено.
- **Сontent-Type: (Тип содержания)**
	В нем указан тип тела сообщения. Применение этого заголовка выходит далеко за пределы электронной почты. Например, контент, загружаемый из интернета, получает метку MIME-типа, что позволяет браузеру корректно отображать информацию. Так же обстоит дело с данными, которые передаются через потоковое мультимедиа и в реальном времени (например, в IP-телефонии).

Изначально в RFC 1521 **были определены** семь **MIME-типов.** У каждого из них есть один или несколько доступных подтипов. Подтип отделяется от типа косой чертой, например: Content-Type: video/mpeg. Впоследствии было добавлено более 2700 подтипов, а также два новых типа (font и model). Новые сущности добавляются постоянно, по мере появления новых типов контента. Список утвержденных типов и подтипов поддерживается организацией IANA и расположен по адресу www.iana.org/assignments/media-types.
![[Pasted image 20250107230911.png]]

## Пересылка сообщений SMTP

==Агенты передачи сообщений доставляют сообщения от отправителя получателю. С помощью протокола SMTP.==

#### Два основных способа применения SMTP:

##### 1. Подача почтового сообщения (Step 1)

Этот способ включает в себя передачу почтового сообщения от пользовательского агента (например, почтового клиента) в почтовую систему для дальнейшей обработки и отправки. Основные характеристики этого метода:

• Участники: 

  • Отправитель: Пользовательский агент (почтовый клиент).

  • Почтовый сервер: Сервер, который принимает и обрабатывает сообщения.

• Процесс:

  • Пользователь создает сообщение в почтовом клиенте.

  • Клиент устанавливает соединение с SMTP-сервером.

  • Сообщение передается на сервер с использованием команды SMTP (например, MAIL FROM, RCPT TO, DATA).

  • Сервер принимает сообщение и помещает его в очередь для дальнейшей доставки.

• Примечания:

  • В этом случае SMTP работает как протокол "от клиента к серверу".

  • Данный способ используется для отправки электронной почты пользователями.

##### 2. Пересылка сообщений между агентами передачи сообщений (Step 2)

Этот способ включает пересылку сообщений между различными почтовыми серверами, обеспечивая доставку от отправляющего сервера к получающему. Основные характеристики этого метода:

• Участники:

  • Отправляющий почтовый сервер: Сервер, который отправляет сообщение.

  • Получающий почтовый сервер: Сервер, который принимает сообщение.

• Процесс:

  • После того как сообщение было получено отправляющим сервером, он использует SMTP для пересылки сообщения на следующий сервер в цепочке до получения конечного адресата.

  • Серверы могут взаимодействовать друг с другом, используя команды SMTP для передачи сообщений.

  • Этот процесс может включать несколько промежуточных серверов до достижения конечного получателя.

• Примечания:

  • В данном случае SMTP работает как протокол "от сервера к серверу".

  • Этот способ обеспечивает маршрутизацию и доставку почты через интернет.


#### SMTP и его расширения

В интернете для доставки электронной почты компьютер-источник устанавливает TCP-соединение **с портом 25** компьютера-получателя. Этот порт прослушивается почтовым сервером, который **поддерживает простой протокол передачи электронной почты (Simple Mail Transfer Protocol, SMTP).** Сервер проверяет безопасность входящих соединений, утверждает их и принимает сообщения для передачи. Если письмо невозможно доставить, отправителю возвращается отчет об ошибке, в котором содержится первая часть этого письма.


###### 1. Установка соединения

- TCP-соединение: Клиент устанавливает соединение с сервером на порту 25.

- Идентификация сервера: Сервер отвечает текстовой строкой с идентификатором и информацией о готовности к приему почты. Если сервер не готов, клиент разрывает соединение и повторяет попытку позже.

###### 2. Передача сообщений

- Команда HELO/EHLO: Клиент отправляет приветствие серверу с помощью команды HELO (или EHLO для расширенного SMTP).

- Команда MAIL FROM: Клиент указывает адрес отправителя.

- Команда RCPT TO: Клиент указывает адрес получателя. Эта команда может быть использована несколько раз для отправки одного сообщения нескольким получателям.

- Передача сообщения: Клиент отправляет само сообщение. Сервер подтверждает его получение. 

###### 3. Завершение соединения

- После передачи всех сообщений соединение разрывается.

Пример диалога SMTP
```
C: HELO example.com
S: 250 Hello example.com
C: MAIL FROM:<sender@example.com>
S: 250 OK
C: RCPT TO:<recipient@example.com>
S: 250 OK
C: DATA
S: 354 Start mail input; end with <CRLF>.<CRLF>
C: Subject: Test message
C: This is a test message.
C: .
S: 250 OK
C: QUIT
S: 221 Bye

```

###### Ограничения SMTP

1. Отсутствие аутентификации: Протокол не требует аутентификации отправителя, что делает его уязвимым для спама и подделки адресов.

2. Ограничение на кодировку: SMTP поддерживает только ASCII, что требует использования кодировок, таких как base64, для передачи бинарных данных. Это может привести к неэффективному использованию пропускной способности.

3. Отсутствие шифрования: Сообщения передаются в незашифрованном виде, что делает их уязвимыми для перехвата.

###### ==Расширенный SMTP (ESMTP)==

Чтобы решить проблемы базового SMTP, были разработаны расширения, которые стали частью стандарта RFC 5321. При использовании ESMTP клиент сначала отправляет команду EHLO.

Основные расширения ESMTP:

| Ключевое слово | Описание                                     |
| -------------- | -------------------------------------------- |
| AUTH           | Аутентификация клиента                       |
| BINARYMIME     | Сервер принимает бинарные сообщения          |
| CHUNKING       | Сервер принимает большие сообщения по частям |
| SIZE           | Проверка размера сообщения перед отправкой   |
| STARTTLS       | Переключение на безопасный канал (TLS)       |
| UTF8SMTP       | Интернационализированный адрес               |

#### Подача почтовых сообщений

   • Пользовательские агенты (например, почтовые клиенты) обычно работают на устройствах с переменным доступом к интернету (ноутбуки, мобильные телефоны).

   • Агенты передачи сообщений функционируют на серверах провайдеров с постоянным доступом к интернету.

   • Для отправки сообщений с удаленных устройств используется протокол SMTP с расширением AUTH для аутентификации пользователей (имя и пароль). Оно позволяет серверу проверять данные отправителя (имя пользователя и пароль) для подтверждения того, что сервер должен предоставить почтовое обслуживание.

   • Может использоваться порт 587 вместо порта 25, а сервер  может проверять и исправлять формат сообщений, отправленных пользовательским агентом. Больше информации в стандарте RFC 4409.

#### Физическая передача

   • При отправке сообщения используется адрес получателя, и отправляющий агент обращается к системе DNS для нахождения почтового сервера через [[Служба имён доменов DNS#Ответы|записи MX]].

   • Установив TCP-соединение с почтовым сервером, отправляющий агент использует SMTP для передачи сообщения.

   • Получающий агент помещает сообщение в почтовый ящик получателя, и процесс может включать перемещение между серверами.

   • Возможны случаи пересылки и перенаправления почты, когда сообщения могут быть отправлены на несколько адресов или перенаправлены на другой адрес.


## Окончательная доставка

#### Проблемы окончательной доставки

Когда пользовательский агент и агент передачи почты находятся на одном компьютере, процесс передачи сообщения осуществляется без затруднений. Однако пользователи стремятся иметь доступ к своей почте независимо от места нахождения: с рабочего или домашнего компьютера, с ноутбука в командировках или из интернет-кафе. В связи с этим возникают следующие нюансы:

• Удаленное хранение: Веб-почтовые сервисы обычно хранят почтовые ящики на своих серверах, а не на устройствах пользователей. Это позволяет получать доступ к своей почте из любого места и с любого устройства.

• Отсутствие постоянного соединения: Пользовательский агент может не быть подключен к интернету в момент, когда SMTP пытается передать сообщение, что создает проблемы с окончательной доставкой.

#### Протокол IMAP

Протокол доступа к электронной почте (Internet Mail Access Protocol, IMAP ). 
	Четвертая версия этого протокола определена в спецификации RFC 3501 и ее многочисленных обновлениях.
 Чтобы использовать IMAP, почтовый сервер запускает IMAP-сервер, который проверяет порт 143. Пользовательский агент запускает IMAP-клиент. Этот клиент соединяется с сервером и начинает пере- давать команды из списка
![[Pasted image 20250108001338.png]]

• Функции IMAP:

  • Позволяет пользователям получать доступ к своим почтовым ящикам на удаленном сервере.

  • Синхронизирует изменения между сервером и клиентом (например, прочитанные сообщения, папки и т.д.).

  • Поддерживает работу с несколькими устройствами, что позволяет пользователям видеть одинаковый статус почты независимо от того, с какого устройства они подключаются.

IMAP обеспечивает более гибкий и удобный способ работы с электронной почтой по сравнению с POP3 (Post Office Protocol), который загружает сообщения на устройство пользователя и удаляет их с сервера.

Кроме того, могут использоваться и частные протоколы, так как протокол работает между почтовым сервером и пользовательским агентом, который может разрабатываться одной компанией — производителем софта. Примером почтовой системы с частным протоколом является Microsoft Exchange.

#### Веб-почта

Популярной альтернативой IMAP и SMTP в деле предоставления почтовых услуг стало использование веб-интерфейса для отправки и получения сообщений. Широко применяются такие системы веб-почты (Webmail)

Веб-почта — это форма доступа к электронной почте через веб-браузер. Она представляет собой удобный способ работы с электронной почтой без необходимости установки специального программного обеспечения на устройство пользователя.

В такой системе **провайдер управляет почтовыми серверами как обычно, чтобы принимать сообщения для пользователей при помощи SMTP через порт 25**. Однако **пользовательский агент работает по-другому. Он является не отдельной программой, а пользовательским интерфейсом, который предоставляется через веб-страницы**. То есть пользователи могут использовать любой понравившийся им браузер для доступа к своей почте и отправки новых сообщений. Когда пользователь заходит на страницу Gmail, он видит форму, где нужно ввести учетное имя и пароль. Пароль и учетное имя отправляются на сервер для их подтверждения. Если вход в систему осуществлен корректно, сервер находит почтовый ящик пользователя и строит веб-страницу, на которой отображается содержимое ящика. Эта веб-страница отсылается на браузер клиента.

• Примеры веб-почты: Gmail, Yahoo Mail, Outlook.com.
