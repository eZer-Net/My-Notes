
Методы, представленные в предыдущих разделах, направлены на устранение перегрузок и повышение производительности сети. Однако **некоторым приложениям (и клиентам) нужны более строгие гарантии качества, чем просто обязательство предоставить «лучшее из возможного в данных обстоятельствах» (иногда это называется подходом best effort).** Кроме того, многие приложения требуют определенной минимальной пропускной способности и плохо функционируют, если задержка превышает некоторое пороговое значение.
В последнее время важную роль приобретает **QoE (Quality of Experience — качество пользовательского опыта)**, поскольку в конечном итоге важен лишь полученный пользователем опыт взаимодействия, а у разных приложений пороговые значения и требования к производительности сети могут сильно различаться.

## Требования приложений к QoS
Последовательность пакетов, передающихся от источника к получателю, называется потоком (flow). При этом в сетях, ориентированных на установление соединения, его могут составлять все пакеты канала, а в сетях без установления соединения — все пакеты, отправленные от одного процесса к другому. 
**Каждый поток требует определенных условий, которые можно охарактеризовать четырьмя основными параметрами: пропускная способность, задержка, джиттер, потери.** 
Все вместе они формируют необходимый потоку **QoS (Quality of Service — качество обслуживания).**

Таблица приложений и их требования к сети:

| Приложение<br>    | Пропускная способность | Задержка | Джиттер | Потери  |
| ----------------- | ---------------------- | -------- | ------- | ------- |
| Электронная почта | Низкая                 | Низкая   | Низкая  | Средняя |
| Передача файлов   | Высокая                | Низкая   | Низкая  | Средняя |
| Веб-доступ        | Средняя                | Средняя  | Низкая  | Средняя |
| Удаленный доступ  | Низкая                 | Средняя  | Средняя | Средняя |
| Аудио по запросу  | Низкая                 | Низкая   | Высокая | Низкая  |
| Видео по запросу  | Высокая                | Низкая   | Высокая | Низкая  |
| Телефония         | Низкая                 | Высокая  | Высокая | Низкая  |
| Видеоконференции  | Высокая                | Высокая  | Высокая | Низкая  |
Приложения передачи файлов, включая электронную почту и видео, нечувствительны к задержкам. Даже если все пакеты будут доставляться с задержкой в несколько секунд, ничего страшного не произойдет. 
Интерактивные приложения — например, веб-поиска или удаленного доступа — более критичны к задержкам.
Что касается приложений, работающих в реальном времени, их требования очень строги. 

**Джиттер(jitter)**
Колебание (то есть стандартное отклонение) времени задержки или времени прибытия пакета

Видео- и особенно аудиоданные крайне чувствительны к джиттеру. Если пользователь смотрит видео по сети и все фреймы приходят с задержкой ровно 2,000 с, проблем не возникнет. Но если время передачи колеблется от 1 до 2 с и приложению не удается скрыть джиттер, результат будет просто ужасен. При прослушивании звукозаписей заметен джиттер даже в несколько миллисекунд.

Чтобы удовлетворить требования различных приложений, сеть может предлагать разные категории QoS. Яркий пример — сети ATM, которые когда-то считались перспективными, но впоследствии стали нишевой технологией. Они поддерживают:
1. Постоянную битовую скорость (например, телефония).
2. Переменную битовую скорость в реальном времени (например, передача
   сжатых видеоданных во время видеоконференций).
3. Переменную битовую скорость не в реальном времени (например, просмотр
   фильмов по запросу).
4. Доступную битовую скорость (например, передача файлов).

Каждая категория QoS имеет свои особенности: 
- Постоянная битовая скорость обеспечивает фиксированную пропускную способность и равномерную задержку.
- Переменная битовая скорость может изменяться в зависимости от содержимого (например, сжатие видео).
- Фильмы по запросу буферизуются, что позволяет минимизировать влияние джиттера.
- Доступная битовая скорость подходит для приложений, нечувствительных к задержкам и джиттеру.

## Избыточное обеспечение

Существует простой способ предоставления QoS высокого уровня — **создание сети с пропускной способностью, позволяющей передавать любой трафик**. Этот метод называется избыточным обеспечением (overprovisioning).
Пример телефонная сеть является системой с избыточным обеспечением. Ситуация, когда абонент поднимает трубку и не слышит гудка, маловероятна. Дело в том, что в систему заложена настолько большая пропускная способность, что превысить ее тяжело. **Единственная проблема — такой способ обходится очень дорого**. Конечно, ее можно решить путем крупных финансовых вливаний.

## Избыточное обеспечение альтернативный механизм QoS

**С помощью QoS сеть может выполнить свои обязательства даже при резком увеличении объема трафика за счет отклонения некоторых запросов.** Чтобы обеспечить QoS, необходимо ответить на следующие вопросы.

- Что приложениям нужно от сети?

- Как регулировать трафик, поступающий в сеть?

- Как зарезервировать ресурсы на маршрутизаторах, необходимые для обеспечения производительности?

- Может ли сеть принять больший объем трафика?

**Нет единого решения для всех этих вопросов**, поэтому разработаны различные методы на сетевом и транспортном уровнях. В практике часто используется комбинация этих методов. Рассмотрим два варианта QoS для интернета: комплексное и дифференцированное обслуживание.

## Планирование пакетов

Возможность регулировать форму предлагаемого трафика — это хорошее начало. Но чтобы предоставлять клиенту гарантии производительности, необходимо резервировать достаточное количество ресурсов. Будем считать, что все пакеты в потоке следуют по одному и тому же пути. **При случайном распределении пакетов между маршрутизаторами сложно что-либо гарантировать. Следовательно, между источником и получателем должно быть установлено нечто вроде виртуального канала**, и все пакеты данного потока должны следовать по указанному маршруту.

**Механизмы, распределяющие ресурсы маршрутизаторов между пакетами одного потока или между конкурирующими потоками, называются алгоритмами планирования пакетов (packet scheduling algorithm)**. 
###### Для разных потоков могут резервироваться три типа ресурсов:

- Пропускная способность.

- Буферное пространство.

- Время центрального процессора (CPU).

**Резервирование пропускной способности** предотвращает перегрузку канала, обеспечивая, что не более определенного числа потоков может использовать канал одновременно.

**Резервирование части буферной памяти** для конкретного потока позволяет избежать конкуренции за пространство и гарантирует доступность ресурсов.

В**ремя CPU используется для обработки пакетов**. Перегрузка процессора может замедлить обработку. Современные маршрутизаторы обычно быстро обрабатывают пакеты, но **некоторые типы, такие как ICMP, могут требовать больше времени**.

**Обеспечение достаточной пропускной способности, буферного пространства и времени CPU критично для поддержания высокого уровня QoS.**
Позволяет избежать задержек и потерь данных, что особенно важно для приложений с высокими требованиями к качеству связи.


#### Планирование пакетов по принципу FIFO
Алгоритмы планирования пакетов распределяют пропускную способность
и другие ресурсы маршрутизатора, решая, какой пакет из буфера отправить
по исходящей линии следующим. 

**Каждый маршрутизатор помещает пакеты в очередь** (отдельную для каждой исходящей линии), где они ждут отправки. Дальнейшая передача пакетов происходит в том же порядке, в каком они пришли. **Этот принцип называется FIFO (First-In First-Out, первым пришел — первым ушел) или FCFS (First-Come First-Serve, первым пришел — первым обслуживается).**
Маршрутизаторы, работающие по принципу FIFO, при переполнении очереди обычно удаляют пакеты, которые пришли последними. Новые пакеты помещаются в конец очереди, поэтому такой принцип работы называется «обрубанием хвоста» (tail drop).


#### Справедливое обслуживание
Планирование по принципу FIFO легко реализовать, но оно не обеспечивает
высокий уровень QoS: если потоков несколько, один из них может влиять на
производительность других. `Если поток ведет себя агрессивно и отправляет большие объемы трафика, его пакеты попадают в очередь.`
**При обработке в порядке поступления этот отправитель захватывает большую часть мощности маршрутизаторов, отбирая ее у других потоков и тем самым уменьшая их уровень QoS.** 

Чтобы обеспечить изоляцию потоков и предотвратить их конфликты, было разработано множество различных алгоритмов планирования пакетов. **Одним из первых был алгоритм равноправных очередей (fair queueing) (Нейгл; Nagle, 1987).**
**Маршрутизаторы организуют отдельные очереди для каждой исходящей линии, по одной для каждого потока.** Как только линия освобождается, маршрутизатор циклически сканирует очереди и выбирает первый пакет следующей очереди. **Таким образом, если за данную исходящую линию конкурируют n хостов, то**
**каждый из них отправляет один пакет из каждых n пакетов**. Получается, что все потоки передают пакеты с одинаковой скоростью и агрессивному хосту не поможет отправка большего числа пакетов
###### Алгоритм равноправных очередей
![[Pasted image 20241224165031.png]]

**Однако у этого метода есть один недостаток. Предоставляемая им пропускная способность напрямую зависит от размера пакетов, отправляемых хостом: чем они крупнее, тем больше ресурса ему выделяется.** 
В книге Демерса и др. (Demers et al., 1990) предлагается улучшенная версия алгоритма, в которой циклический опрос производится с целью выхватывания байта, а не пакета. 

Идея заключается в вычислении виртуального времени, то есть номера цикла, на котором отправка пакета завершится. Каждый цикл выхватывает один байт из всех очередей, содержащих пакеты для передачи. Затем пакеты сортируются согласно времени завершения отправки и передаются в этой последовательности.

###### Алгоритм FQ и примеры значений времени окончания отправки пакетов для трех потоков:
![[Pasted image 20241224165241.png]]

Если длина пакета равна L, его отправка завершится через L циклов. Передача пакета начинается либо сразу после отправки предыдущего, либо в момент прибытия этого пакета, если очередь пуста.

Таблица на илл. (б) показывает, что первые два пакета в двух верхних очередях прибывают в порядке A, B, D, F. Пакет A приходит на нулевом цикле, а его длина равна 8 байт, поэтому отправка завершается на 8-м цикле. Точно так же отправка пакета B завершается на цикле 11. Пакет D прибывает в момент отправки B. Его передача заканчивается через 9 циклов после окончания отправки B; время равно 20. Аналогичным образом время завершения отправки F равно 16. Если новых пакетов нет, порядок окончания отправки пакетов будет таким: A, B, F, D (хотя F прибывает после D). Может случиться так, что в верхний поток поступит небольшой пакет, который будет передан раньше D. Но он обойдет D только в том случае, если отправка D еще не началась.

#### Взвешенные равноправные очереди

Проблема алгоритма FQ справедливо обслуживание в том, что он дает всем хостам одинаковые приоритеты. Как правило, видеосерверам лучше предоставлять большую пропускную способность, чем обычным файл-серверам, чтобы они могли передавать два или несколько байтов за цикл. Такая **модификация алгоритма называется взвешенными равноправными очередями (Weighted Fair Queueing, WFQ), которая определяет приоритет пакетам**.

**WFQ помещает пакеты в очередь, сортируя их по времени окончания отправки. Для N потоков это требует по меньшей мере O(log N) операций для каждого пакета, а это трудновыполнимо при большом количестве потоков на высокоскоростных маршрутизаторах.**  Упрощенная схема **дефицитного циклического обслуживания (Deficit Round Robin, DRR) работает гораздо эффективнее**: всего за O(1) операций для каждого пакета (Шридхар и Варгезе; Shreedhar and Varghese, 1995). **Она широко применяется для алгоритма WFQ.**

Существуют другие алгоритмы планирования пакетов, например приоритетный, при котором пакеты обладают каким-либо приоритетом. Высокоприоритетные пакеты передаются раньше, чем низкоприоритетные; последние помещаются в буфер. Пакеты с одинаковым приоритетом отправляются по принципу FIFO. **Важным недостатком этого алгоритма является то, что высокоприоритетные пакеты препятствуют отправке низкоприоритетных, которые могут ждать своей очереди бесконечно долго.** С этой точки зрения более удачным вариантом является FQ. 

**Существует алгоритм планирования, при котором у каждого пакета есть временной штамп, определяющий порядок отправки**. В реализации, которую предложили Кларк и др. (Clark et al., 1992), **временной штамп регистрирует информацию о том, насколько пакет, проходя через маршрутизаторы сети, отстает от графика или опережает его.** Как правило, пакеты, ожидающие отправки, отстают, а передаваемые в первую очередь — опережают график. Использование временных штампов — эффективный способ ускорить отправку медленных пакетов и замедлить передачу быстрых. **При таком подходе все пакеты доставляются с приблизительно равной задержкой, что является очевидным преимуществом.**

#### Собираем все воедино

Гарантии QoS предоставляются через управление допуском.
Когда пользователь передает поток данных в сеть, он ожидает, что определенные требования к качеству обслуживания (QoS) будут соблюдены. Сеть, в свою очередь, должна решить, сможет ли она принять этот поток, учитывая свои возможности и обязательства перед другими клиентами. Если поток принимается, необходимо заранее зарезервировать ресурсы на всех маршрутизаторах вдоль пути передачи, чтобы гарантировать требуемый уровень QoS.
	Если ресурсы не резервируются, это может привести к проблемам, и гарантии качества обслуживания не будут выполнены. Хотя многие маршруты выбираются оптимальным образом, некоторые потоки могут быть отклонены из-за нехватки ресурсов. В таких случаях сеть может прибегнуть к так называемой **QoS-маршрутизации**, выбирая альтернативный путь для передачи потока данных, чтобы обеспечить соблюдение требований к качеству обслуживания.

**Приложения различаются по своей толерантности к пропущенным срокам обработки,**
и для них выбираются разные типы гарантий качества обслуживания (QoS) — от строгих до более лояльных. Строгие гарантии могут быть затратными и ограничивают поведение сети в наихудшем случае. Однако для большинства приложений достаточно менее строгих гарантий, что позволяет добавлять дополнительные потоки при фиксированной емкости.

Некоторые приложения могут адаптироваться к изменяющимся условиям. Например, видеоплеер может снизить частоту кадров, если возникают проблемы с пропускной способностью. Это дает возможность гибко управлять параметрами потоков.

**Каждый поток описывается через спецификацию, согласованную между отправителем, получателем и маршрутизаторами. Эта спецификация включает важные параметры, которые могут быть изменены только в сторону уменьшения**, такие как скорость маркерного ведра и размер маркерного ведра. Эти **параметры помогают определить максимальную скорость передачи и объем данных, что критично для обеспечения необходимого уровня качества обслуживания.** В качестве содержимого спецификации потока изображение которое иллюстрирует 
##### Стандарты RFC 2210 и RFC 2211 для комплексного обслуживания — технологии QoS.
![[Pasted image 20241224171722.png]]
В спецификации содержится пять параметров. 

**Первые два**, скорость маркерного ведра и размер маркерного ведра, **позволяют вычислить максимальную скорость, которую источник может поддерживать в течение долгого времени**, усредненную по большому временному отрезку, а также максимальный объем пачки, передаваемой за короткий промежуток времени.

**Третий параметр, пиковая скорость передачи данных**, — **это максимальная допустимая скорость** (даже для коротких временных интервалов). Отправитель ни в коем случае не должен превышать это значение.

**Последние два параметра определяют минимальный и максимальный размеры пакетов**, включая заголовки транспортного и сетевого уровней (например, TCP и IP).

## Комплексное обслуживание
Комплексное обслуживание (integrated services). Эта технология предназначена как для одноадресных, так и для многоадресных приложений.
В одноадресных случаях это может быть просмотр потокового видео на новостном сайте одним пользователем; 
В многоадресных набор станций цифрового телевидения, транслирующих свои программы в виде потоков IP-пакетов. Данной услугой может пользоваться большое число абонентов в разных географических точках.

Метод предварительного резервирования пропускной способности не подходит для многопользовательских приложений с многоадресной маршрутизацией, так как участники могут динамически изменяться, что требует от источников запоминания всех изменений состава аудитории. В системах, передающих сигнал миллионам абонентов, такая стратегия вообще неэффективна.

#### RSVP — протокол резервирования ресурсов
Протокол резервирования ресурсов (Resource reSerVation Protocol, RSVP), он описывается в стандартах RFC 2205–RFC 2210.

Протокол предназначен для резервирования ресурсов; другие протоколы применяются для описания передачи данных. **RSVP позволяет нескольким отправителям отправлять данные нескольким группам абонентов, разрешает отдельным получателям переключать каналы и оптимизирует использование пропускной способности, в то же время устраняя перегрузки.**

Самый простой вариант этого протокола использует упомянутую ранее многоадресную маршрутизацию с применением связующих деревьев. Каждая группа получает адрес. Чтобы передать ей данные, отправитель помещает этот адрес в заголовки пакетов. Затем стандартный алгоритм многоадресной маршрутизации строит связующее дерево, охватывающее всех членов группы. Этот алгоритм не является частью протокола RSVP. Единственное отличие от обычной многоадресной маршрутизации состоит в том, что группе периодически рассылается дополнительная информация, с помощью которой маршрутизаторы обновляют в памяти определенные структуры данных.

###### Пример сети:
Хосты 1 и 2 — многоадресные отправители,
а хосты 3, 4 и 5 — многоадресные получатели
![[Pasted image 20241224173614.png]]
Для улучшения качества приема и устранения перегрузки каждый получатель в группе может отправить источнику (вверх по дереву) запрос на резервирование, 
это сообщение продвигается с использованием переадресации в обратном направлении, а на каждом транзитном участке маршрутизатор замечает запрос и резервирует необходимую пропускную способность.

###### Пример резервирования показан:
![[Pasted image 20241224173942.png]]
Хост 3 запросил канал к хосту 1. После создания канала поток пакетов от хоста 1 к хосту 3 может идти без перегрузок илл (а). 

Что произойдет, если теперь хост 3 зарезервирует канал к другому отправителю, хосту 2, чтобы пользователь мог одновременно смотреть две телевизионные программы. Резервирование второго канала показано на илл (б). 
**внимание: между хостом 3 и маршрутизатором E должно быть два отдельных канала, так как передаются два независимых потока.**

На илл. (в) хост 5 решает посмотреть программу, передаваемую хостом 1, и также резервирует себе канал. Сначала требуемая пропускная способность резервируется до маршрутизатора H. Затем он замечает, что у него уже есть канал от хоста 1, поэтому дополнительное резервирование выше по дереву не требуется. 

**При подаче запроса получатель может (по желанию) указать один или несколько источников, от которых он хотел бы получать сигнал.** Он также может сообщить, является ли выбор источников фиксированным в течение времени резервирования или он оставляет за собой право сменить их. Эти сведения используются маршрутизаторами для оптимизации планирования пропускной способности.


## Дифференцированное обслуживание

**Потоковые алгоритмы способны обеспечивать хороший уровень QoS одного или нескольких потоков за счет резервирования любых необходимых ресурсов на протяжении всего маршрута.** Однако есть у них и недостаток. **Они требуют предварительной настройки при установке каждого потока, что не подходит для**
**систем с тысячами или миллионами потоков.** 
Кроме того, **потоковые алгоритмы используют внутреннюю информацию о потоках, которая хранится в маршрутизаторах. Это делает их уязвимыми к выходу маршрутизаторов из строя**. Наконец, о**ни требуют значительных программных изменений в маршрутизаторах, связанных со сложными процессами обмена между ними при установке потоков.** В результате с развитием комплексного обслуживания подобные алгоритмы используются крайне редко.

По этим причинам **IETF разработал упрощенный подход к QoS.** Его можно реализовать локально в каждом маршрутизаторе без предварительной настройки и без участия остальных устройств маршрута. 
Известен как основанное на классах (в отличие от основанного на потоках) QoS. **IETF стандартизировал специальную архитектуру под названием дифференцированное обслуживание (differentiated services)** и описал в документах **RFC 2474, RFC 2475** и во многих других.

**Дифференцированное обслуживание может предоставляться набором маршрутизаторов, которые образуют административный домен (например, интернет-провайдер или телефонную компанию)**. Администрация определяет набор классов обслуживания и соответствующие правила маршрутизации. **Пакеты от абонента, пользующегося дифференцированным обслуживанием, получают метку с информацией о классе. Эти сведения записываются в поле Differentiated services пакетов IPv4 и IPv6**

**Классы определяются как поведение при переходах (per hop behaviors), так как они отвечают за то, что будет происходить с пакетом на маршрутизаторе, а не во всей сети.** Таким пакетам предоставляется **улучшенное обслуживание (например, премиум-обслуживание) по сравнению с остальными пакетами (обычное обслуживание)**. Может потребоваться, чтобы трафик внутри класса соответствовал определенной форме (например, дырявому ведру с заданной скоростью «вытекания» данных). Оператор с хорошим бизнес-чутьем может брать дополнительную плату за передачу каждого премиум-пакета либо установить абонентскую плату за передачу N таких пакетов в месяц.

#### Беспрепятственная пересылка

Выбор класса обслуживания зависит от оператора, но поскольку пакеты зачастую необходимо пересылать между сетями разных операторов, IETF установил классы, не зависящие от сети. **Простейший из них — класс беспрепятственной пересылки (expedited forwarding), описанный в стандарте RFC 3246.**
Идея, на которой основана беспрепятственная пересылка, очень проста. **Существует два класса обслуживания: обычный и ускоренный.** Ожидается, что подавляющая часть трафика будет использовать обычный класс. Но есть ограниченная доля пакетов, которые необходимо передавать в ускоренном режиме. Их нужно пересылать так, будто кроме них в сети больше нет никаких пакетов. Тогда они получат обслуживание с низкими потерями, низкой задержкой и низким джиттером — как раз то, что нужно для IP-телефонии. **Графическое представление такой двухканальной системы:**
![[Pasted image 20241225093406.png]]
Данную стратегию можно реализовать следующим образом. **Пакеты разделяются на обычные и ускоренные, после чего они получают соответствующие отметки. Это может выполнять хост-источник или входной (первый) маршрутизатор.** Преимущество первого варианта в том, что источник располагает большей информацией о распределении пакетов по потокам. Классификация пакетов может производиться сетевым ПО или операционной системой, что позволяет избежать изменений в существующих приложениях. **В сети маршрутизаторы могут использовать две очереди для каждой исходящей линии — для обычных и для ускоренных пакетов.**

#### Гарантированная пересылка

**Более совершенная схема управления классами обслуживания — гарантированная пересылка (assured forwarding), описанная в документе RFC 2597.**
Она подразумевает наличие четырех классов приоритетов, каждый из которых обладает своими ресурсами. Кроме того, определены три класса игнорирования пакетов при перегрузке (низкий, средний и высокий). В итоге получается 12 сочетаний, то есть 12 классов обслуживания.
На илл. показан один из способов обработки пакетов при гарантированной пересылке.
![[Pasted image 20241225093853.png]]
**На первом этапе пакеты разбиваются на четыре класса приоритетов.** Эта процедура также может выполняться как на хосте-источнике (как на рисунке), так и на первом маршрутизаторе. Скорость высокоприоритетных пакетов может быть ограничена оператором в рамках соглашения о предоставлении услуг.
**Следующий шаг — определение классов игнорирования пакетов.** Для этого пакеты каждого класса приоритетов проходят проверку с помощью маркерного ведра или похожей схемы. Небольшим пакетам присваивается низкий класс игнорирования, средним — средний класс, а большим — высокий. Информация о классах приоритетов и игнорирования кодируется в каждом пакете.
Наконец, **пакеты проходят обработку на маршрутизаторах сети, где планировщик определяет их классы**. Чаще всего **для четырех классов приоритетов используется WFQ: чем выше класс, тем выше вес.** В результате высокоприоритетные пакеты получают большую часть пропускной способности, при этом передача низкоприоритетных пакетов не останавливается.
В пределах одного класса приоритетов пакеты с высоким классом игнорирования можно удалять в первую очередь, например, **с помощью алгоритма RED**. Он начнет исключать пакеты еще до того, как в буфере маршрутизатора закончится место. **Пакеты с низким классом игнорирования все еще будут приниматься, а с высоким — отвергаться.**


