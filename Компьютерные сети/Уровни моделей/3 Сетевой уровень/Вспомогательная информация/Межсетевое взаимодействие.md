
Существует множество различных сетей, включая PAN, LAN, MAN и WAN. Уже рассмотрели сети Ethernet, кабельном интернете, стационарных и мобильных телефонных сетях, сетях стандарта 802.11 и т. д. На каждом уровне этих сетей широко применяются многочисленные протоколы.

## Интерсети (internet): общие сведения

В следующих разделах особое внимание будет уделено вопросам, возникающим
при объединении двух или более сетей, формирующих объединенную сеть
(internetwork), или, проще, интерсеть (internet).
**Если бы все использовали одну сетевую технологию, объединять сети было бы намного проще. В большинстве случаев существует доминирующая сеть (например, Ethernet).**
**Различные сети решают разные задачи, поэтому, к примеру, Ethernet и спутниковые сети всегда будут отличаться. Создание сетей передачи данных на основе уже существующих систем (кабельной, телефонной или ЛЭП) порождает дополнительные ограничения, которые приводят к расхождению их характеристик.** 

Боб Меткалф выдвинул такой принцип: **ценность сети, состоящей из N узлов, пропорциональна числу соединений между узлами, или N2.**

## Различия сетей и проблемы объединения

На илл. перечислены некоторые различия, которые проявляются на сетевом уровне.
![[Pasted image 20241225101750.png]]
Если пакеты должны пройти через одну или несколько сетей, прежде чем достичь сети назначения, может возникнуть множество проблем на интерфейсах между ними.

**Во-первых, источник должен иметь возможность адресовать пакет получателю. Что делать, если отправитель находится в сети Ethernet, а получатель — в мобильной телефонной сети?** Даже если удастся задать адрес назначения, **пакеты еще нужно как-то переправить из сети, не требующей соединения, в сеть, ориентированную на установление соединения**. Это может потребовать создания нового соединения в кратчайшие сроки, что приведет к задержке и неэффективному использованию ресурсов, так как этот канал не будет активно использоваться. К примеру, как передать пакет группе, некоторые участники которой находятся в сети, не поддерживающей многоадресную рассылку? Различные ограничения по размеру пакета также могут стать серьезной проблемой. Как передать 8000-байтный пакет по сети с максимальным размером пакета 1500 байт? Когда пакеты из ориентированной на соединение сети пересекают сеть, не требующую соединений, их порядок может нарушиться. **Для отправителя это может оказаться неприятной неожиданностью — впрочем, как и для получателя.**

## Объединение гетерогенных сетей

**Существует два основных способа объединения различных сетей**. Можно **создать специальные устройства, транслирующие или конвертирующие пакеты** между сетями разного типа. Или, как это часто делают специалисты в области компьютерных наук, можно **добавить уровень косвенной адресации и создать общий уровень над сетями**. В любом случае **на границе между сетями размещаются устройства, которые изначально назывались шлюзами (gateways).**

Идея создания общего уровня для устранения различий между сетями была предложена Серфом и Каном (Cerf and Kahn) в 1974 году. Этот **подход имел невероятный успех и нашел применение в протоколах IP и TCP**. 

**В IP используется универсальный формат пакетов, который распознается всеми маршрутизаторами и может быть передан почти по любой сети.** Действие IP распространяется также и на телефонные сети. Кроме того, сегодня этот протокол работает в сенсорных сетях и на малых устройствах, хотя раньше считалось, что это невозможно из-за ограничений на ресурсы.

Ранее на Канальном уровне мы рассмотрели нескольких устройствах для соединения сетей. Среди них повторители, концентраторы, мосты, коммутаторы и шлюзы. Повторители и концентраторы просто переносят биты с одного кабеля на другой. Чаще всего это аналоговые устройства, не имеющие отношения к протоколам вышележащих уровней. Мосты и коммутаторы работают на канальном уровне.
**Шлюзы — высокоуровневые интеркоммуникационные устройства**

##### На илл. (а) изображена интерсеть, состоящая из сетей 802.11, MPLS и Ethernet. (б) Выполнение протоколов на сетевом и канальном уровнях
![[Pasted image 20241225102914.png]]
Сеть 802.11 не требует соединения, а MPLS, наоборот, ориентирована на его установление. Это значит, что необходимо создать виртуальный канал. Когда пакет пройдет по этому каналу, он достигнет границы сети Ethernet. На данном этапе пакет может оказаться слишком большим, так как 802.11 работает с более крупными фреймами, чем Ethernet. В таком случае он разделяется на фрагменты, каждый из которых отправляется по отдельности. Фрагменты снова объединяются по прибытии на адрес назначения. Так заканчивается путешествие пакета.

###### Протокол IP и передача пакетов

1. Общие сведения о протоколе IP:
   - Объединяет разные сети.
   - Передача данных осуществляется через пакеты.

2. Сеть 802.11 (Wi-Fi):
   - Не требует соединения.
   - Пакеты могут превышать максимальный размер Ethernet.

3. Фрагментация пакетов:
   - Большие пакеты разделяются на фрагменты.
   - Фрагменты отправляются отдельно.
   - Восстанавливаются по прибытии.

4. Процесс передачи пакетов:

   - Заголовок IP:
     Содержит адрес получателя.

   - Первый маршрутизатор:
     - Анализирует IP-адрес.
     - Принимает решение о следующем маршруте.
     - Устанавливает виртуальный канал MPLS для передачи к следующему маршрутизатору.

5. На конечном маршрутизаторе:
   - Удаляется заголовок MPLS.
   - Пакет может быть снова разделен для передачи по Ethernet.

6. Достижение адресата:
   - Пакет восстанавливается и доставляется получателю.


**Сложно заставить всех использовать один формат, учитывая, что каждая компания видит коммерческую выгоду в том, чтобы иметь собственный протокол. Помимо IP, который на данный момент является практически универсальным сетевым протоколом, существуют IPX, SNA и AppleTalk**. Ни один из них не используется повсеместно, а новые протоколы будут появляться всегда. Наиболее яркий пример —IPv4 и IPv6. И хотя оба они являются версиями IP, они несовместимы (иначе не было бы необходимости в разработке IPv6).

###### Маршрутизатор, поддерживающий несколько сетевых протоколов, называется многопротокольным маршрутизатором (multiprotocol router)
. Он должен либо преобразовывать их, либо обеспечивать соединение на вышележащем уровне протокола. Ни один из двух вариантов не отвечает всем требованиям сети. **Соединение на более высоком уровне, скажем, с применением TCP, предполагает, что TCP реализован во всех сетях (а это не всегда так).** При этом в сетях могут функционировать только приложения, использующие TCP (к ним не относятся многие программы, работающие в реальном времени).

###### Другой вариант — конвертация пакетов между разными сетями. 
Однако если пакеты не близки по формату и не имеют одинаковых информационных полей, такое преобразование всегда будет неполным и часто обречено на ошибку.
К примеру, длина IPv6-адресов составляет 128 бит. И как бы ни старался маршрутизатор, такой адрес ни за что не поместится в 32-битное поле адреса IPv4.

**Вероятно, IP работает так хорошо только потому, что служит чем-то вроде наименьшего общего знаменателя. Он не многого требует от сетей, однако предоставляет только уровень обслуживания best effort (Негарантированная доставка)**.

## Соединение конечных точек в гетерогенных сетях

Объединение сетей в общем случае **является исключительно сложной задачей. Однако существует частный случай, реализация которого вполне осуществима** даже для разных сетевых протоколов. Это **ситуация, при которой хост-источник и хост-приемник расположены в одинаковых сетях, но между ними находится сеть другого типа.**

Например, международный банк, у которого имеется сеть IPv6 в Париже и такая же — в Лондоне, а между ними находится IPv4, как показано на илл. . Для решения этой проблемы **используется туннелирование (tunneling).**
![[Pasted image 20241225105156.png]]
Чтобы передать IP-пакет хосту в Лондоне, хост в Париже формирует пакет, содержащий лондонский IPv6-адрес, и отправляет его на многопротокольный маршрутизатор, соединяющий парижскую сеть IPv6 и сеть IPv4. Получив пакет IPv6, маршрутизатор помещает его в другой пакет с IPv4-адресом маршрутизатора, соединяющего сеть IPv4 и лондонскую сеть IPv6. Когда пакет попадает на этот адрес, лондонский многопротокольный маршрутизатор извлекает исходный IPv6-пакет и передает его дальше на хост назначения. Переупаковкой пакета и переадресацией занимаются многопротокольные маршрутизаторы. Для этого им нужно уметь разбираться в IPv6- и IPv4-пакетах. В результате **весь путь от одного многопротокольного маршрутизатора до другого работает как один транзитный участок.**

**Путь через сеть IPv4 можно рассматривать как большой туннель, идущий от одного многопротокольного маршрутизатора до другого. IPv6-пакет просто перемещается от одного конца туннеля до другого в удобной «коробке».**

Туннелирование широко используется для соединения изолированных хостов и сетей посредством других сетей. В результате появляется новая сеть, которая, по сути, накладывается на старую. 
###### Она называется оверлейной сетью (overlay).
Использование сетевого протокола с новым свойством (как в нашем примере, где сети IPv6 соединяются через IPv4)  — достаточно распространенная причина применения этого метода. **Недостатком туннелирования является то, что пакет невозможно доставить на хосты сети-посредника**. Однако **это становится преимуществом в сетях VPN**. Это обычная оверлейная сеть, использующаяся
в качестве меры безопасности.


## Межсетевая маршрутизация

#### Проблемы маршрутизации в интерсетях

**Маршрутизация в интерсетях сопровождается теми же основными проблемами, что и в одной сети, но с некоторыми дополнительными сложностями.** Рассмотрим две сети с разными алгоритмами маршрутизации: с учетом состояния линий и по вектору расстояний. В первом случае **алгоритму требуется информация о топологии сети, во втором — нет, поэтому неясно, как вычислять кратчайшие пути в такой интерсети**.
**Более серьезные проблемы возникают, если работу сети обеспечивают разные операторы.** Прежде всего, они могут по-разному представлять себе, что такое хороший маршрут: **одни обращают больше внимания на время задержки, другие — на затраты**. В результате стоимость пути указывается в разных единицах: в миллисекундах задержки или денежных единицах. Из-за невозможности сопоставления весовых коэффициентов вычисление кратчайших путей становится
затруднительным.
Более того, провайдер может не предоставлять другим операторам доступ к данным о весах и маршрутах в своей сети. В них может быть информация, составляющая коммерческую тайну (например, стоимость).


#### Требования к алгоритму для решения проблем при маршрутизации

1. Двухуровневый алгоритм маршрутизации:

   - Необходим для эффективной маршрутизации данных.

2. Внутридоменный (intradomain) шлюзовый протокол:

   - Используется в пределах каждой сети.

   - Обозначается как внутренний шлюзовый протокол.

   - Может быть обычным протоколом, учитывающим состояние линий.

3. Междоменный (interdomain) шлюзовый протокол:

   - Применяется между различными сетями.

   - Обозначается как внешний шлюзовый протокол.

   - Сети могут использовать разные внутридоменные протоколы, но междоменный протокол должен быть единым для всех.

В интернете ключевым фактором являются коммерческие договоренности между провайдерами. Каждый из них может взимать с других провайдеров плату за передачу трафика. **Еще одна особенность — если при межсетевой маршрутизации пересекаются границы государств, в игру могут вступить их законы. Так, в Швеции персональные данные граждан находятся под строжайшей защитой. Все эти внешние предпосылки объединяются в понятие политики маршрутизации (routing policy)**, в соответствии с которой автономные сети выбирают пути. 


## Поддержка различных размеров пакета: фрагментация пакета и MTU

Все сети и каналы накладывают на размер своих пакетов ограничения, обусловленные разными факторами:

1. Аппаратное обеспечение (например, размер фрейма Ethernet).

2. Операционная система (например, все буферы имеют размер 512 байт).

3. Протоколы (например, количество битов в поле длины пакета).

4. Соответствие какому-либо международному или национальному стандарту.

5. Желание снизить количество пакетов, отправляемых повторно из-за ошибок передачи.

6. Желание предотвратить ситуацию, когда один пакет слишком долгое время занимает канал.

С учетом всех этих факторов **разработчики не могут выбирать максимальный размер пакета по своему усмотрению. Максимальный размер поля полезной нагрузки составляет 1500 байт для сети Ethernet и 2272 байта для 802.11. Протокол IP более щедр: размер пакета может достигать 65 515 байт.**

Обычно хосты стараются отправлять крупные пакеты, так как это уменьшает издержки — например, позволяет сэкономить на заголовках. Очевидно, возникает проблема, когда большой пакет должен пройти по сети с недостаточным максимальным размером пакетов.
**Одно из решений проблемы состоит в ее предотвращении**. Но это непросто, обычно **отправитель не знает, по какому пути будут передаваться данные, а значит, ему неизвестно, какого размера должен быть пакет**, чтобы добраться до места назначения. Такой **размер пакета называется путевым значением MTU (Path Maximum Transmission Unit — максимальный размер пакета для выбранного пути)**

### Фрагментация

**Альтернативное решение — позволить шлюзам разбивать пакеты на фрагменты (fragments) и отправлять каждый из них в виде отдельного пакета** сетевого уровня.
Но всегда разобрать большой объект на мелкие части существенно проще, чем соединить их обратно.

В сетях с коммутацией пакетов также существует проблема объединения фрагментов. **Для восстановления исходных пакетов применяются две противоположные стратегии.** 
- Согласно первой, порожденная сетью с малым размером пакетов **фрагментация должна быть прозрачной** для всех сетей, через которые пакет проходит на пути к адресату. 

- Другая стратегия **фрагментации заключается в отказе от восстановления пакета на промежуточных маршрутизаторах**. С каждым фрагментом обращаются как с отдельным пакетом. Так называемая **не прозрачная фрагментация**. Задача восстановления оригинального пакета возложена на получающий хост. 
	Основное преимущество непрозрачной фрагментации состоит в том, что маршрутизаторы выполняют меньше работы. Так работает IP. При этом фрагменты пакета должны нумероваться таким образом, чтобы можно было восстановить исходный поток данных. В случае IP каждому фрагменту сообщается номер, который есть у каждого пакета, абсолютное байтовое смещение внутри пакета и метка, показывающая, является ли этот фрагмент последним в пакете. Схема очень проста, но обладает рядом важных преимуществ. По прибытии в место назначения фрагменты можно помещать в буфер в любом порядке. Кроме того, при пересечении сети с меньшим значением MTU фрагменты могут быть разбиты на более мелкие части (см. илл. 5.41 (в)). При повторной передаче (если не все фрагменты дошли до адресата) пакет может быть разделен по-другому. И наконец, размер фрагментов может быть произвольным, вплоть до одного байта (плюс заголовок). В любом случае пакет будет восстановлен: номер пакета и смещение помогут расположить данные в правильном прядке, а метка укажет на конец пакета.

###### Сравнение вариантов фрагментации
![[Pasted image 20241225113144.png]]
Вариант прозрачной фрагментации показан на илл. (а). Когда на G1 приходит слишком большой пакет, он разбивается на фрагменты. Все они адресуются одному и тому же выходному маршрутизатору G2, который восстанавливает из них исходный пакет. Таким образом, прохождение данных через сеть с небольшим размером пакетов оказывается прозрачным. Соседние сети даже не знают, что произошла фрагментация.

#### Проблемы прозрачной фрагментации

1. Необходимость идентификации полного пакета:

   - Выходной маршрутизатор должен знать, что пакет получен полностью.

   - Фрагменты должны содержать:
     Поле счетчика.
     Бит, обозначающий конец пакета.

2. Ограничения маршрутизации:

   - Все фрагменты должны проходить через один и тот же маршрутизатор для последующего восстановления пакета.

   - Фрагменты не могут следовать к конечному получателю по разным маршрутам.

   - Это может привести к потере производительности.

3. Буферизация данных маршрутизатором:

   - Маршрутизатор может потребовать буферизовать все полученные данные.

   - Необходимо определить момент, когда можно удалить данные, если не все фрагменты были получены.

4. Дополнительные накладные расходы:

   - Фрагментация и сборка пакетов при прохождении через сети с малым размером пакетов увеличивают накладные расходы.

#### Проблемы не прозрачной фрагментации

1. Затраты на заголовки:

   - Фрагменты могут содержать заголовки, которые передаются по каналам, где они не нужны.

   - Это приводит к избыточным затратам на передачу данных.

2. Потеря производительности:

   - При утере одного из фрагментов теряется весь пакет, что негативно сказывается на производительности сети.

   - Необходимость повторной передачи всего пакета вместо только утерянного фрагмента увеличивает задержки.

3. Нагрузка на хосты:

   - Фрагментация создает дополнительную нагрузку на хосты, так как они должны обрабатывать фрагменты и собирать их обратно в полные пакеты.

   - Это может привести к увеличению вычислительных затрат и снижению общей производительности системы.

4. Сложность управления фрагментами:

   - Необходимость отслеживания и управления фрагментами добавляет сложности в обработку данных.

   - Хосты должны иметь механизмы для восстановления пакетов, что требует дополнительных ресурсов.



#### Пример пакета при фрагментации
![[Pasted image 20241225114633.png]]
### MTU (Path Maximum Transmission Unit — максимальный размер пакета для выбранного пути)

**Стратегия, использующаяся в современном интернете, называется**
**поиском путевого значения MTU (Path MTU discovery).**

При отправке IP-пакета в его заголовке указывается, что фрагментация запрещена. Если маршрутизатор получает слишком большой пакет, он удаляет его и отправляет источнику сообщение об ошибке. Используя эту информацию, отправитель перераспределяет данные так, чтобы пакеты смогли пройти через маршрутизатор. Если такая проблема возникнет на одном из следующих маршрутизаторов, процесс повторится.
#### Пример работы MTU
![[Pasted image 20241225114531.png]]

#### Преимущества и организация работы 

**Преимущество поиска путевого значения MTU состоит в том, что теперь источник знает необходимый размер пакета.** При изменении маршрута отправитель узнает новое значение MTU из новых сообщений об ошибке. 
**Однако фрагментация между отправителем и получателем все равно необходима, если только значение MTU не вычислено на более высоком уровне и не передано IP.**

==**Чтобы обеспечить передачу такой информации, TCP и IP обычно используются вместе (в виде TCP/IP)**==. И хотя для некоторых протоколов это пока не реализовано, фрагментация все же была перенесена из сети на хосты.

#### Недостатки и варианты решения их

**Недостатком этого метода является то, что отправка пакета может вызвать**
**дополнительную задержку**. Эта задержка может увеличиться в несколько раз в зависимости от того, **сколько раз отправителю придется повторять отправку (меняя размер пакета), прежде чем какие-либо данные достигнут адресата**. 

Возникает вопрос: **существуют ли более эффективные схемы? Вероятно, да.** Рассмотрим, к примеру, **вариант, при котором слишком большие пакеты просто обрезаются. В таком случае адресат узнает путевое значение MTU максимально быстро (по размеру доставленного пакета)**, а также получает некоторую часть данных.
вариант, при котором слишком большие пакеты просто обрезаются. В таком случае адресат узнает путевое значение MTU максимально быстро (по размеру доставленного пакета)