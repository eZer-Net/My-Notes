#### Немного истории о появлении
компания Ericsson заинтересовалась вопросом беспроводной связи между мобильными телефонами и другими устройствами (например, ноутбуками). Совместно с четырьмя другими компаниями (IBM, Intel, Nokia и Toshiba) в 1998 году была сформирована «Специальная рабочая группа» (SIG, Special Interest Group). Она занялась развитием стандарта беспроводного соединения компьютеров и устройств связи, а также созданием аксессуаров с недорогими маломощными радиоустройствами ближнего действия. Проект был назван Bluetooth («Синий зуб») в честь великого короля викингов по имени Харальд Синезубый II, который объединил Данию и Норвегию.
        Блютуз появился в июле 1999 года

#### Архитектура Bluetooth физ уровня
**В основе Bluetooth лежит пикосеть (piconet), состоящая из одного главного узла и нескольких (до семи) подчиненных узлов**, расположенных в радиусе 10 м.
	В одной и той же комнате, если она достаточно большая, могут располагаться **несколько пикосетей, они могут также связываться друг с другом**
	**посредством моста (специального узла). Несколько объединенных вместе пикосетей составляют рассеянную сеть (scatternet).**
    Помимо семи активных подчиненных узлов, пикосеть может включать до 255 так называемых запаркованных узлов. Это устройства, переведенные в режим пониженного энергопотребления главным узлом, — за счет этого продлевается ресурс их источников питания. В таком режиме узел может только отвечать на запросы активации или на сигнальные последовательности от главного узла. Также существует два промежуточных режима энергопотребления —приостановленный и анализирующий.
    Такая архитектура оказалась очень простой и дешевой в реализации (микросхема 
    Bluetooth стоила менее $5) **главный узел контролирует временные слоты для передачи данных и распределяет их между подчиненными узлами. Обмен происходит только между подчиненным и главным узлами. Прямой связи между подчиненными узлами нет.**
	![[Pasted image 20241212101730.png]]

#### Модель уровней протоколов
Стандарт Bluetooth содержит множество протоколов, условно разбитых на уровни. Можно заметить, что структура не соответствует ни OSI, ни TCP/IP, ни 802, ни какой-либо другой известной модели.
	• Внизу находится физический уровень радиосвязи 
		(что вполне соответствует моделям OSI и 802), на котором описывается радиопередача и методы модуляции. Многое здесь направлено на то, чтобы удешевить систему, сделав ее доступной для массового покупателя.
    • Уровень управления каналом связи (немодулированной передачи) чем-то напоминает подуровень MAC, но содержит и некоторые элементы физического уровня. 
	    Здесь описывается, как главный узел контролирует временные слоты и как они группируются во фреймы.
    • Далее следуют два протокола, использующие протокол управления каналом связи. 
	    Протокол управления соединениями устанавливает логические каналы между устройствами, контролирует энергопотребление, сопряжение и шифрование, а также QoS. Он находится ниже линии интерфейса хос-контроллера. Этот интерфейс нужен для удобства реализации: как правило, протоколы ниже линии выполняются на чипе Bluetooth, а выше — на устройстве Bluetooth, где чип размещен.
    • Над линией находится протокол канального уровня — L2CAP (Logical Link Control and Adaptation Protocol — протокол управления логическими связями и сопоставлениями). 
	    Он формирует сообщения переменной длины и при необходимости обеспечивает надежность передачи. L2CAP используется множеством протоколов, в том числе и двумя описанными ранее служебными протоколами.
    • Протокол обнаружения служб используется для определения их местонахождения в пределах сети. 
	    Протокол RFcomm (Radio Frequency communication — радиочастотная передача) эмулирует работу стандартного последовательного порта ПК, к которому обычно подключаются клавиатура, мышь, модем и другие устройства.
    • На самом верхнем уровне находятся приложения. 
	    Профили представлены вертикальными прямоугольниками, потому что каждый из них определяет часть стека протокола для конкретной цели.
	•Специфические профили, например профили для гарнитур, используют только те протоколы, которые необходимы для их работы. Например, профили могут включать L2CAP, если у них есть пакеты для отправки, но пропустить его, если имеется только постоянный поток звуковых сэмплов.
	![[Pasted image 20241212102212.png]]

##### Применение Bluetooth (различные сценарии)
Большинство сетевых протоколов просто предоставляют каналы для обмена данными между сущностями и оставляют их прикладное использование на усмотрение разработчиков. Например, в стандарте 802.11 не говорится, что пользователи должны использовать свои ноутбуки для чтения электронной почты, работы в интернете и т. п. Bluetooth SIG, напротив, специфицирует отдельные сценарии применения и для каждого из них предоставляет свой набор протоколов. Примерно 25 сценариев, называемых профилями (profiles). К сожалению, это значительно усложняет систему.
Профили предназначены для различного использования аудио и видео, профиль отношений к сетям, профили для обмена информацией

##### Bluetooth: уровень радиосвязи
Уровень радиосвязи переносит информацию бит за битом от главного узла к подчиненным и обратно. Это маломощная приемопередающая система с радиусом действия порядка 10 м. Она работает в ISM-диапазоне 2,4 ГГц, как и 802.11. Диапазон разделен на 79 каналов по 1 МГц в каждом. Чтобы обеспечить сосуществование с другими сетями в ISM-диапазоне, применяется расширенный спектр со скачкообразной перестройкой частоты.
    `Возможны до 1600 скачков частоты в секунду, то есть минимальный временной слот для передачи равен 625 мкс. Все узлы пикосетей перестраивают частоты одновременно, в соответствии с синхронизацией слотов и псевдослучайной последовательностью скачков, генерируемой главным узлом.`
    `Для отправки битов по каналу используются три формы модуляции. В базовой схеме применяется кодирование со сдвигом частоты, чтобы отправлять 1-битный символ каждую микросекунду. Это дает общую скорость передачи данных 1 Мбит/с. Начиная с версии Bluetooth 2.0, скорость увеличилась благодаря кодированию со сдвигом фазы. Общая скорость передачи достигает 2 или 3 Мбит/с за счет отправки 2 или 3 бит за символ. Увеличенная скорость применяется только для фреймов данных.`

##### Bluetooth: канальный уровень
Уровень радиосвязи переносит информацию бит за битом от главного узла к подчиненным и обратно. Это маломощная приемопередающая система с радиусом действия порядка 10 м. Она работает в ISM-диапазоне 2,4 ГГц, как и 802.11. Диапазон разделен на 79 каналов по 1 МГц в каждом. Чтобы обеспечить сосуществование с другими сетями в ISM-диапазоне, применяется расширенный спектр со скачкообразной перестройкой частоты. Возможны до 1600 скачков частоты в секунду, то есть минимальный временной слот для передачи равен 625 мкс. Все узлы пикосетей перестраивают частоты одновременно, в соответствии с синхронизацией слотов и псевдослучайной последовательностью скачков, генерируемой главным узлом.
	К сожалению, оказалось, что ранние версии Bluetooth и 802.11 интерферируют настолько, что нарушают передачи друг друга. По этой причине некоторые компании полностью отказались от Bluetooth, но в конечном итоге техническое решение было найдено. Оно заключалось в том, чтобы адаптировать последовательность скачков для исключения каналов, на которых есть другие радиосигналы. Этот процесс, названный адаптивной перестройкой рабочей частоты (adaptive frequency hopping), снижает помехи.
	Для отправки битов по каналу используются три формы модуляции. В базовой схеме применяется кодирование со сдвигом частоты, чтобы отправлять 1-битный символ каждую микросекунду. Это дает общую скорость передачи данных 1 Мбит/с. Начиная с версии Bluetooth 2.0, скорость увеличилась благодаря кодированию со сдвигом фазы. Общая скорость передачи достигает 2 или 3 Мбит/с за счет отправки 2 или 3 бит за символ. Увеличенная скорость применяется только для фреймов данных.

##### Bluetooth: канал связи 
Уровень управления каналом связи (немодулированной передачи) — это наиболее близкий к MAC-подуровню элемент иерархии Bluetooth. Он трансформирует простой поток битов во фреймы и определяет некоторые ключевые форматы. 
	 Полезные данные фрейма могут быть зашифрованы в целях конфиденциальности. Ключ шифрования выбирается, когда ведущее устройство соединяется с ведомым. Переключение частоты происходит только между фреймами, но не в момент передачи. В результате передача пятислотового фрейма намного более эффективна, чем однослотового, потому что при тех же затратах отправляется больше данных.
	 Протокол управления соединениями устанавливает логические каналы — соединения (links). В них происходит обмен фреймами между обнаружившими друг друга устройствами (главным и подчиненным). Прежде чем использовать соединение, два устройства проходят процедуру сопряжения. 
	 `Первоначальный метод сопряжения заключался в PIN коде но из за глупости пользователей данный метод оказался слаб и был выбран более подходящий, подтвердить, что оба устройства показывают один и тот же ключ, или увидеть ключ на одном устройстве и ввести его на втором.`
	Когда сопряжение завершено, протокол устанавливает соединения. **Для передачи полезной нагрузки (пользовательских данных) используются два основных типа соединений.** 
	**Первый тип — синхронный с установлением связи (Synchronous Connection Oriented, SCO)**. Он предназначен для передачи данных в реальном времени, например при телефонных разговорах. Такой тип канала получает фиксированный временной слот для передачи в каждом направлении. У подчиненного узла может быть до трех соединений SCO с главным узлом; каждое из них представляет собой аудиоканал PCM с пропускной способностью 64 000 бит/с. Из-за ограниченного времени передачи фреймы, переданные по каналу SCO, никогда не отправляются заново. Вместо этого для повышения надежности может быть использована FEC.
	**Второй тип соединения — асинхронный без установления связи (Asynchronous Connectionless, ACL)**. Он используется для коммутации пакетов данных, которые могут появиться в произвольный момент времени. Трафик ACL доставляется по принципу максимальных усилий без гарантий. Фреймы могут теряться и пересылаться повторно. У подчиненного узла может быть только одно ACL соединение с главным узлом. Данные, отправляемые по ACL-каналу, приходят с уровня **L2CAP. Этот уровень выполняет четыре основные функции.** 
	**Во-первых**, он принимает пакеты размером до 64 Кбайт с верхних уровней и **разбивает их на фреймы для передачи по физическому каналу**. На противоположном конце этот же уровень используется для обратного действия — объединения фреймов в пакеты. 
	**Во вторых**, **он мультиплексирует и демультиплексирует многочисленные источники пакетов**. После сборки пакета L2CAP определяет, куда его следует направить (например, протоколу RFcomm или протоколу обнаружения служб). 
	**Втретьих, он обеспечивает контроль ошибок и повторную передачу фреймов.** L2CAP вы являет ошибки и заново отправляет неподтвержденные пакеты. Наконец, **L2CAP следит за соблюдением требований QoS между несколькими соединениями.**

#### Bluetooth: структура фрейма
![[Pasted image 20241213135304.png]]
	• Access Code (Код доступа): 
		Идентификатор главного узла.
		Позволяет подчиненным узлам различать, кому предназначены данные.
	• Header (Заголовок):
		Длина: 54 бита.
		Содержит поля подуровня MAC.
	• Поле данных:
		При базовой скорости: до 2744 бит (для передачи за пять слотов) или 240 бит (для одного слота).
		При увеличенной скорости: размер блока данных может быть в 2 или 3 раза больше.  
	• Охранное поле (Guard) и паттерн синхронизации (Sync): 
		Предшествуют данным для переключения на более высокую скорость передачи.
	• Trailer (Заключительное поле):
		Короткое поле в конце фрейма.
	**Структура заголовка фрейма**
		• Address (Адрес): 
			Указывает на одно из восьми активных устройств.
		• Type (Тип): 
			Определяет тип фрейма (ACL, SCO, опрос, пустой) и метод коррекции ошибок.
		• Flow Bit (F): 
			Сообщает о заполнении буфера подчиненного узла для управления потоком.
		• Acknowledgement Bit (A): 
			  Используется для отправки вложенного подтверждения (ACK).
		• Sequence Bit (S): 
			  Нумерует фреймы для обнаружения повторных передач.
		• Checksum: 
			  8-битная контрольная сумма заголовка.
		• Повторение заголовка: 
			  Заголовок повторяется трижды, что составляет 54 бита.
	**Форматы поля данных**
		• SCO-фрейм с базовой скоростью:
			Длина поля данных всегда равна 240 бит.
			Возможные варианты полезной информации: 80, 160 или 240 бит.
		• Коррекция ошибок:
			В надежной версии (80 бит полезной информации) одно и то же содержимое повторяется три раза.
	Пропускная способность
		Подчиненный узел использует нечетные временные слоты, получая 800 слотов в секунду.
		При передаче 80 бит полезных данных в одном фрейме, емкость канала составляет 64,000 бит/с.
	Эффективность передачи:
	  Исходная пропускная способность: 1 Мбит/с.
	  Полнодуплексный голосовой канал может вызвать пере загрузку пикосети.
	Заключение
		Эффективность передачи составляет около 13%, что обусловлено затратами на стабилизацию (41%), заголовки (20%) и повторное кодирование (26%).

##### Bluetooth 5
	между Bluetooth 4 и Bluetooth 5 имеется ряд различий. Вот список ключевых обновлений в версии Bluetooth 5.0:
		1. Поддержка IoT.
		2. Скорость возросла с 1 до 2 Мбит/с.
		3. Размер сообщений увеличился с 31 до 255 байт.
		4. Радиус действия в помещениях увеличился с 10 до 40 м.
		5. Немного уменьшилось потребление энергии.
		6. Слегка увеличился радиус действия маяков.
		7. Несколько повысился уровень безопасности.
		
	Нельзя назвать это существенными переменами, но их и не следовало
	ожидать, учитывая необходимость в обеспечении обратной совместимости.
	Стандарт Bluetooth 5.1 внес еще несколько небольших обновлений, касающихся
	отслеживания устройств, кэширования и некоторых других незначительных
	моментов.
