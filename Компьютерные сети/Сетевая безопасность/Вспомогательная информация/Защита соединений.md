## IPsec

Стандарта ==IPsec== (IP security — IP-безопасность) ==это набор протоколов, предназначенных для обеспечения безопасности передачи данных по IP-сетям==. Он обеспечивает конфиденциальность, целостность и аутентификацию данных, передаваемых по сети. 

#### IPsec состоит из двух основных компонентов:

1. **Заголовки IPsec**
   - Добавляются к пакету для передачи:
     • Идентификатора защиты
     • Данных контроля целостности
     • Другой информации

2. **ISAKMP (Internet Security and Key Management Protocol)**
   - Предназначен для создания ключей
   - Является средой, в которой работает основной протокол:
     • IKE (Internet Key Exchange) — обмен ключами в интернете

#### IPsec может функционировать в двух режимах:

1. Транспортный режим (Transport Mode)
   - Заголовок IPsec вставляется сразу после заголовка IP.
   - Поле Protocol заголовка IP изменяется, чтобы указать на наличие заголовка IPsec (перед заголовком TCP).
   - Заголовок IPsec содержит информацию о безопасности:
     • Идентификатор SA
     • Новый порядковый номер
     • Проверка целостности пользовательских данных

2. Режим туннелирования (Tunnel Mode)
   - Весь IP-пакет, включая заголовок, помещается внутрь нового IP-пакета с новым заголовком.
   - Применяется, если туннель заканчивается не в пункте назначения.
   - Часто концом туннеля является шлюз безопасности (например, корпоративный брандмауэр), что актуально для [[Защита соединений#Виртуальные частные сети|VPN]].
   - Шлюз безопасности [[Компьютерные сети/Термины#Инкапсуляция|инкапсулирует]] и декапсулирует пакеты, проходящие через него.
   - Компьютеры локальной сети (LAN) не должны знать о стандарте IPsec; за это отвечает только шлюз безопасности.
![[Pasted image 20250109174900.png]]

#### Режим туннелирования

Недостаток этого режима состоит в добавлении дополнительного IP-заголовка,
что заметно увеличивает пакет. 

Один из новых заголовков называется заголовком **аутентификации (Authentication Header, AH)**. С его помощью проверяется целостность данных и выполняется защита от взлома путем повторной передачи. Однако он не имеет никакого отношения к секретности (то есть к шифрованию данных).
![[Pasted image 20250109175157.png]]


**Поле Next Header (Следующий заголовок)**
- Описание: Хранит значение, которое ранее находилось в поле Protocol заголовка IP.
- Значение: Обычно содержит код для TCP (6).
- Замена: Значение заменяется на 51, чтобы указать, что далее следует заголовок AH.

**Поле Payload Length (Длина полезной нагрузки)**
- Описание: Указывает количество 32-разрядных слов заголовка AH минус 2.
- Формат: Значение представлено в 32-битных словах.

**Поле Security Parameters Index (Указатель параметров безопасности)**
- Описание: Идентификатор соединения, вставляемый отправителем.
- Функция: Ссылается на конкретную запись в базе данных получателя, содержащую общий ключ и другую информацию о соединении.
- Альтернативное название: Если бы данный протокол был разработан МСЭ, это поле называлось бы Virtual Circuit Number (Номер виртуального канала).

**Поле Sequence Number (Порядковый номер)**
- Описание: Применяется для нумерации всех пакетов, отправляемых по Security Association (SA).
- Функция: Все пакеты получают уникальные номера, даже если они отправляются повторно.
- Безопасность: Позволяет предотвратить атаки повторного воспроизведения, так как порядковые номера никогда не повторяются.
- Ограничение: Если будут использованы все 2^32 номера, для продолжения коммуникации устанавливается новая SA.

**Поле Authentication Data (Данные аутентификации)**
- Описание: Содержит цифровую подпись пользовательских данных.
- Алгоритм: При установлении SA стороны договариваются о алгоритме генерации подписей.
- Шифрование: Обычно не применяется шифрование с открытыми ключами из-за его медлительности; используется шифрование с симметричными ключами.
- Код HMAC: IPsec использует код [[Хеши#Виды хеширования|HMAC]], который позволяет быстро вычислять подписи по сравнению с последовательным запуском SHA-2 и RSA.

#### Альтернативным заголовком IPsec является ESP (Encapsulating Security Payload — безопасная инкапсуляция пользовательских данных).
![[Pasted image 20250109175719.png]]

Заголовок ESP состоит из двух 32-разрядных слов: Security parameters index (Указатель параметров безопасности) и Sequence number (Порядковый номер). Мы их уже встречали в заголовке AH. Третье слово, которое обычно следует за ними, при этом технически не являясь частью заголовка, это Initialization vector (Вектор инициализации); но если используется пустой алгоритм шифро­вания, это поле опускается.

ESP, как и АН, обеспечивает проверку целостности при помощи кода HMAC, однако вместо того чтобы включать хеш в заголовок, он вставляется после поля пользовательских данных.

Казалось бы, если ESP умеет делать все то же, что и АН (даже больше и при этом гораздо эффективнее), зачем вообще нужен АН? Причина скорее историческая. Изначально заголовок АН обеспечивал только проверку целостности, а ESP — только секретность. Позднее ESP стали использовать для проверки целостности, но разработчики АН не хотели, чтобы он канул в Лету после всей проделанной ими работы. Еще один сомнительный довод состоит в том, что система, поддерживающая АН, но не поддерживающая ESP, может легче получить лицензию на экспорт, поскольку с помощью АН нельзя шифровать данные. Похоже, что этот заголовок все-таки исчезнет.


## Виртуальные частные сети

Сеть, состоящая из принадлежащих компании компьютеров и выделенных телефонных линий, называется частной сетью (private network).

Частные сети обеспечивают высокую степень защиты и предотвращают утечки трафика, так как злоумышленникам нужно физически подключаться к линиям для перехвата данных. Однако **аренда выделенных каналов между точками очень дорогостоящая**. С появлением сетей общего доступа и интернета многие компании начали использовать их **для передачи данных и голоса, не желая жертвовать безопасностью частной сети**. В ответ на этот запрос появились ==виртуальные частные сети (VPN Virtual Private Networks)==. Это [[Компьютерные сети/Термины#Оверлейная сеть (от английского "overlay networks")|оверлейные сети]], которые работают поверх обычных общедоступных сетей, но обладают свойствами частных. Они называются виртуальными, поскольку это не более чем иллюзия, так же как виртуальные каналы — это не реальные каналы, а виртуальная память — не реальная память.

Часто VPN развертывают напрямую в интернете. Как правило, в каждом офисе устанавливается [[Сетевая безопасность#Брандмауэры|брандмауэры]] и создаются туннели через интернет между всеми парами офисов

## Безопасность в беспроводных сетях

С помощью [[Защита соединений#Виртуальные частные сети|VPN]] и [[Брандмауэры и системы обнаружения вторжения#Брандмауэры|брандмауэров]] очень просто создать систему, которая по логике абсолютно надежна, **но на практике протекает, как решето.** 

Такая ситуация может возникнуть, если в сети есть беспроводные устройства, передающие данные с помощью радиосигнала, который проходит прямо через брандмауэр в обоих направлениях. Радиус действия сетей 802.11 может составлять до 100 м, поэтому для перехвата информации шпион может просто приехать на автостоянку перед зданием фирмы, оставить в машине ноутбук с приемопередатчиком 802.11, записывающим все, что слышно в эфире, и пойти гулять по городу.


#### WPA (Wi-Fi Protected Access)

   • Дата создания: 2003 год

   • Инновации: Промежуточная схема, реализующая подмножество стандарта 802.11i, улучшенное шифрование по сравнению с WEP.

   • Уязвимости: Уязвимость к атакам подбора паролей и другим видам атак, связанным с недостаточной безопасностью ключей.

   • Методы снижения уязвимостей:
     • Использование сложных паролей.
     • Регулярная смена паролей.
     • Ограничение доступа к сети.

#### WPA2 (Wi-Fi Protected Access 2)

   • Дата создания: 2004 год

   • Инновации: Полная реализация стандарта 802.11i с поддержкой AES (Advanced Encryption Standard) для шифрования.

   • Уязвимости: Уязвимость к атакам KRACK (Key Reinstallation Attack), а также общие проблемы с управлением ключами в сценарии с единственным паролем.

   • Методы снижения уязвимостей:
     • Настройка WPA2 с использованием EAP для корпоративных сетей.
     • Использование уникальных паролей для каждого клиента в сетях без сервера аутентификации.
     • Регулярное обновление программного обеспечения точек доступа.

#### WPA3 (Wi-Fi Protected Access 3)

   • Дата создания: Январь 2018 года

   • Инновации: Использует 128-битное шифрование для личного использования и 192-битное — для корпоративной версии, переработанный механизм «рукопожатия» Dragonfly для защиты от атак подбора пароля.

   • Уязвимости: Обнаружена уязвимость DragonBlood, которая может сводить на нет некоторые преимущества WPA3.


#### Процесс аутентификации и шифрования в WPA/WPA2

1. Четырехпакетное «рукопожатие»

   • Первый пакет: Точка доступа (AP) отправляет случайное число (нонс) для идентификации.

   • Второй пакет: Клиент выбирает свой собственный нонс и использует его вместе с нонсом AP, своим MAC-адресом, MAC-адресом AP и главным ключом для вычисления ключа сеанса (Ks).

   • Третий пакет: Клиент отправляет свой нонс AP. AP производит аналогичный расчет, чтобы получить те же ключи сеанса.

   • Четвертый пакет: AP выдает клиенту общий ключ (K_G), и клиент подтверждает его получение.

2. Ключ сеанса (Ks)

   • Ключ сеанса разбивается на части, каждая из которых применяется для различных целей (например, для шифрования трафика и проверки целостности).

   • Нонсы могут передаваться открыто, так как их недостаточно для вычисления ключей без секретной информации.

3. Проверка целостности сообщения (MIC)

   • Сообщение клиента защищено MIC, которая рассчитывается на основе ключа сеанса.

   • AP проверяет MIC, чтобы удостовериться в целостности и аутентичности сообщения.

4. Использование общего ключа (K_G)

   • Общий ключ используется для передачи трафика по 802.11 LAN.

   • Каждый клиент имеет свои уникальные ключи шифрования, что делает невозможным использование одного ключа AP для передачи пакетов всем клиентам.

   • Общий ключ должен обновляться по мере изменения состава клиентов в сети.

5. Протоколы безопасности

   • Для обеспечения конфиденциальности, целостности и аутентификации в 802.11i могут использоваться два протокола:

     • TKIP (Temporary Key Integrity Protocol): Временное решение для повышения безопасности старых карт 802.11, обеспечивающее защиту лучше, чем WEP.
     был взломан, поэтому сегодня рекомендуется использовать протокол CCMP.

     • CCMP (Counter mode with Cipher Block Chaining Message Authentication Code Protocol): Использует шифрование AES с 128-битными блоками. Ключ выводится из ключа сеанса.

6. Принцип действия CCMP

   • Сообщения шифруются с помощью AES в режиме счетчика, что предотвращает повторное шифрование одних и тех же сообщений в одинаковые наборы битов.

   • Для обеспечения целостности сообщения кодируется шифром в режиме обратной связи, и последний блок сохраняется как MIC.

   • Как клиент, так и AP могут выполнять шифрование или проверять его при получении беспроводного пакета.

   • В случае многоадресных или широковещательных сообщений применяется групповой ключ.