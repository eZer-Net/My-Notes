
# **SELinux: Основные понятия**

#### Что это?

- **SELinux** (Security-Enhanced Linux) — это механизм принудительного контроля доступа основанный на **MAC** (Mandatory Access Control) и **rBAC** (Role-Based Access Control), разработанный для повышения безопасности системы.

- Ограничивает возможности процессов и пользователей, даже если они имеют права root.

#### Как работает SELinux?

- Использует **политики безопасности**, которые определяют, какие действия могут выполнять процессы, пользователи и файлы.

- Основан на **ролях** (**rBAC**) и (**MAC**) **типах**, которые назначаются политиками SELinux.

- При разделении доступа к оборудованию сначала проверяет **DAC** (Discretionary Access Control), а затем обращается к политикам SELinux для проверки меток.

#### Режимы SELinux

1. **Enforced**:
    - Режим по умолчанию.
    - Все политики активно применяются.

2. **Permissive**:
    - Политики не применяются, но все попытки доступа записываются в лог-файлы.
    - Полезен для отладки.

3. **Disabled**:
    - SELinux полностью отключен.
    - Не рекомендуется использовать, так как система становится уязвимой.


#### **Команды для управления режимами:**

- Проверка текущего режима:
    `getenforce`
    `sestatus`
    
- Смена режима для текущего сеанса:
    `sudo setenforce 0  # Permissive`
    `sudo setenforce 1  # Enforced`


----


# Объяснение работы


Таблица того как работает SELinux на примере работы системы

| Пользователь (работает в OC) | Программа/Процесс (Запускается от работы пользователя) | Файл (к которому обращается процесс) |
| :--------------------------: | :----------------------------------------------------: | ------------------------------------ |
|            Метка1            |                         Метка2                         | Метка3                               |

==Метки называются контекстами безопасности== и SELinux позволяет написать правила по которому процесс с меткой2 может обращаться к метке3. 

#### **Что такое контекст?**
**Контекст безопасности — это метка, которая определяет уровень доступа для пользователей, процессов и файлов.** 

Формат контекста:
```
_u # Пользователь
_r # Роль
_t # Тип
```

#### Примеры команд для просмотра контекстов:
- программы которые показывают информацию о пользователях процессах и файлов для работ с SELinux есть ключ `-Z`
	- `id -Z` - выводит контекст безопасности текущего пользователя в формате `пользователь:роль:тип`
	- `ps -Z` - выводит контексты безопасности всех запущенных процессов.

#### **Пользователи и роли в SELinux**

##### Связь локальных пользователей и пользователей SELinux:
SELinux не использует системных пользователей а имеет свои, но при этом их связывает:

- Локальные пользователи связаны с пользователями SELinux.
- Просмотр связей:
```
sudo semanage login -l
```

| Login Name | SELinux user | MLS/MCS Range  | Service |
| ---------- | ------------ | -------------- | ------- |
| default    | unconfiend_u | s0-s0:с0.с1023 | *       |
| root       | unconfiend_u | s0-s0:с0.с1023 | *       |
- Login Name - локальные пользователи

- SELinux user - пользователи SELinux к которым привязаны локальные пользователи

- MLS/MCS Range - механизмы для управления доступом на основе уровней безопасности и категорий. Они используются в системах с повышенными требованиями к безопасности.


##### Просмотр пользователей SELinux и их ролей:

```
sudo semanage user -l
```

| SELinux user | Labeling prefix | MLS/MCS Level | MLS/MCS Range  | SELinux roles               |
| ------------ | --------------- | ------------- | -------------- | --------------------------- |
| root         | user            | s0            | s0-s0:c0.c1023 | staff_r sysadm_r system_r u |
| nconfined_r  |                 |               |                |                             |
| unconfiend_u | user            | s0            | s0-s0:c0.c1023 | system_r unconfiend_r       |
- SELinux user - пользователи SELinux к которым привязаны локальные пользователи

- Labeling prefix - префикс, который используется для автоматической маркировки файлов и процессов при их создании. Например, файлы, созданные в определенной директории, могут автоматически получать определенный тип.

- MLS/MCS Range - механизмы для управления доступом на основе уровней безопасности и категорий. Они используются в системах с повышенными требованиями к безопасности.

- SELinux roles - роли в SELinux определяют, какие типы объектов может использовать пользователь. Роли являются частью механизма RBAC (Role-Based Access Control) в SELinux.

### Команды для управления пользователями в SELinux

#### **Добавление пользователей**

- **Добавление пользователя SELinux:**
    `sudo semanage user -a -R "роль1,роль2" имя_пользователя`
    
	- `-a` — добавить пользователя.
    - `-R` — указать роли, которые будут назначены пользователю.
    - `имя_пользователя` — имя пользователя SELinux.

- **Связывание локального пользователя с пользователем SELinux:**
    `sudo semanage login -a -s selinux_пользователь локальный_пользователь`
    
    - `-a` — добавить связь.
    - `-s` — указать пользователя SELinux.
    - `локальный_пользователь` — имя локального пользователя.

#### **Изменение пользователей**

- **Изменение ролей пользователя SELinux:**
    `sudo semanage user -m -R "новая_роль1,новая_роль2" имя_пользователя`
    
    - `-m` — изменить пользователя.
    - `-R` — указать новые роли.

- **Изменение связи локального пользователя с пользователем SELinux:**
    `sudo semanage login -m -s новый_selinux_пользователь локальный_пользователь`


#### **Удаление пользователей**

- **Удаление пользователя SELinux:**
    `sudo semanage user -d имя_пользователя`
    
    - `-d` — удалить пользователя.

- **Удаление связи локального пользователя с пользователем SELinux:**
    `sudo semanage login -d локальный_пользователь`

### **Управление ролями**

#### **Добавление ролей пользователю**

- Используйте команду `semanage user -m` для добавления ролей:
    `sudo semanage user -m -R "роль1,роль2" имя_пользователя`
#### **Удаление ролей у пользователя**

- Используйте команду `semanage user -m` для удаления ролей:
    `sudo semanage user -m -R "роль1" имя_пользователя`
    
    (Укажите только те роли, которые должны остаться.)

### **Как пользователь может узнать свои роли без участия админа**

Пользователь может узнать свои роли и контекст безопасности с помощью следующих команд:

1. **Узнать контекст текущего пользователя:**
    `id -Z`
    
    Пример вывода:
    `user_u:user_r:user_t`
    
    - `user_u` — пользователь SELinux.
    - `user_r` — роль.
    - `user_t` — тип.

2. **Узнать контекст запущенных процессов:**
    `ps -Z`

3. **Узнать роли, доступные текущему пользователю:**
    `seinfo -r -u пользователь`
    
    - `-r` — показать роли.
    - `-u` — указать пользователя.


# Типы политик SELinux

### **Предустановленные политики**

Эти политики поставляются с дистрибутивом и охватывают большинство стандартных сценариев использования. Они делятся на несколько типов:

#### **a. Targeted (Целевые)**
- **Описание:** Это наиболее распространенный тип политики, используемый по умолчанию в большинстве дистрибутивов (например, CentOS, RHEL, Fedora).

- **Особенности:**
    - Защищает только ключевые системные процессы и сервисы (например, Apache, SSH, MySQL).
    - Остальные процессы работают в "неограниченном" режиме (тип `unconfined_t`), что означает, что на них не распространяются строгие ограничения SELinux.

- **Примеры:**
    - Веб-сервер Apache (`httpd_t`) защищен политикой.
    - Пользовательские процессы (`user_t`) могут быть неограниченными.

#### **b. Strict (Строгие)**
- **Описание:** Эта политика применяет ограничения ко всем процессам и пользователям в системе.
    
- **Особенности:**
    - Все процессы и пользователи работают под строгим контролем SELinux.
    - Требует тщательной настройки и может вызвать проблемы с совместимостью приложений.

- **Использование:** Редко используется на практике из-за сложности настройки.

#### **c. MLS (Multi-Level Security)**
- **Описание:** Политика, которая поддерживает многоуровневую безопасность (MLS), используемую в системах с высокими требованиями к конфиденциальности (например, в государственных или военных организациях).

- **Особенности:**
    - Каждый объект и субъект имеет уровень безопасности (например, `Secret`, `Top Secret`).
    - Доступ разрешен только между объектами и субъектами с соответствующими уровнями.

- **Пример:** Пользователь с уровнем `Secret` не может читать файлы с уровнем `Top Secret`.

#### **d. MCS (Multi-Category Security)**
- **Описание:** Упрощенная версия MLS, которая используется для изоляции контейнеров и виртуальных машин.

- **Особенности:**
    - Каждый объект и субъект имеет категорию (например, `c0`, `c1`).
    - Используется для разделения ресурсов между контейнерами или виртуальными машинами.

- **Пример:** Контейнер Docker с категорией `c0` не может взаимодействовать с ресурсами категории `c1`.

### **Кастомные политики**

Администратор может создавать собственные политики для удовлетворения специфических требований безопасности. Это делается с помощью утилит, таких как:
- **`audit2allow`:** Генерирует правила политики на основе логов SELinux.
- **`semanage`:** Управляет контекстами безопасности, портами, пользователями и ролями.
- **`checkmodule` и `semodule`:** Компилируют и загружают модули политик.