
Для оценки и тестирования конечных точек API первым делом нужно ознакомиться со структурой домена, который использует веб-приложение. **В современном мире один домен для обслуживания всего веб-приложения применяется редко. Куда чаще встречается разделение как минимум на клиентские и серверные домены.**

## Множество приложений в рамках одного домена

Пример мы пытаемся составить карту веб-приложения MegaBank в рамках теста на проникновение методом black-box. Для пользователей известен [[Всемирная паутина#Сторона клиента|url]] адрес https://www.mega-bank.com. У большинства крупных компаний к основному домену прикреплено множество субдоменов. На них размещаются различные сервисы — от электронной почты до административных приложений, файловых серверов и др. .

**Существует много способов поиска информации об этих доменах, и для получения желаемого результата часто приходится попробовать несколько разных вариантов.** 

## Встроенные в браузер инструменты анализа

Некоторые полезные данные удается обнаружить, просто просмотрев функциональность в приложении MegaBank и запросы API, которые выполняются в фоновом режиме. Зачастую таким способом можно получить информацию о наиболее очевидных конечных точках. **Для просмотра результатов запросов можно использовать как инструменты браузера, так и более мощные внешние аналоги, например [[Инструмент Burp Suite|Burp]] или [[Инструмент Zed Attack Proxy (ZAP)|ZAP]].** 

Пример инструментов [[Встроенный инструмент браузера|браузера для разработчиков]] Википедии, которые можно использовать для просмотра, редактирования, повторной отправки и записи сетевых запросов. 
![[Pasted image 20250104151920.png]]

Современные браузеры позволяют выполнять сетевой анализ, анализ кода, определение времени выполнения кода [[JavaScript|JavaScript]] с точками остановки и ссылками на файлы, точное измерение производительности (которое может пригодиться при атаках по побочным каналам), а также имеют встроенные инструменты для определения незначительных угроз безопасности и проверки на совместимость.
![[Pasted image 20250104152037.png]]

**Вкладка [[Встроенный инструмент браузера#Каскадная диаграмма (waterfall diagram)|Network]] показывает весь обрабатываемый браузером сетевой трафик.** Но для крупных сайтов отфильтровать нужную информацию может быть непросто. Самые интересные результаты зачастую дает **фильтр XHR**, который включается нажатием одноименной кнопки. Кнопки фильтров позволяют отображать не только все HTTP-запросы (POST, GET, PUT, DELETE), но и другие запросы к серверу, а также шрифты, изображения, видео и файлы зависимостей. Выделение любого запроса открывает слева дополнительную панель с более детальной информацией о нем.

**Вкладка Response покажет неотформатированный исходник ответа, а вкладка Timing — такие показатели, связанные с запросом, как время в очереди, время загрузки и тайм-ауты.** Все эти показатели производительности можно использовать для нахождения вектора атаки по побочным признакам. (Например, ориентируясь на оценку времени выполнения различных сценариев на сервере.)

==Во время просмотра любого сайта можно выделить строку с запросом и на вкладке Headers открывшейся справа консоли посмотреть в разделе General данные Request URL. Это даст информацию о домене, к которому был отправлен запрос или от которого был получен ответ.== Часто этого достаточно для обнаружения серверов, связанных с основным веб-сайтом.

## Общедоступная информация

В настоящее время в сети хранится такой объем общедоступной информации, что случайная утечка данных может происходить годами.

Информацию можно найти во многих местах, например в:
- поисковых системах;
- сообщениях в соцсетях;
- приложениях для архивирования, например archive.org;
- истории поиска и обратного поиска изображений.

## Кэши поисковых систем

В мире чаще всего используют Google, поэтому считается, что этот поисковик проиндексировал больше данных, чем любой другой.

Существуют специальные операторы поиска, позволяющие сделать запрос более конкретным. 

- **Оператор site:<имя_сайта>**  
  Просит Google ограничить поиск определенным доменом. Например, если вы хотите найти статьи о здоровье только на сайте Wikipedia, вы можете ввести:  
	  site:wikipedia.org здоровье
  

- **Оператор intitle:<слово>**  
  Позволяет находить страницы, в заголовке которых содержится указанное слово. Например:  
	  intitle:экология
  Этот запрос вернет страницы, где в заголовке присутствует слово "экология".

- **Оператор inurl:<слово>**  
  Позволяет искать страницы с указанным словом в URL. Например:   
	  inurl:блог
  Этот запрос найдет страницы, в которых слово "блог" присутствует в адресе.

- **Оператор filetype:<тип_файла>**  
  Ограничивает результаты поиска определенным типом файла. Например, чтобы найти PDF-документы о маркетинге, можно использовать:   
	  marketing filetype:pdf
  

- Оператор OR  
  Позволяет искать страницы, содержащие одно из нескольких указанных слов. Например:  
	  "путешествия" OR "отпуск"
  Этот запрос вернет страницы, где есть либо "путешествия", либо "отпуск".

- **Оператор - (минус)**  
  Исключает определенные слова из результатов поиска. Например:   
	  яблоки -зеленые
  Этот запрос вернет страницы о яблоках, но исключит упоминания о зеленых яблоках.

## Поиск в архиве

Публичные архиваторы, такие как Archive.org, периодически создают снэпшоты, что позволяет посещать копии веб-сайтов «из прошлого». Archive.org стремится сохранить историю интернета. Многие сайты умирают, а новые забирают их домены. Архив интернета хранит исторические снимки сайтов, существовавших лет 20 назад, а значит, это просто кладезь информации, которая когда-то побывала в открытом доступе (намеренно или случайно), но позже была удалена.

==Поиск субдоменов в архиве автоматизируется с помощью следующих простых шагов.==
1. Откройте 10 архивов для 10 разных дат, разделенных значительным временным промежутком.
2. Щелкните на архиве правой кнопкой мыши, выберите в меню команду Просмотр кода страницы и нажатием комбинации клавиш Ctrl+A выделите весь HTML-код.
3. Нажатием комбинации клавиш Ctrl+C скопируйте выделенный HTML-код в буфер обмена.
4. На рабочем столе создайте файл legacy-source.html.
5. Комбинацией клавиш Ctrl+V вставьте скопированный код в файл.
6. Повторите это для всех открытых архивов.
7. Откройте файл legacy-source.html в текстовом редакторе (VIM, Atom, VSCode и т. п.).
8. Выполните поиск наиболее распространенных шаблонов URL:
	- http://
	- https://
	- file://
	- ftp://
	- ftps://

## Социальные профили

Все крупные современные социальные сети сегодня зарабатывают деньги на продаже пользовательских данных. В зависимости от платформы эти данные могут включать в себя общедоступные и закрытые публикации, а в некоторых случаях даже личные сообщения.

#### API, предоставляемый сервисом соц-сетей

диапазоном действия, функциональностью и набором данных.

## Атаки на передачу зоны

**Атака на передачу зоны (zone transfer attack) — это метод сбора информации о домене с использованием уязвимостей в настройках [[Служба имён доменов DNS]].** Давайте более подробно рассмотрим, как это работает. Это не «взлом», а всего лишь легкий метод сбора информации. По своей сути это особым образом отформатированный запрос, который выглядит как реальный запрос на передачу зоны DNS от реального DNS-сервера.

**Передача зоны — это процесс, при котором один DNS-сервер (обычно вторичный) запрашивает у другого сервера (обычно первичного) копию записей DNS для определенного домена**. Это необходимо для обеспечения синхронизации данных между серверами. Передача зоны осуществляется с помощью протокола AXFR (или IXFR для инкрементальных обновлений)

#### Как происходит атака на передачу зоны?

1. **Сбор информации о DNS-серверах:** 
   Как вы уже упомянули, первый шаг — это определить, какие DNS-серверы обслуживают целевой домен. Это можно сделать с помощью команды host или dig:
   
   dig NS uksap.ru
```
   ; <<>> DiG 9.20.2-1-Debian <<>> NS uksap.ru
	;; global options: +cmd
	;; Got answer:
	;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 51801
	;; flags: qr rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 1
	
	;; OPT PSEUDOSECTION:
	; EDNS: version: 0, flags:; udp: 1232
	;; QUESTION SECTION:
	;uksap.ru.      IN  NS
	
	;; ANSWER SECTION:
	uksap.ru.    300  IN  NS  ns4.netangels.ru.
	uksap.ru.    300  IN  NS  ns1.netangels.ru.
	uksap.ru.    300  IN  NS  ns2.netangels.ru.
	uksap.ru.    300  IN  NS  ns3.netangels.ru.
	
	;; Query time: 163 msec
	;; SERVER: 192.168.1.1#53(192.168.1.1) (UDP)
	;; WHEN: Sat Jan 04 17:00:37 +05 2025
	;; MSG SIZE  rcvd: 119
```
Объяснение вывода

1. Заголовок:   
   ; <<>> DiG 9.20.2-1-Debian <<>> NS uksap.ru

   - Это версия утилиты dig, которая используется для выполнения DNS-запросов. В данном случае используется версия 9.20.2-1-Debian.

   - Запрашивается информация о типе NS для домена uksap.ru.

2. Глобальные параметры:
   
   ;; global options: +cmd
   

   - Здесь указаны глобальные параметры, которые были использованы при выполнении команды. В данном случае используется только параметр +cmd, который показывает, что команда была выполнена.

3. Полученный ответ:
   
   ;; Got answer:
   ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 51801
   ;; flags: qr rd ra; QUERY: 1, ANSWER: 4, AUTHORITY: 0, ADDITIONAL: 1
   

   - opcode: QUERY — это тип запроса, в данном случае обычный запрос.

   - status: NOERROR — статус ответа, который указывает на то, что запрос был успешным и ошибок не было.

   - id: 51801 — идентификатор запроса, который позволяет сопоставить запрос с ответом.

   - flags:

     • qr — это ответ на запрос (query response).

     • rd — рекурсивный запрос (recursion desired), указывающий, что клиент запрашивает рекурсивную обработку.

     • ra — рекурсивная доступность (recursion available), указывающая, что сервер может выполнять рекурсивные запросы.

   - QUERY: 1 — количество запросов, отправленных серверу (в данном случае один).

   - ANSWER: 4 — количество ответных записей в секции ответа (в данном случае четыре записи).

   - AUTHORITY: 0 — количество авторитетных записей (в данном случае ноль).

   - ADDITIONAL: 1 — количество дополнительных записей (в данном случае одна).

4. OPT PSEUDOSECTION:
   
   ;; OPT PSEUDOSECTION:
   ; EDNS: version: 0, flags:; udp: 1232
   
   - Это информация о расширенной системе DNS (EDNS). 

   - version: 0 — версия EDNS.

   - flags: — дополнительные флаги (в данном случае отсутствуют).

   - udp: 1232 — максимальный размер UDP-пакета в байтах, который сервер может обрабатывать.

5. Секция вопроса:
   
   ;; QUESTION SECTION:
   ;uksap.ru.      IN  NS
   
   - Здесь показан сам вопрос, который был отправлен на сервер.

   - uksap.ru. — домен, для которого запрашиваются NS-записи.

   - IN — класс записи (Internet).

   - NS — тип записи (Nameserver).

6. Секция ответа:
   
   ;; ANSWER SECTION:
   uksap.ru.    300  IN  NS  ns4.netangels.ru.
   uksap.ru.    300  IN  NS  ns1.netangels.ru.
   uksap.ru.    300  IN  NS  ns2.netangels.ru.
   uksap.ru.    300  IN  NS  ns3.netangels.ru.
   
   - Здесь перечислены записи NS для домена uksap.ru.

   - Каждая запись имеет следующие поля:

     • uksap.ru. — домен.

     • 300 — время жизни (TTL) записи в секундах (300 секунд или 5 минут).

     • IN — класс записи (Internet).

     • NS — тип записи (Nameserver).

     • nsX.netangels.ru. — имена серверов, отвечающих за управление DNS для данного домена.

7. Дополнительная информация:
   
   ;; Query time: 163 msec
   ;; SERVER: 192.168.1.1#53(192.168.1.1) (UDP)
   ;; WHEN: Sat Jan 04 17:00:37 +05 2025
   ;; MSG SIZE  rcvd: 119
   
   - Query time: 163 msec — время, затраченное на выполнение запроса (163 миллисекунды).

   - SERVER: 192.168.1.1#53(192.168.1.1) (UDP) — адрес DNS-сервера, к которому был отправлен запрос (192.168.1.1) и порт (53), используемый для DNS-запросов по протоколу UDP.

   - WHEN: — дата и время выполнения запроса (4 января 2025 года, 17:00:37 по местному времени +05).

   - MSG SIZE rcvd: 119 — размер полученного сообщения в байтах (119 байт).



2. **Запрос на передачу зоны:**
   После того как мы узнали имена серверов, мы можем попытаться выполнить запрос на передачу зоны:
   
   host -l uksap.ru ns1.netangels.ru
   
   Если сервер неправильно настроен и разрешает запросы на передачу зоны, он вернет все записи DNS для данного домена.

3. **Получение данных:**
   Если запрос успешен, вы получите список всех записей, включая A-записи, MX-записи и другие. Но зачастую мы увидим:
```
	Using domain server:
	Name: ns1.secure-bank.com
	Address: 141.122.34.45
	Aliases:
	
	: Transfer Failed.
```

**Так же можно попробовать по проверке сертификатов SSL**

Если сайт использует SSL-сертификаты, можно проверить, какие другие домены могут быть покрыты одним и тем же сертификатом. Для этого можно использовать такие инструменты, как:

- crt.sh — позволяет искать сертификаты по доменам.

Пример запроса:
	https://crt.sh/?q=uksap.ru

#### Почему атаки на передачу зоны редки?

Правильно настроенные DNS-серверы должны защищать себя от таких атак. Вот некоторые из методов защиты:

1. **Ограничение доступа:** 
   Передача зоны должна быть разрешена только для доверенных IP-адресов (например, внутренних DNS-серверов). Это можно настроить в конфигурации DNS-сервера.

2. **Использование TSIG:** 
   Для повышения безопасности можно использовать ключи TSIG (Transaction Signature) для аутентификации запросов на передачу зоны.

3. **Ограничение типа запросов:** 
   Некоторые администраторы могут полностью отключить поддержку AXFR для публичных DNS-серверов, что делает невозможным выполнение передачи зоны.

## Брутфорс субдоменов

В качестве последнего способа поиска субдоменов можно использовать атаку методом грубой силы — [[Брутфорс (Brute Force Attack)|брутфорс (brute-force attack)]]. Такие атаки действенны против веб-приложений с небольшим количеством защит, а вот в случае давно существующих и защищенных веб-приложений их следует тщательно планировать.

**К брутфорсу имеет смысл прибегать только в крайнем случае, потому что его легко обнаружить. Кроме того, зачастую на эту атаку тратится очень много времени из-за ограничений скорости, регулярных выражений и других простых механизмов безопасности**, разработанных для предотвращения несанкционированных вмешательств такого типа.

Цикл обратной связи, необходимый для обнаружения действующего субдомена, довольно прост. **Алгоритм брутфорса генерирует субдомен, и по адресу <вариант_субдомена>.mega-bank.com** отправляется запрос. Если ответ приходит, субдомен отмечается как действующий. В противном случае мы отмечаем, что такой субдомен недоступен.

**Сценарий должен выполнять следующие действия:**
1. Генерировать список потенциальных субдоменов.
2. Пинговать каждый субдомен, проверяя его доступность.
3. Записывать действующие субдомены.
```
const dns = require('dns');

/*
 * Простая функция для брутфорса списка субдоменов
 * с указанием максимальной длины каждого из них.
 */
const generateSubdomains = function(length) {
    /*
     * Список символов, из которых генерируются субдомены.
     * В него можно добавить менее распространенные символы
     * вроде '-'.
     *
     * Некоторые браузеры поддерживают также китайские,
     * арабские и латинские символы.
     */
    const charset = 'abcdefghijklmnopqrstuvwxyz'.split('');
    let subdomains = ['']; // Начинаем с пустого субдомена
    let subdomain;
    let letter;
    let temp;

    /*
     * Сложность алгоритма: o(n*m)
     * n = длина строки
     * m = количество допустимых символов
     */
    for (let i = 0; i < length; i++) {
        temp = [];
        for (let k = 0; k < subdomains.length; k++) {
            subdomain = subdomains[k];
            for (let m = 0; m < charset.length; m++) {
                letter = charset[m];
                temp.push(subdomain + letter);
            }
        }
        subdomains = temp;
    }

    return subdomains; // Возвращаем список сгенерированных субдоменов
};

const subdomains = generateSubdomains(4);
const promises = [];

/*
 * В цикле выполняем асинхронные DNS-запросы к каждому субдомену.
 *
 * Это более эффективно, чем популярная функция dns.lookup(),
 * которая из JavaScript выглядит асинхронной, но полагается на
 * реализуемую синхронно функцию операционной системы getaddrinfo(3).
 */
subdomains.forEach((subdomain) => {
    promises.push(new Promise((resolve, reject) => {
        dns.resolve(${subdomain}.mega-bank.com, function (err, ip) { # ДОМЕН!!!
            if (err) {
                return resolve({ subdomain: subdomain, ip: null }); // Если ошибка, возвращаем null IP
            }
            return resolve({ subdomain: subdomain, ip: ip });
        });
    }));
});

// после завершения всех DNS-запросов записываем результаты
Promise.all(promises).then(function(results) {
    results.forEach((result) => {
        if (result.ip) {
            console.log(result);
        }
    });
});
```
После небольшого ожидания в терминале появится список существующих
субдоменов:
```
	{ subdomain: 'mail', ip: '12.32.244.156' },
	{ subdomain: 'admin', ip: '123.42.12.222' },
	{ subdomain: 'dev', ip: '12.21.240.117' },
	{ subdomain: 'test', ip: '14.34.27.119' },
	{ subdomain: 'www', ip: '12.14.220.224' },
	{ subdomain: 'shop', ip: '128.127.244.11' },
	{ subdomain: 'ftp', ip: '12.31.222.212' },
	{ subdomain: 'forum', ip: '14.15.78.136' }
```

## Перебор по словарю

Процесс поиска субдоменов можно ускорить, если вместо брутфорса воспользоваться перебором по словарю. **В этом случае также проверяется широкий спектр потенциальных субдоменов, но вместо списка, сгенерированного случайным образом, берется список наиболее распространенных вариантов.**

Популярный DNS-сканер с открытым исходным кодом dnscan поставляется со списком самых популярных субдоменов, полученным на основе миллионов субдоменов из более чем 86 000 записей зон DNS. ==25 наиболее распространенных субдоменов по данным dnscan:==
- www
- mail
- ftp
- localhost
- webmail
- smtp
- pop
- ns1
- webdisk
- ns2
- cpanel
- whm
- autodiscover
- autoconfig
- m
- imap
- test
- ns
- blog
- pop3
- dev
- www2
- admin
- forum
- news

В репозитории GitHub этого сканера есть файлы, содержащие 10 000 основных субдоменов. https://github.com/rbsec/dnscan.