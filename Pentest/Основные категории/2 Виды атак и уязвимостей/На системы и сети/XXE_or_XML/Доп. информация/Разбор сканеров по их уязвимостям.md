
**Есть разновидности сканеров такие как**
- Парсеры с явными настройками 
- Парсеры с дефолтными настройками
- Парсеры из внешних компонентов (внешние либы,компоненты...)

## Парсеры с явными настройками
### .Net 

Опасные настройки
```
using (var xmlTextReader = new XmlTextReader(xmlFileStringReader))
{
    // Установка XmlResolver на XmlUrlResolver позволяет парсеру загружать внешние ресурсы,
    xmlTextReader.XmlResolver = new XmlUrlResolver();

    // Установка DtdProcessing на Parse позволяет парсеру обрабатывать DTD,
    xmlTextReader.DtdProcessing = DtdProcessing.Parse;
    ...
}
```

```
var settings = new XmlReaderSettings()
{
    // Установка DtdProcessing на Parse также опасна, так как это позволяет загружать и обрабатывать DTD.
    DtdProcessing = DtdProcessing.Parse,

    // Установка XmlResolver на XmlUrlResolver позволяет загружать внешние ресурсы
    XmlResolver = new XmlUrlResolver()
};

using (var xmlReader = XmlReader.Create(xmlFileStringReader, settings))
{
    ...
}

```

Безопасные настройки
```
var settings = new XmlReaderSettings()
{
    // Установка DtdProcessing на Prohibit предотвращает обработку DTD,
    DtdProcessing = DtdProcessing.Prohibit,

    // Установка XmlResolver в null предотвращает загрузку любых внешних ресурсов
    XmlResolver = null
};

using (var xmlReader = XmlReader.Create(xmlFileStringReader, settings))
{
    ...
}
```

### Java

Опасные настройки
```
var factory = DocumentBuilderFactory.newInstance();
factory.setFeature( "http://xml.org/sax/features/external-general-entities", false);
...


// Features отключаются разными настройками в отличие C#
// http://xml.org/sax/features/external-general-entities
// http://xml.org/sax/features/external-parameter-entities

// external-general-entities: Эта настройка отвечает за разрешение обработки общих внешних сущностей. Установка значения false отключает эту возможность, что делает парсер более безопасным.
// external-parameter-entities: Важно также отключить обработку параметрических внешних сущностей.
```

## Парсеры с дефолтными настройками

### Java
Дефолтные парсеры на Java имеют больше уязвимостей чем на .NET тем самым повышены к данной уязвимости, [даже owasp пишет об этом](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html)
![[Pasted image 20250114140837.png]]

```
public static void processXm1 (InputStream is)
throws ... {
	DocumentBuilderFactory fact = DocumentBuilderFactory.newInstance ();
	DocumentBuilder db = fact.newDocumentBuilder ();
	Document doc = db.parse(is);
	// ...
}
```

### .NET

Код, представленный ниже, демонстрирует загрузку XML-документа с использованием класса XmIDocument. Однако безопасность этого процесса зависит от версии .NET и настроек парсера.
```
XmIDocument doc = new XmIDocument();
doc.Load(xmlReader);
```


**Под капотом**
При вызове метода Load у XmIDocument используется внутренний парсер. Рассмотрим, как это происходит:
```
public virtual void Load(Stream inStream) {
    XmlTextReader reader = SetupReader(new Xm1TextReader(inStream, NameTable));
    try {
        Load(reader);
    }
    finally {
        reader.Imp1.Close(false);
    }
}
```
- Здесь SetupReader создает экземпляр Xm1TextReader, который обрабатывает входной поток.

**Глубже в реализацию**
При создании Xm1TextReader происходит проверка настроек безопасности:
```
internal XmITextReaderImp1(Xm1NameTable nt) {
    if (!System.Xm1.XmlReaderSettings.EnableLegacyXm1Settings()) {
        xmlResolver = null;
    } else {
        xmlResolver = new XmlUr1Resolver();
    }
    // ...
}
```
- Если устаревшие настройки безопасности отключены, xmlResolver устанавливается в null, что предотвращает обработку внешних сущностей.

**Проверка устаревших настроек**
Метод, определяющий, включены ли устаревшие настройки:

```
private static bool? _enableLegacyXmlSettings = null;

static internal bool EnableLegacyXmISettings() {
    if (s_enableLegacyXmlSettings.HasValue) {
        return s_enableLegacyXmlSettings.Value;
    }
    
    if (ISystem.Xml.BinaryCompatibility.TargetsAtLeast_Desktop_VA_5_2) {
        s_enableLegacyXmlSettings = true;
        return s_enableLegacyXmlSettings.Value;
    }
    
    bool enableSettings = false; // default value
    if (IReadSettingsFromRegistry(Registry.LocalMachine, ref enableSettings)) {
        ReadSettingsFromRegistry(Registry.CurrentUser, ref enableSettings);
    }
    
    s_enableLegacyXmlSettings = enableSettings;
    return s_enableLegacyXmlSettings.Value;
}
```
- Здесь проверяется, включены ли устаревшие настройки через чтение значений из реестра.

#### Версии .NET: 
  - До 4.5.1: Код может быть уязвим к атакам XXE (XML External Entity), так как устаревшие настройки могут быть включены.
  - С 4.5.2 и выше: Безопасность повышается, так как по умолчанию отключена обработка внешних сущностей, если не включены устаревшие настройки. (так же должен быть в конфиге указана версия)
- [В помощь .NET так же идёт OWASP](https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html)
![[Pasted image 20250114143646.png]]

