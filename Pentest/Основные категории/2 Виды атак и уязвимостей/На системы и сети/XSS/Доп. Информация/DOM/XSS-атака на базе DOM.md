Уязвимости XSS на основе [[DOM]] обычно возникают, когда JavaScript берет данные из контролируемого злоумышленником источника, например URL, и передает их в приемник, поддерживающий динамическое выполнение кода, например `eval()`или `innerHTML`.

Чтобы осуществить атаку на основе DOM XSS, необходимо поместить данные в источник таким образом, чтобы они передавались в приемник и вызывали выполнение произвольного JavaScript.

Наиболее распространенным источником для DOM XSS является URL, который обычно доступен через объект window.location. Злоумышленник может создать ссылку, чтобы отправить жертву на уязвимую страницу с полезной нагрузкой в строке запроса и фрагменте URL. В некоторых случаях, например, при нацеливании на страницу 404 или сайт, работающий на PHP, полезная нагрузка также может быть помещена в путь.

[[DOM|Для подробного объяснения потока загрязнения между источниками и приемниками]].

# Как проверить наличие межсайтового скриптинга на основе DOM

#### Тестирование HTML-приемников

Чтобы проверить наличие DOM XSS в HTML-приемнике, поместите случайную буквенно-цифровую строку в источник (например, `location.search`), затем используем [[Встроенный инструмент браузера|инструменты разработчика]], чтобы проверить HTML и найти, где появляется наша строка. Обратим внимание, что опция браузера «Просмотреть исходный код» не будет работать для тестирования DOM XSS, поскольку она не учитывает изменения, которые были выполнены в HTML с помощью JavaScript.

Для каждого места, где наша строка появляется в DOM, нам нужно определить контекст. На основе этого контекста нужно уточнить свой ввод, чтобы увидеть, как он обрабатывается. Например, если наша строка появляется в атрибуте, заключенном в двойные кавычки, попробуем ввести двойные кавычки в строку, чтобы посмотреть, сможете ли вы выйти за пределы атрибута.

Обратите внимание, что **браузеры ведут себя по-разному в отношении URL-кодирования**: Chrome, Firefox и Safari будут URL-кодировать `location.search`и `location.hash`, тогда как **IE11 и Microsoft Edge (до Chromium) не будут URL-кодировать эти источники**. Если ваши данные будут URL-кодироваться до обработки, то атака XSS вряд ли сработает.

#### Тестирование приемников выполнения JavaScript

Тестирование приемников выполнения JavaScript для XSS на основе DOM немного сложнее. С этими приемниками ввод не обязательно появляется где-либо в DOM, поэтому мы не можем его искать. Вместо этого нужно будет использовать  [[Встроенный инструмент браузера#Sources|отладчик JavaScript]], чтобы определить, отправляется ли наш ввод в приемник и как это происходит.

#### Тестирование на DOM XSS с использованием DOM Invader

Выявление и эксплуатация DOM XSS в реальных условиях может быть утомительным процессом, часто требующим ручного прочесывания сложного, минимизированного JavaScript. Однако, если использовать Burp, можно воспользоваться его встроенным расширением [DOM Invader](https://portswigger.net/burp/documentation/desktop/tools/dom-invader), которое делает большую часть тяжелой работы за нас.

# Эксплуатация DOM XSS с различными источниками и приемниками

В принципе, веб-сайт уязвим для межсайтового скриптинга на основе DOM, если есть исполняемый путь, по которому данные могут распространяться от источника к приемнику.

Существует множество приемников, которые имеют отношение к уязвимостям на основе DOM. Подробности [список.](https://portswigger.net/web-security/cross-site-scripting/dom-based#which-sinks-can-lead-to-dom-xss-vulnerabilities)

#### Приемник `document.write`
работает с `script`элементами, поэтому вы можете использовать простую полезную нагрузку
```
document.write('... <script>alert(document.domain)</script> ...');
```
==Обратить внимание==, что в большинстве ситуациях контент, который записывается, `document.write`включает некоторый окружающий контекст, который **нужно учитывать в эксплойте**. Например, может потребоваться закрыть некоторые существующие элементы перед использованием вашей полезной нагрузки JavaScript.

##### Лаба
[[Лаборатория dom xss в document.write приёмник, используя источник location.search]]
[[Лаборатория dom xss в document.write приёмник, используя источник location.search внутри элемента выбора]] 

#### Приемник `innerHTML`
не принимает `script`элементы ни в одном современном браузере, и `svg onload`события не будут срабатывать. Это означает, что нужно будет использовать альтернативные элементы, такие как `img`или `iframe`. Обработчики событий, такие как `onload`и , `onerror`могут использоваться вместе с этими элементами. Например:
```
element.innerHTML='... <img src=1 onerror=alert(document.domain)> ...'
```
