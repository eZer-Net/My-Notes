## Что такое Дом?

DOM (Document Object Model) — это объектная модель документа, которая представляет структуру HTML или XML документа в виде дерева. Каждый элемент на странице (например, заголовки, абзацы, изображения и т.д.) становится объектом, с которым можно взаимодействовать через JavaScript.

##### Пример:
```
<!DOCTYPE html>
<html>
<head>
    <title>Пример</title>
</head>
<body>
    <h1>Привет, мир!</h1>
    <p>Это пример страницы.</p>
</body>
</html>
```

В этом случае DOM будет выглядеть как дерево, где:
- Корень дерева — это `<html>`.
- У него есть два дочерних элемента: `<head>` и `<body>`.
- Внутри `<body>` находятся `<h1>` и `<p>`.

С помощью JavaScript можно изменять содержимое этих элементов, добавлять новые или удалять существующие.


#### Модель объекта документа (DOM) 

это иерархическое представление веб -браузера элементов на странице. Веб -сайты могут использовать JavaScript для манипулирования узлами и объектами DOM, а также их свойствами. Манипуляция DOM само по себе не является проблемой. На самом деле, это неотъемлемая часть того, как работают современные сайты. Тем не менее, JavaScript, который небезопасно обрабатывает данные, может включить различные атаки. Уязвимости, основанные на DOM, возникают, когда веб-сайт содержит JavaScript, который принимает контролируемое злоумышленником ценность, известную как источник, и передает его в опасную функцию, известную как раковина.

Многие уязвимости, основанные на DOM, можно отследить до проблем с тем, как клиентский код обрабатывает данные, контролируемые злоумышленником.  
Что такое поток загрязнения?

Чтобы использовать, важно сначала ознакомиться с основами потока загрязнения между источниками и приемниками.  

----
# Уязвимости потока заражения

Многие уязвимости, связанные с DOM, можно отследить до проблем, связанных с тем, как клиентский код манипулирует данными, контролируемыми злоумышленником.

### Что такое поток загрязнений?

Чтобы воспользоваться этими уязвимостями или минимизировать их, важно сначала ознакомиться с основами потока зараженных данных между источниками и приемниками.

---
# Источники

Источник — это свойство JavaScript, которое принимает данные, потенциально контролируемые злоумышленником. Примером источника является свойство **`location.search`**, поскольку оно считывает ввод из строки запроса, что относительно просто для контроля со стороны злоумышленника. В конечном итоге любое свойство, которое может быть контролируемо злоумышленником, является потенциальным источником. Это включает в себя URL-адрес, с которого пришел запрос (представленный строкой `document.referrer`), куки пользователя (представленные строкой `document.cookie`) и веб-сообщения.  

----
# Приемники

Приемник — это потенциально опасная функция JavaScript или объект DOM, который может вызвать нежелательные последствия, если ему передать данные, контролируемые злоумышленником. Например, **функция `eval()`** является приемником, потому что она обрабатывает аргумент, который ей передается, как JavaScript. Примером HTML-приемника является **`document.body.innerHTML`**, потому что он потенциально позволяет злоумышленнику внедрять вредоносный HTML и выполнять произвольный JavaScript.  

В основном уязвимости, основанные на DOM, возникают, когда веб-сайт передает данные из источника в приемник, который затем обрабатывает данные небезопасным образом в контексте сессии клиента.  

Наиболее распространенным источником является URL-адрес, который обычно доступен через объект location. Злоумышленник может создать ссылку, чтобы отправить жертву на уязвимую страницу с полезной нагрузкой в строке запроса и фрагменте URL. Рассмотрим следующий код:
```
goto = location.hash.slice(1)
if (goto.startsWith('https:')) {
  location = goto;
}
```

Этот код уязвим для открытой переадресации на основе DOM, потому что источник location.hash обрабатывается небезопасным образом. Если URL содержит фрагмент хеша, который начинается с https:, этот код извлекает значение свойства location.hash и устанавливает его как свойство location окна. Злоумышленник может использовать эту уязвимость, создав следующий URL:
`https://www.innocent-website.com/example#https://www.evil-user.net`


Когда жертва посещает этот URL, JavaScript устанавливает значение свойства location на `https://www.evil-user.net`, что автоматически перенаправляет жертву на вредоносный сайт. Это поведение можно легко использовать для создания фишинговой атаки, например.

----
# Общие источники

Следующие источники являются типичными и могут быть использованы для эксплуатации различных уязвимостей, связанных с потоком загрязнения:

##### • document.URL
- Функционал: Возвращает полный URL текущего документа.
- Использование: Чаще всего используется для получения информации о текущем адресе страницы. Может быть использован для анализа или перенаправления.
 
##### • document.documentURI
- Функционал: Возвращает URI текущего документа.
- Использование: Аналогично document.URL, но может использоваться в контексте, где различие между URL и URI важно.
 
##### • document.URLUnencoded
- Функционал: Возвращает URL текущего документа без кодирования.
- Использование: Полезно для работы с неэкранированными символами, что может быть важно при анализе или манипуляции с URL.
 
##### • document.baseURI
- Функционал: Возвращает базовый URI документа.
- Использование: Используется для определения базового адреса относительно которого будут разрешаться относительные URL.

##### • location
- Функционал: Объект, представляющий текущий адрес URL и предоставляющий методы для изменения его.
- Использование: Используется для навигации (например, location.href для перехода на другую страницу).
 
##### • document.cookie
- Функционал: Позволяет читать и записывать куки.
- Использование: Широко используется для хранения пользовательских данных и сессий. Уязвимости могут возникать при неправильной обработке или утечке данных.

##### • document.referrer
- Функционал: Возвращает адрес страницы, с которой пользователь пришел на текущую страницу.
- Использование: Используется для анализа трафика и навигации. Может быть использован для атак типа "Referrer Leakage".

##### • window.name
- Функционал: Свойство, позволяющее хранить строку, связанную с текущим окном.
- Использование: Может быть использовано для передачи данных между страницами или окнами. Уязвимости могут возникнуть при неправильном управлении данными.

##### • history.pushState
- Функционал: Позволяет добавлять записи в историю браузера без перезагрузки страницы.
- Использование: Используется в одностраничных приложениях (SPA) для управления состоянием навигации. Неправильное использование может привести к проблемам с безопасностью.

##### • history.replaceState
  - Функционал: Заменяет текущую запись в истории браузера.
  - Использование: Аналогично pushState, но без добавления новой записи в историю.

##### • localStorage
- Функционал: Позволяет хранить данные в виде пар ключ-значение на стороне клиента без срока действия.
- Использование: Используется для хранения пользовательских настроек и данных между сессиями. Уязвимости могут возникнуть при неправильной обработке данных.

##### • sessionStorage
 - Функционал: Подобно localStorage, но данные хранятся только в рамках одной сессии.
- Использование: Используется для временного хранения данных, таких как состояния форм или временные настройки.

##### • IndexedDB (mozIndexedDB, webkitIndexedDB, msIndexedDB)
- Функционал: Браузерная база данных для хранения больших объемов структурированных данных.
- Использование: Используется для сложных приложений, требующих хранения больших объемов данных на клиенте. Уязвимости могут возникнуть при неправильном управлении доступом к данным.

----
# Какие приемники могут привести к уязвимостям на основе DOM?

Следующий список предоставляет краткий обзор распространенных уязвимостей на основе DOM и примеры приемников, которые могут привести к каждой из них. Для более подробного списка соответствующих приемников, пожалуйста, обратитесь к страницам, посвященным конкретным уязвимостям, перейдя по ссылкам ниже.

| Уязвимость на основе DOM              | Пример приемника         |
| ------------------------------------- | ------------------------ |
| DOM XSS                               | document.write()         |
| Открытая переадресация                | window.location          |
| Манипуляция куками                    | document.cookie          |
| Внедрение JavaScript                  | eval()                   |
| Манипуляция доменом документа         | document.domain          |
| Порча URL WebSocket                   | WebSocket()              |
| Манипуляция ссылками                  | element.src              |
| Манипуляция веб-сообщениями           | postMessage()            |
| Манипуляция заголовками Ajax-запросов | setRequestHeader()       |
| Манипуляция локальными путями файлов  | FileReader.readAsText()  |
| Внедрение SQL на стороне клиента      | ExecuteSql()             |
| Манипуляция хранилищем HTML5          | sessionStorage.setItem() |
| Внедрение XPath на стороне клиента    | document.evaluate()      |
| Внедрение JSON на стороне клиента     | JSON.parse()             |
| Манипуляция данными DOM               | element.setAttribute()   |
| Отказ в обслуживании                  | RegExp()                 |

---
# Как предотвратить уязвимости потока заражения на основе DOM

- ### [[Защита от уязвимости на основе DOM-потока]]

# DOM затирание

DOM clobbering — это продвинутая техника, при которой мы внедряем HTML в страницу для манипулирования DOM и в конечном итоге изменяете поведение JavaScript на веб-сайте. Наиболее распространенная форма DOM clobbering использует элемент привязки для перезаписи глобальной переменной, которая затем используется приложением небезопасным способом, например, для генерации динамического URL-адреса скрипта.

[DOM затирание](https://portswigger.net/web-security/dom-based/dom-clobbering)