## Что такое CORS (взаимодействие с ресурсами разных источников)?

[[Всемирная паутина#**CORS**|Cross-origin resource sharing (CORS)]] — это механизм браузера, который обеспечивает контролируемый доступ к ресурсам, расположенным за пределами заданного домена. Он расширяет и добавляет гибкости политике одного и того же источника ([[Pentest/Термины#SOP (Same Origin Policy)|SOP]]). 
Однако он также предоставляет потенциал для кросс-доменных атак, если политика CORS веб-сайта плохо настроена и реализована. 

CORS не является защитой от кросс-доменных атак, таких как подделка межсайтовых запросов  ([[Cross-Site Request Forgery, CSRF]]).

## Ослабление политики единого происхождения

Политика одного и того же источника очень ограничительна, и поэтому были разработаны различные подходы для обхода ограничений. Многие веб-сайты взаимодействуют с поддоменами или сторонними сайтами таким образом, что требуется полный доступ к кросс-источнику. Контролируемое ослабление политики одного и того же источника возможно с помощью кросс-источника совместного использования ресурсов (CORS).

Протокол обмена ресурсами между источниками использует набор заголовков HTTP, которые определяют доверенные веб-источники и связанные с ними свойства, такие как разрешен ли аутентифицированный доступ. Они объединяются в обмен заголовками между браузером и веб-сайтом между источниками, к которому он пытается получить доступ.

## Уязвимости, возникающие из-за проблем конфигурации CORS

Многие современные веб-сайты используют CORS для разрешения доступа с поддоменов и доверенных третьих сторон. Их реализация CORS может содержать ошибки или быть слишком мягкой для обеспечения того, чтобы все работало, и это может привести к эксплуатируемым уязвимостям.

### [[Заголовок ACAO, сгенерированный сервером из указанного клиентом заголовка Origin]]

Некоторым приложениям необходимо предоставлять доступ к ряду других доменов. Поддержание списка разрешенных доменов требует постоянных усилий, а любые ошибки могут нарушить функциональность. Поэтому некоторые приложения выбирают легкий путь, фактически разрешая доступ из любого другого домена.

Один из способов сделать это — прочитать заголовок Origin из запросов и включить заголовок ответа, указывающий, что запрашивающий origin разрешен. Например, рассмотрим приложение, которое получает следующий запрос:

```
GET /sensitive-victim-data HTTP/1.1 
Host: vulnerable-website.com 
Origin: https://malicious-website.com 
Cookie: sessionid=...
```

Затем он отвечает:
```
HTTP/1.1 200 OK 

Access-Control-Allow-Origin: https://malicious-website.com 
Access-Control-Allow-Credentials: true 
...
```

В этих заголовках указано, что доступ разрешен из запрашивающего домена ( `malicious-website.com`) и что запросы кросс-домены могут включать файлы cookie ( `Access-Control-Allow-Credentials: true`) и поэтому будут обрабатываться в ходе сеанса.

#### Лаба
[[Лабораторная работа Уязвимость CORS с базовым отражением происхождения]]

### [[Ошибки при анализе заголовков Origin]]

Ошибки часто возникают при внедрении белых списков источников CORS. Некоторые организации решают разрешить **доступ со всех своих поддоменов (включая будущие поддомены, которых еще нет)**. А некоторые приложения разрешают доступ с доменов различных других организаций, включая их поддомены. Эти правила часто реализуются путем сопоставления префиксов или суффиксов URL или с использованием регулярных выражений. Любые ошибки в реализации могут привести к предоставлению доступа непреднамеренным внешним доменам.

### [[Значение null источника, внесенное в белый список]]

Спецификация заголовка Origin поддерживает значение `null`. Браузеры могут отправлять значение `null`в заголовке Origin в различных необычных ситуациях:

Некоторые приложения могут вносить `null`источник в белый список для поддержки локальной разработки приложения. Например, предположим, что приложение получает следующий запрос кросс-источника:
```
GET /sensitive-victim-data 
Host: vulnerable-website.com 
Origin: null
```

И сервер отвечает:
```
HTTP/1.1 200 OK 
Access-Control-Allow-Origin: null 
Access-Control-Allow-Credentials: true
```

#### Лаба
[[Лабораторная работа Уязвимость CORS с доверенным нулевым источником]]


### [[Эксплуатация XSS через доверительные отношения CORS]]

Даже «правильно» настроенный CORS устанавливает доверительные отношения между двумя источниками. Если веб-сайт доверяет источнику, который уязвим для межсайтового скриптинга ( XSS ), то злоумышленник может использовать XSS для внедрения некоторого JavaScript, который использует CORS для получения конфиденциальной информации с сайта, который доверяет уязвимому приложению.

### [[Нарушение TLS с помощью плохо настроенного CORS]]

Предположим, что приложение, которое строго использует HTTPS, также вносит в белый список доверенный поддомен, использующий обычный HTTP. Например, когда приложение получает следующий запрос:

```
GET /api/requestApiKey HTTP/1.1 
Host: vulnerable-website.com 
Origin: http://trusted-subdomain.vulnerable-website.com 
Cookie: sessionid=...
```

Приложение отвечает:
```
HTTP/1.1 200 OK 
Access-Control-Allow-Origin: http://trusted-subdomain.vulnerable-website.com Access-Control-Allow-Credentials: true
```

В этой ситуации злоумышленник, который имеет возможность перехватить трафик пользователя-жертвы, может использовать конфигурацию CORS для компрометации взаимодействия жертвы с приложением. 
