Атаки SSRF часто используют доверительные отношения для эскалации атаки со стороны уязвимого приложения

# 1. Поверхности атаки для уязвимостей SSRF

#### 1. Частичные URL-адреса в запросах
Приложение помещает в параметры запроса только имя хоста или часть URL-адреса. Отправленное значение затем включается на стороне сервера в полный запрашиваемый URL-адрес.

 - Пример: Приложение может принимать параметр url, который содержит только имя хоста, например, example.com. Сервер затем формирует полный URL, добавляя протокол (например, http://) и путь. Злоумышленник может отправить запрос с url=localhost, что приведет к запросу к внутреннему серверу.

#### 2. URL-адреса в форматах данных
Приложения передают данные в форматах со спецификацией, позволяющей включать URL-адреса, которые могут быть запрошены анализатором данных для этого формата.

- Пример: Форматы, такие как JSON или XML, могут содержать поля, в которых ожидаются URL-адреса. Например, JSON-объект может выглядеть так: `{"callbackUrl": "http://malicious.com"}`. Если приложение не фильтрует это поле, оно может сделать запрос к указанному URL.
#### 3. Заголовок Referer
Приложения используют серверное аналитическое программное обеспечение для отслеживания посетителей. Это программное обеспечение часто регистрирует заголовок Referer в запросах, поэтому оно может отслеживать входящие ссылки.

#### 4. Параметры API:
В RESTful API параметры могут содержать URL-адреса для получения данных. 

- Например, `GET /api/resource?callback=http://malicious.com`. Если сервер не проверяет эти параметры, он может выполнить запрос к вредоносному сайту.

#### 5. HTTP-заголовки:
Некоторые приложения могут использовать пользовательские HTTP-заголовки для передачи информации о URL. 

- Например, заголовок `X-Forwarded-For` может быть использован для указания IP-адреса, который сервер должен запрашивать.

#### 6. Ссылки на ресурсы в базе данных:
Если приложение получает URL-адреса из базы данных и не фильтрует их должным образом, злоумышленник может вставить URL, который ведет на внутренние ресурсы или на ресурсы под контролем атакующего.

# 2. SSRF-атака без фильтрации

- Отправка адреса: `127.0.0.0 — 127.255.255.255` зарезервированный IP-адрес, указывающий на адаптер обратной связи или `localhost` (обычно используемое название для одного и того же адаптера).

- Немаршрутизируемые частные IP-адреса `https://192.168.0.68/`

----
# 3. SSRF-атака с фильтрацией

#### SSRF с входными фильтрами на основе чёрного списка

- Использовать альтернативное IP-представление `127.0.0.1`, такой как 
	`2130706433` (10-тичная система), 
	`017700000001` (8-ричная система), 
	`127.1` (опускать нули).

- Зарегистрировать собственное доменное имя, которое разрешается `127.0.0.1`. Мы можем использовать `spoofed.burpcollaborator.net` для этой цели.

- Запутывать заблокированные строки
	использовать кодировку URL, двойную кодировку url 
	изменение регистра (example EXAMPLE ....)

- Укажите URL-адрес, которым вы управляете, который перенаправляет на целевой URL-адрес. Попробуйте использовать разные коды перенаправления, а также разные протоколы для целевого URL. Например, переключение с `http:` к `https:` 

#### SSRF с входными фильтрами на основе белых списков

Спецификация URL-адреса содержит ряд функций, которые, вероятно, будут упущены из виду, когда URL-адреса реализуют специальный анализ и проверку с использованием этого метода:

- Можно встроить учетные данные в URL-адрес перед именем хоста, используя `@` характер. Например:
    `https://hack@example.com
	В зависимости от анализатора URL-адресов он может обработать `https://hack` или `https://example.com`

- Можно использовать `#` символ в URL. Например:    
    `https://evil-host#comment`
    `#` - отбрасывает всё то что после неё

- Использовать иерархию имен DNS, чтобы поместить необходимые входные данные в полное DNS-имя, которым мы управляем. Например:
    `https://expected-host.evil-host`

- Закодировать символы URL-адреса, чтобы запутать код анализа URL-адресов.

- Использовать комбинации техник вместе.

#### Обход фильтров SSRF через открытое перенаправление

- `url_из_белого_списка&path=http://evil-user.net` - переведёт в конце на `http://evil-user.net`

----


---
# 4. SSRF-атака blind

- использование внеполосных методов ([OAST](https://portswigger.net/burp/application-security-testing/oast)). Это предполагает попытку инициировать HTTP-запрос к внешней системе, которую мы управляем, и мониторинг сетевых взаимодействий с этой системой.

- Заставить приложение подключиться к системе, находящейся под нашим контролем, и вернуть вредоносные ответы HTTP-клиенту, который устанавливает соединение

