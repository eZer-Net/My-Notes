В общем случае построение базовой атаки с использованием веб-кэша включает в себя следующие этапы:

1. **Определим целевую конечную точку, которая возвращает динамический ответ, содержащий конфиденциальную информацию**. Сосредоточимся на конечных точках, которые поддерживают ==методы `GET`, `HEAD`или , `OPTIONS`==.
2. **Определим несоответствие в том, как кэш и исходный сервер анализируют путь URL**. Это может быть несоответствие в том, как они:
    - Сопоставьте URL-адреса с ресурсами.
    - Обработка символов-разделителей.
    - Нормализовать пути.

3. **Создать вредоносный URL, который использует несоответствие, чтобы обмануть кэш и сохранить динамический ответ**. Когда жертва обращается к URL, ее ответ сохраняется в кэше. Используя Burp, ==мы сможем затем отправить запрос на тот же URL, чтобы получить кэшированный ответ, содержащий данные жертвы.== Избегайте делать это напрямую в браузере, так как некоторые приложения перенаправляют пользователей без сеанса или делают локальные данные недействительными, что может скрыть уязвимость.

Мы рассмотрим несколько различных подходов к построению атаки с использованием веб-кэша.

#### 1. Определение целевой конечной точки
##### Что это значит?
Нужно найти URL (например, `/account.php`, `/settings.php`, `/profile`), который:
- Возвращает **динамический контент** (например, личные данные пользователя).
- Поддерживает HTTP-методы `GET`, `HEAD` или `OPTIONS` (так как они обычно не изменяют состояние сервера и могут кэшироваться).

##### Зачем это нужно?
- Атака работает только если сервер отдаёт **конфиденциальные данные** в ответ на "безопасные" методы (`GET`/`HEAD`/`OPTIONS`).
- Если конечная точка требует `POST` или `PUT`, она обычно не кэшируется, и атака не сработает.

#### 2. Определение несоответствия в обработке URL

##### Что это значит?
Нужно найти разницу в том, как:
- **Сервер** обрабатывает URL (например, игнорирует часть пути).
- **Кэш** обрабатывает URL (например, считает его статическим файлом).

##### Типичные несоответствия:
1. **Сопоставление URL с ресурсами**
    - Сервер может отдавать `/profile.php/anything` как `/profile.php`, а кэш — считать это отдельным ресурсом.
2. **Обработка символов-разделителей**
    - Например, `/profile.php%3Ffake.css` может интерпретироваться сервером как `/profile.php`, а кэш его как CSS-файл.
3. **Нормализация пути**
    - Сервер может нормализовать `/profile.php/../index.php` в `/index.php`, а кэш — нет.

##### **Зачем это нужно?**
Чтобы заставить кэш сохранить **чужие личные данные** под ключом, который атакующий сможет запросить.
##### Пример:
- Если сервер отдаёт `/account.php/nonexistent.css` как `account.php`, а кэш сохраняет это как `nonexistent.css`, то атакующий может запросить `nonexistent.css` и получить чужие данные.


#### Примечание Использование кэш-блокировщика
При тестировании на несоответствия и создании эксплойта обмана веб-кэша убедиться, что каждый отправляемый нами запрос имеет другой ключ кэша. В противном случае могут быть предоставлены кэшированные ответы, что повлияет на результаты теста.

Поскольку и URL-путь, и любые параметры запроса обычно включены в ключ кэша, мы можем изменить ключ. Автоматизировать этот процесс с помощью расширения Param Miner. Для этого после установки расширения нужно щелкнуть меню верхнего уровня **Param miner > Settings** , затем выберите **Add dynamic cachebuster** . Теперь Burp добавляет уникальную строку запроса к каждому сделанному нами запросу. Мы можем просмотреть добавленные строки запроса на вкладке **Logger**.

### Обнаружение кэшированных ответов
Во время тестирования определить кэшированные ответ можно по заголовкам.
Различные заголовки ответа могут указывать на то, что он кэширован. Например:

- Заголовок `X-Cache`содержит информацию о том, был ли ответ подан из кэша. Типичные значения включают:
    - **`X-Cache: hit`- Ответ был получен из кэша.**
    - `X-Cache: miss`- Кэш не содержал ответа на ключ запроса, поэтому он был извлечен с исходного сервера. В большинстве случаев ответ затем кэшируется. Чтобы подтвердить это, нужно отправить запрос повторно, чтобы посмотреть, обновилось ли значение до попадания.
    - `X-Cache: dynamic`- Исходный сервер динамически сгенерировал контент. Обычно это означает, что ответ не подходит для кэширования.
    - `X-Cache: refresh`- Кэшированный контент устарел и его необходимо обновить или повторно проверить.
- Заголовок `Cache-Control`может включать директиву, которая указывает на кэширование, например, `public`с `max-age`более высоким значением, чем `0`. 
	Обратить внимание, что это только предполагает, что ресурс кэшируется. Это не всегда указывает на кэширование, так как кэш может иногда переопределять этот заголовок.

Если мы заметили большую разницу во времени ответа на один и тот же запрос, это также может указывать на то, что более быстрый ответ подается из кэша.

