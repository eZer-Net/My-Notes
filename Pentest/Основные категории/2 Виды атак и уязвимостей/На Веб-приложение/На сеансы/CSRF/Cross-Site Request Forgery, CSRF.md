
# Что такое CSRF?

Подделка межсайтовых запросов (также известная как CSRF) — это уязвимость веб-безопасности, которая позволяет злоумышленнику побуждать пользователей выполнять действия, которые они не собираются выполнять.

## Каковы последствия атаки CSRF?

При успешной атаке CSRF злоумышленник заставляет пользователя-жертву непреднамеренно выполнить действие. Например, это может быть изменение адреса электронной почты в их учетной записи, изменение пароля или перевод средств. В зависимости от характера действия злоумышленник может получить полный контроль над учетной записью пользователя. Если скомпрометированный пользователь имеет привилегированную роль в приложении, злоумышленник может получить полный контроль над всеми данными и функциями приложения.

## Как работает CSRF?

Чтобы CSRF-атака была возможной, должны быть соблюдены три ключевых условия:

- **Соответствующее действие.** Внутри приложения есть действие, которое у злоумышленника есть причина вызвать. Это может быть привилегированное действие (например, изменение разрешений для других пользователей) или любое действие с данными пользователя (например, изменение собственного пароля пользователя).
- **Обработка сеанса на основе файлов cookie.** Выполнение действия включает в себя отправку одного или нескольких HTTP-запросов, и ==приложение использует исключительно файлы cookie сеанса для идентификации пользователя==, отправившего запросы. Другого механизма для отслеживания сеансов или проверки запросов пользователей не существует.
- **Никаких непредсказуемых параметров запроса.** ==Запросы, выполняющие действие, не содержат параметров, значения которых злоумышленник не может определить или угадать.== Например, если заставить пользователя изменить свой пароль, функция не уязвима, если злоумышленнику необходимо знать значение существующего пароля.

#### Пример
предположим, что приложение содержит функцию, которая позволяет пользователю изменить адрес электронной почты в своей учетной записи. Когда пользователь выполняет это действие, он отправляет HTTP-запрос, подобный следующему:
```
POST /email/change HTTP/1.1 
Host: vulnerable-website.com 
Content-Type: application/x-www-form-urlencoded 
Content-Length: 30 
Cookie: session=yvthwsztyeQkAPzeQ5gHgTvlyxHfsAfE 

email=wiener@normal-user.com
```
Это соответствует условиям, необходимым для CSRF:
- Действие по изменению адреса электронной почты в учетной записи пользователя представляет интерес для злоумышленника. После этого действия злоумышленник обычно сможет инициировать сброс пароля и получить полный контроль над учетной записью пользователя.
- Приложение использует файл cookie сеанса, чтобы определить, какой пользователь отправил запрос. Никаких других токенов или механизмов для отслеживания пользовательских сеансов не существует.
- Злоумышленник может легко определить значения параметров запроса, необходимые для выполнения действия.

При соблюдении этих условий злоумышленник может создать веб-страницу, содержащую следующий HTML-код:
```
<html>
	<body> 
		<form action="https://vulnerable-website.com/email/change" method="POST"> 
		<input type="hidden" name="email" value="pwned@evil-user.net" /> 
		</form> 
			<script> document.forms[0].submit(); </script> 
	</body> 
</html>
```

Если пользователь-жертва посетит веб-страницу злоумышленника, произойдет следующее:

- Страница злоумышленника вызовет HTTP-запрос к уязвимому веб-сайту.
- Если пользователь вошел на уязвимый веб-сайт, его браузер автоматически включит в запрос файл cookie сеанса (при условии, что [файлы cookie SameSite](https://portswigger.net/web-security/csrf#common-defences-against-csrf) не используются).
- Уязвимый веб-сайт обработает запрос обычным способом, воспримет его как сделанный пользователем-жертвой и изменит свой адрес электронной почты.

## Как построить CSRF-атаку

Создание HTML, необходимого для эксплойта CSRF, можно вручную а можно создать эксплойт CSRF — использовать [генератор CSRF PoC](https://portswigger.net/burp/documentation/desktop/tools/engagement-tools/generate-csrf-poc) , встроенный в Burp Suite Professional:


## [[Общая защита от CSRF|Общая защита от CSRF]]


## [[Токен CSRF|Токен CSRF]]

----
## [[Распространенные недостатки проверки токена CSRF|Распространенные недостатки проверки токена CSRF]]

----
## [[Обход ограничений файлов cookie SameSite]]

----

# Дополнительная информация

[[Методика поиска и развития уязвимости CSRF]]

[CSRF-уязвимости](https://habr.com/ru/companies/oleg-bunin/articles/412855/) ссылка на доклад с хабра по конференции про данную уязвимость