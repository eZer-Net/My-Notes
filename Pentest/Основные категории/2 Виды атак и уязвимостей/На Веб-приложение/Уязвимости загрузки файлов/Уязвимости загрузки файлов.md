## Каковы уязвимости при загрузке файлов?

Уязвимости загрузки файлов — это когда веб-сервер позволяет пользователям загружать файлы в свою файловую систему без достаточной проверки таких параметров, как их имя, тип, содержимое или размер. Неспособность должным образом обеспечить соблюдение этих ограничений может означать, что вместо этого даже базовая функция загрузки изображений может использоваться для загрузки произвольных и потенциально опасных файлов. Сюда могут даже относиться файлы сценариев на стороне сервера, обеспечивающие удаленное выполнение кода.

В некоторых случаях загрузки файла само по себе достаточно, чтобы нанести ущерб. Другие атаки могут включать последующий HTTP-запрос файла, обычно для запуска его выполнения сервером.


## Каково влияние уязвимостей при загрузке файлов?

Влияние уязвимостей загрузки файлов обычно зависит от двух ключевых факторов:

- Какой аспект файла веб-сайт не может проверить должным образом, будь то его размер, тип, содержимое и т. д.
- Какие ограничения накладываются на файл после его успешной загрузки.

В худшем случае тип файла не проверяется должным образом, а конфигурация сервера допускает определенные типы файлов (например, `.php` и `.jsp`) для выполнения как кода. В этом случае злоумышленник потенциально может загрузить файл кода на стороне сервера, который функционирует как веб-оболочка, фактически предоставляя ему полный контроль над сервером.

Если имя файла не проверено должным образом, злоумышленник может перезаписать важные файлы, просто загрузив файл с тем же именем. Если сервер также уязвим для обхода каталогов, это может означать, что злоумышленники даже смогут загружать файлы в непредвиденные места.

Неспособность убедиться, что размер файла соответствует ожидаемым пороговым значениям, также может привести к возникновению атаки типа «отказ в обслуживании» (DoS), при которой злоумышленник заполняет доступное дисковое пространство.

## Как возникают уязвимости при загрузке файлов?

Учитывая довольно очевидные опасности, редко когда веб-сайты в дикой природе не имеют каких-либо ограничений на то, какие файлы разрешено загружать пользователям. Чаще всего разработчики реализуют то, что они считают надежной проверкой, которая либо изначально ошибочна, либо ее можно легко обойти.

Например, они могут попытаться занести в черный список опасные типы файлов, но не смогут учесть расхождения в анализе при проверке расширений файлов. Как и в случае с любым черным списком, здесь также легко случайно пропустить более малоизвестные типы файлов, которые все еще могут быть опасными.

В других случаях веб-сайт может попытаться проверить тип файла, проверив свойства, которыми злоумышленник может легко манипулировать с помощью таких инструментов, как Burp Proxy или Повторитель.

В конечном счете, даже надежные меры проверки могут применяться непоследовательно в сети хостов и каталогов, образующих веб-сайт, что приводит к несоответствиям, которыми можно воспользоваться.

### Как веб-серверы обрабатывают запросы статических файлов?

Исторически веб-сайты почти полностью состояли из статических файлов, которые предоставлялись пользователям по запросу. В результате путь каждого запроса может быть сопоставлен 1:1 с иерархией каталогов и файлов в файловой системе сервера. 
В настоящее время веб-сайты становятся все более динамичными, и путь запроса часто вообще не имеет прямого отношения к файловой системе. 
Тем не менее, веб-серверы по-прежнему обрабатывают запросы на некоторые статические файлы, включая таблицы стилей, изображения и т. д.

Сервер анализирует путь в запросе, чтобы определить расширение файла. Затем он использует это для определения типа запрашиваемого файла, обычно путем сравнения его со списком предварительно настроенных сопоставлений между расширениями и [[Компьютерные сети/Термины#Электронная почта MIME — многоцелевые расширения интернет-почты MIME|типами MIME]]. Дальнейшие действия зависят от типа файла и конфигурации сервера.

- Если этот тип файла не является исполняемым, например изображение или статическая HTML-страница, сервер может просто отправить содержимое файла клиенту в ответе HTTP.

- Если **тип файла является исполняемым, например файл PHP, и сервер настроен на выполнение файлов этого типа, он назначит переменные на основе заголовков и параметров в HTTP-запросе перед запуском сценария.** Полученный результат затем может быть отправлен клиенту в ответе HTTP.

- Если тип файла является исполняемым, но сервер **не** настроен для выполнения файлов этого типа, он обычно ответит ошибкой. Однако в некоторых случаях содержимое файла все же может быть передано клиенту в виде обычного текста. Такие неправильные настройки иногда могут быть использованы для утечки исходного кода и другой конфиденциальной информации. Пример этого вы можете увидеть в наших учебных материалах по раскрытию информации.

==`Content-Type` Заголовок ответа может дать подсказку о том, какой [[Типы файлов в Content-Type|тип файла]], по мнению сервера, он обслужил.==

----

## Вводная часть

### [[Использование неограниченной загрузки файлов для развертывания веб-оболочки]]

С точки зрения безопасности худший возможный сценарий — это когда веб-сайт позволяет загружать серверные сценарии, такие как файлы PHP, Java или Python, а также настроен на их выполнение в виде кода. Это упрощает создание собственной веб-оболочки на сервере.

#### Веб-оболочка
Веб-оболочка — это вредоносный сценарий, который позволяет злоумышленнику выполнять произвольные команды на удаленном веб-сервере, просто отправляя HTTP-запросы в нужную конечную точку.

### [[Использование ошибочной проверки загрузки файлов]]

----

## Методы по эксплуатации уязвимости 

### [[Предотвращение выполнения файлов в каталогах, доступных пользователю| Обход защиты в каталогах доступных пользователей]]

вторая линия защиты — не дать серверу выполнять любые сценарии, которые все же проскальзывают через сеть.

### [[Недостаточный черный список опасных типов файлов]]

Один из наиболее очевидных способов запретить пользователям загружать вредоносные скрипты — внести в черный список потенциально опасные расширения файлов, такие как `.php`. Практика внесения в черный список по своей сути ошибочна, поскольку сложно явно заблокировать все возможные расширения файлов, которые могут использоваться для выполнения кода. Такие черные списки иногда можно обойти, используя менее известные альтернативные расширения файлов, которые все еще могут быть исполняемыми, например `.php5`, `.shtml`, и так далее.

- Переопределение конфигурации сервера
- Запутывающие расширения файлов

### [[Неверная проверка содержимого файла]]

Проверить определенные внутренние свойства изображения, такие как его размеры

### [[Использование условий гонки загрузки файлов]]

Некоторые веб-сайты загружают файл непосредственно в основную файловую систему, а затем снова удаляют его, если он не проходит проверку

некоторые веб-сайты загружают файл непосредственно в основную файловую систему, а затем снова удаляют его, если он не проходит проверку

упростить подобные атаки, можно попытаться увеличить время, необходимое для обработки файла, тем самым удлинив окно для перебора имени каталога


# Использование уязвимостей загрузки файлов без удаленного выполнения кода

### Загрузка вредоносных сценариев на стороне клиента

Если мы не сможем выполнять сценарии на сервере, все равно можем загружать сценарии для атак на стороне клиента. Например, если можно загрузить HTML -файлы или изображения SVG, использовать `<script>` теги для создания сохраненных полезных данных [[XSS (Cross-Site Scripting)|XSS]].

Если загруженный файл затем появится на странице, которую посещают другие пользователи, их браузер выполнит сценарий при попытке отобразить страницу. Обратить внимание, что из-за ограничений политики одного и того же источника атаки такого типа будут работать только в том случае, если загруженный файл обслуживается из того же источника, в который вы его загружаете.

### Эксплуатация уязвимостей при парсинге загружаемых файлов

Если кажется, что загруженный файл хранится и обслуживается безопасно, последним средством является попытка использовать уязвимости, характерные для анализа или обработки файлов различных форматов. Например, вы знаете, что сервер анализирует файлы XML, такие как Microsoft Office. `.doc` или `.xls` файлы, это может быть потенциальным вектором для атак с внедрением [[XML external entity (XXE) injection|XXE]].

### Загрузка файлов с помощью PUT

Стоит отметить, что некоторые веб -серверы могут быть настроены на поддержку `PUT` запросы Если соответствующая защита нет, это может предоставить альтернативные средства загрузки вредоносных файлов, даже если функция загрузки недоступна через веб -интерфейс.

```
PUT /images/exploit.php HTTP/1.1 
Host: vulnerable-website.com 
Content-Type: application/x-httpd-php 
Content-Length: 49 

<?php echo file_get_contents('/path/to/file'); ?>
```

----
## [[Защито от уязвимостей при загрузки файлов|Как предотвращать уязвимости загрузки файлов]]



----
# Инструменты

[[Инструмент Burp Suite]]

# Дополнительная информация

[[Методика поиска и развития уязвимости загрузки файлов]]