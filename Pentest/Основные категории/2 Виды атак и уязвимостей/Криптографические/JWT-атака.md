## Что такое JWT?

**Веб-токен JSON (JWT)** — это стандартизированный формат для отправки криптографически подписанных данных JSON между системами. Теоретически они могут содержать любые данные, но чаще всего используются **для отправки информации («заявлений») о пользователях в рамках механизмов аутентификации, обработки сеансов и контроля доступа.**

В отличие от классических сеансовых токенов, ==все данные, необходимые серверу, хранятся на стороне клиента в самом JWT.== Это делает JWT популярным выбором для сильно распределенных веб-сайтов, где пользователям необходимо беспрепятственно взаимодействовать с несколькими внутренними серверами.

### Формат JWT

==JWT состоит из 3 частей: заголовка , полезной нагрузки и подписи==. Каждая из них разделена точкой, как показано в следующем примере:
```
eyJraWQiOiI5MTM2ZGRiMy1jYjBhLTRhMTktYTA3ZS1lYWRmNWE0NGM4YjUiLCJhbGciOiJSUzI1NiJ9.eyJpc3MiOiJwb3J0c3dpZ2dlciIsImV4cCI6MTY0ODAzNzE2NCwibmFtZSI6IkNhcmxvcyBNb250b3lhIiwic3ViIjoiY2FybG9zIiwicm9sZSI6ImJsb2dfYXV0aG9yIiwiZW1haWwiOiJjYXJsb3NAY2FybG9zLW1vbnRveWEubmV0IiwiaWF0IjoxNTE2MjM5MDIyfQ.SYZBPIBg2CRjXAJ8vCER0LA_ENjII1JakvNQoP-Hw6GG1zfl4JyngsZReIfqRvIAEi5L4HV0q7_9qGhQZvy9ZdxEJbwTxRs_6Lb-fZTDpW6lKYNdMyjw45_alSCZ1fypsMWz_2mTpQzil0lOtps5Ei_z7mM7M8gCwe_AGpI53JxduQOaB5HkT5gVrv9cKu9CsW5MS6ZbqYXpGyOG5ehoxqm8DL5tFYaW3lB50ELxi0KsuTKEbD0t5BCl0aCR2MBJWAbN-xeLwEenaqBiwPVvKixYleeDQiBEIylFdNNIMviKRgXiYuAvMziVPbwSgkZVHeEdF5MQP1Oe2Spac-6IfA
```

Заголовок и полезная нагрузка JWT — это просто **закодированные в base64**url объекты JSON. Заголовок содержит метаданные о самом токене, тогда как полезная нагрузка содержит фактические «заявления» о пользователе. Например, вы можете декодировать полезную нагрузку из токена выше, чтобы обнаружить следующие заявления:
```
{ 
	"iss": "portswigger", 
	"exp": 1648037164, 
	"name": "Carlos Montoya", 
	"sub": "carlos", 
	"role": "blog_author", 
	"email": "carlos@carlos-montoya.net", 
	"iat": 1516239022 
}
```

В большинстве случаев эти данные могут быть легко прочитаны или изменены любым лицом, имеющим доступ к токену. Поэтому **безопасность любого механизма на основе JWT в значительной степени зависит от криптографической подписи.**


### JWT-подпись

Сервер, который выпускает токен, обычно **генерирует подпись, хешируя заголовок и полезную нагрузку.** В некоторых случаях они также шифруют полученный хеш. В любом случае, этот процесс включает в себя секретный ключ подписи. Этот механизм позволяет серверам проверить, что никакие данные в токене не были подделаны с момента его выпуска:

- Поскольку подпись напрямую выводится из остальной части токена, изменение хотя бы одного байта заголовка или полезной нагрузки приводит к несовпадению подписи.
- Не зная секретного ключа подписи сервера, невозможно сгенерировать правильную подпись для данного заголовка или полезной нагрузки.

### JWT против JWS против JWE

Спецификация JWT на самом деле очень ограничена. Она определяет только формат представления информации («заявлений») как объекта JSON, который может передаваться между двумя сторонами. На практике JWT не используются как самостоятельная сущность. Спецификация JWT расширена спецификациями ==JSON Web Signature (JWS) и JSON Web Encryption (JWE)==, которые определяют конкретные способы фактической реализации JWT.

Другими словами, JWT обычно является токеном JWS или JWE. **Когда люди используют термин «JWT», они почти всегда имеют в виду токен JWS.** ==JWE очень похожи, за исключением того, что фактическое содержимое токена зашифровано==, а не просто закодировано.

# Что такое атаки JWT?

Атаки JWT включают отправку пользователем измененных JWT на сервер для достижения вредоносной цели. Обычно эта цель заключается в обходе аутентификации и контроля доступа путем выдачи себя за другого пользователя, который уже прошел аутентификацию.

## Как возникают уязвимости к атакам JWT?

Уязвимости JWT обычно возникают из-за некорректной обработки JWT в самом приложении. Различные спецификации связанные с JWT (JWS JWE), относительно гибки по своей сути, что позволяет разработчикам веб-сайтов самостоятельно решать многие детали реализации. Это может привести к тому, что они случайно внесут уязвимости даже при использовании проверенных временем библиотек.

Эти недостатки реализации обычно означают, что подпись JWT не проверяется должным образом. Это позволяет злоумышленнику подделывать значения, передаваемые приложению через полезную нагрузку токена. Даже если подпись надежно проверена, ее можно действительно доверять, в значительной степени основываясь на том, что секретный ключ сервера остается секретным. Если этот ключ каким-то образом утечет или его можно угадать или подобрать методом перебора, злоумышленник может сгенерировать действительную подпись для любого произвольного токена, скомпрометировав весь механизм.

### 1. Использование некорректной проверки подписи JWT

Библиотеки JWT обычно предоставляют один метод для проверки токенов и другой, который просто декодирует их. 
	Например, библиотека Node.js `jsonwebtoken`имеет `verify()`и `decode()`.

Иногда разработчики путают эти два метода и передают входящие токены только в `decode()`метод. Это фактически означает, что приложение вообще не проверяет подпись.

### 2. Прием токенов без подписи

Среди прочего, заголовок JWT содержит `alg`параметр. Он сообщает серверу, какой алгоритм использовался для подписи токена и, следовательно, какой алгоритм ему нужно использовать при проверке подписи.
```
{ 
	"alg": "HS256", 
	"typ": "JWT" 
}
```

Это изначально ошибочно, поскольку у сервера нет выбора, кроме как неявно доверять контролируемому пользователем вводу с токена, который на данный момент вообще не проверен. Другими словами, злоумышленник может напрямую влиять на то, как сервер проверяет, заслуживает ли токен доверия.

JWT могут быть подписаны с использованием ряда различных алгоритмов, но также могут быть оставлены неподписанными. В этом случае `alg`параметр устанавливается на `none`, что указывает на так называемый "незащищенный JWT". Из-за очевидных опасностей этого серверы обычно отклоняют токены без подписи. Однако, поскольку этот тип фильтрации основан на разборе строк, вы иногда можете обойти эти фильтры, используя классические методы обфускации, такие как смешанная заглавная буква и неожиданные кодировки.
```
{ 
	"alg": "none", 
	"typ": "JWT" 
}
```
Возможные варианты
`none None NoNe nOnE NONE`

#### Примечание
==Даже если токен не подписан, часть полезной нагрузки все равно должна заканчиваться точкой.==
```
Cookie: session=eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJpc3MiOiJwb3J0c3dpZ2dlciIsImV4cCI6MTc0NDg5MDUzOSwic3ViIjoiYWRtaW5pc3RhcnRvciJ9.
```


### 3. Подбор секретных ключей методом перебора

