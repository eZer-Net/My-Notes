
#### Что это?

- **Capabilities** (возможности) — ==это механизм в Linux, который позволяет разделить привилегии суперпользователя (root) на более мелкие и управляемые части.== Вместо того чтобы давать процессу все права root, можно предоставить только конкретные возможности, необходимые для выполнения задачи.

- Это помогает минимизировать риски, связанные с использованием полных прав root, и снижает вероятность эксплуатации уязвимостей.

#### Как работает Capabilities?

- В традиционной модели Linux, если процессу нужны привилегированные действия, он должен запускаться от имени root. Это дает процессу неограниченный доступ к системе, что может быть опасно.

- Capabilities позволяют разделить привилегии root на отдельные "возможности". Например, процесс может получить возможность привязываться к сетевым портам (CAP_NET_BIND_SERVICE), не имея при этом полного доступа к системе.

- Каждая capability представляет собой отдельную привилегию, которая может быть предоставлена процессу.


#### Примеры Capabilities

- **CAP_NET_BIND_SERVICE**: Позволяет процессу привязываться к сетевым портам с номером меньше 1024 (обычно требуют прав root).

- **CAP_CHOWN**: Позволяет процессу изменять владельца файла.

- **CAP_KILL**: Позволяет процессу отправлять сигналы другим процессам.

- **CAP_SYS_ADMIN**: Предоставляет широкий набор административных привилегий, таких как монтирование файловых систем, настройка сети и т.д.

- **CAP_DAC_OVERRIDE**: Позволяет процессу игнорировать проверки прав доступа к файлам (DAC — Discretionary Access Control).

#### Как назначаются Capabilities?

- Capabilities могут быть назначены процессу при его запуске или во время выполнения.

- Для назначения capabilities используются утилиты, такие как `setcap` и `getcap`.

- **Пример:**  
    Чтобы дать программе возможность привязываться к сетевым портам, можно использовать команду:
    `sudo setcap CAP_NET_BIND_SERVICE+ep /path/to/program`
    
    - `CAP_NET_BIND_SERVICE` — это capability, которую мы хотим назначить.
    
    - `+ep` означает, что capability будет добавлена к программе и будет действовать как для эффективного (effective), так и для разрешенного (permitted) наборов.

- **Проверка назначенных capabilities:**
    `getcap /path/to/program`

#### Наборы Capabilities

Каждый процесс в Linux имеет три набора capabilities:

1. **Effective**: Это набор capabilities, которые фактически используются процессом в данный момент.

2. **Permitted**: Это набор capabilities, которые процесс может использовать. Если capability отсутствует в этом наборе, процесс не может ее активировать.

3. **Inheritable**: Это набор capabilities, которые могут быть унаследованы дочерними процессами.

#### Пример работы Capabilities

| Процесс                 | Назначенные Capabilities | Действие                      |
| ----------------------- | ------------------------ | ----------------------------- |
| Веб-сервер              | CAP_NET_BIND_SERVICE     | Привязка к порту 80           |
| Пользовательский скрипт | CAP_CHOWN                | Изменение владельца файла     |
| Системный демон         | CAP_SYS_ADMIN            | Монтирование файловой системы |

#### Преимущества Capabilities

1. **Минимизация привилегий**: Процесс получает только те привилегии, которые ему действительно нужны, что снижает риск компрометации системы.

2. **Гибкость**: Администратор может точно настроить, какие возможности предоставить каждому процессу.

3. **Безопасность**: Даже если процесс скомпрометирован, злоумышленник будет ограничен только теми capabilities, которые были предоставлены.

#### Недостатки Capabilities

1. **Сложность управления**: Назначение и управление capabilities требует глубокого понимания системы и процессов.

2. **Ограниченная поддержка**: Не все приложения корректно работают с capabilities, особенно если они ожидают полных прав root.

3. **Риск ошибок**: Неправильное назначение capabilities может привести к сбоям в работе приложений или создать уязвимости.

#### Команды для работы с Capabilities

- **Просмотр capabilities процесса:**
    `cat /proc/<PID>/status | grep Cap`
    
- **Назначение capabilities программе:**
    `sudo setcap CAPABILITY+ep /path/to/program`
    
- **Удаление capabilities у программы:**
    `sudo setcap -r /path/to/program`
    
- **Проверка capabilities файла:**
    `getcap /path/to/program`

#### Пример использования Capabilities

Предположим, у нас есть веб-сервер, который должен привязываться к порту 80 (что обычно требует прав root). Вместо запуска веб-сервера от имени root, мы можем назначить ему capability `CAP_NET_BIND_SERVICE`:

1. Назначаем capability:
    `sudo setcap CAP_NET_BIND_SERVICE+ep /usr/sbin/nginx`
    
2. Проверяем назначенные capabilities:
    `getcap /usr/sbin/nginx`
    
3. Запускаем веб-сервер от имени обычного пользователя:
    `nginx`

Теперь веб-сервер может привязываться к порту 80, не имея полных прав root.