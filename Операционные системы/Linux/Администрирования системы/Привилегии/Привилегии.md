
`1` — `001` — `--x`
`2` — `010` — `-w-`
`4` — `100` — `r--`
**Специальные атрибуты (4 число в `ls -l`)**
`4 (SUID)` —  `с правами владельца файла запуск`
`2 (SGID)` —  `с правами группы`
`1 (Sticky Bit)` — `только владелец файла или root могут удалить или переименовать файлы в этой директории`

`/etc/passwd`
```
username:x:UID:GID:description:home_directory:login_shell
```
- **`username`** — имя пользователя.
- **`x`** — означает, что пароль хранится в `/etc/shadow`.
- **`UID`** — числовой идентификатор пользователя.
- **`GID`** — числовой идентификатор основной группы.
- Остальные поля — описание, домашняя директория и оболочка.

`/etc/shadow`
```
username:password:last_changed:min_days:max_days:warn_days:inactive_days:expire_date:reserved
```
**`sync:*:20025:0:99999:7:::`**
    - `sync` — имя пользователя.
    - `*` — пароль. `*` означает, что учётная запись **заблокирована** (нельзя войти с паролем).
    - `20025` — дата последнего изменения пароля (в днях с 1 января 1970, "эпохи Unix").
    - `0` — минимальное количество дней до следующего изменения пароля (0 = можно менять сразу).
    - `99999` — максимальное количество дней, через которые **нужно сменить пароль** (≈273 года = почти никогда).
    - `7` — количество дней, за которое система предупредит о необходимости смены пароля.
    - `::` — остальные поля (`inactive`, `expire`, `reserved`) не заданы.

### Пример записи прав доступа:

```
drwxrwxr-x 2 bob students 4096 сен 24 16:36 pesochnica
```
### Расшифровка прав доступа:

#### Первый символ (тип элемента):

- **`d`** — директория.
- **`-`** — файл.
- **`l`** — символическая ссылка.
- **`c`** — специальный файл символьного устройства (например, терминал или модем, обрабатывают данные потоками байтов).
- **`b`** — специальный файл блочного устройства (например, жёсткий диск или CD-ROM, обрабатывают данные блоками).
- **`s`** — сокет.
- **`p`** — именованный конвейер.

#### Последующие символы (права доступа):

Права доступа разделены на три группы по три символа:

1. **Первая группа** (`rwx`) — права владельца.
2. **Вторая группа** (`rwx`) — права группы.
3. **Третья группа** (`r-x`) — права остальных пользователей.

#### Расшифровка символов прав доступа:

- **`r` (read)**:
    - Для файла: открывать и читать содержимое.
    - Для директории: читать содержимое каталога (если установлен атрибут на выполнение `x`).
- **`w` (write)**:
    - Для файла: записывать в файл и усекать его. Не даёт переименовывать или удалять файл (это определяется правами вмещающего каталога).
    - Для директории: создавать, удалять и переименовывать файлы внутри каталога (если установлен атрибут на выполнение `x`).
- **`x` (execute)**:
    - Для файла: разрешает интерпретировать файл как программу и выполнять её. Для файлов сценариев также требуется атрибут на чтение `r`.
    - Для директории: разрешает вход в каталог (команда `cd`).

#### Специальные атрибуты:

- **`s` (setuid/setgid)**:    
    - Для файла:
        - Если установлен бит `setuid`, программа выполняется с правами владельца файла.
        - Если установлен бит `setgid`, программа выполняется с правами группы файла.
    - Для директории:
        - Если установлен бит `setgid`, новые файлы и подкаталоги наследуют группу родительской директории.

- **`t` (sticky bit)**:
    - Для директории: ограничивает удаление файлов. Только владелец файла или суперпользователь могут удалить или переименовать файл в этом каталоге.

#### Дополнительные символы:

- **`+`** в конце строки прав доступа (например, `-rw-rw-r--+`) указывает на наличие расширенных атрибутов, таких как списки управления доступом (ACL).
    
- **`.`** точка в конце строки прав доступа указывает на применение атрибута SELinux.

#### Кол. ссылок на этот файл или директорию
- `bob` - Имя владельца файла или директории
- `students` - Имя группы, к которой принадлежит файл или директория
- `4096` - Размер файла или директории в байтах. Для директорий это может быть размер метаданных
- `сен 24 16:36` - Дата и время последнего изменения файла или директории
- `pesochnica` - Имя файла или директории

---
## Команды для управления правами доступа:

#### `chmod` — изменение прав доступа:

##### Числовой формат:
`chmod 777 file.txt` 
- `7` — полные права (rwx).
- `0` — нет прав (---).

Пояснение:
- `0` — `000` — `---`.
- `1` — `001` — `--x`.
- `2` — `010` — `-w-`.
- `3` — `011` — `-wx`.
- `4` — `100` — `r--`.
- `5` — `101` — `r-x`.
- `6` — `110` — `rw-`.
- `7` — `111` — `rwx`.

##### Символьный формат:
`chmod u+rwx,g+r,o=x file.txt`

- `u` — владелец.
- `g` — группа.
- `o` — остальные.
- `a` — все (владелец, группа, остальные).
- `+` — добавить права.
- `-` — убрать права.
- `=` — установить точные права.

##### Рекурсивное применение:
`chmod -R 777 directory`

##### Четвертая цифра (дополнительные флаги)
Четвертая цифра используется для установки специальных флагов прав доступа. Она может принимать следующие значения:

1. **4 (SUID)**: Устанавливает бит SUID (Set User ID). Если этот бит установлен для исполняемого файла, то файл будет выполняться с правами владельца файла, а не пользователя, который его запустил.
    
2. **2 (SGID)**: Устанавливает бит SGID (Set Group ID). Если этот бит установлен для исполняемого файла, то файл будет выполняться с правами группы, к которой принадлежит файл. Если бит установлен для директории, то все файлы, созданные в этой директории, будут принадлежать группе директории.
    
3. **1 (Sticky Bit)**: Устанавливает Sticky Bit. Если этот бит установлен для директории, то только владелец файла или root могут удалить или переименовать файлы в этой директории, даже если другие пользователи имеют права на запись.

#### `chown` — изменение владельца и группы:

- Изменить владельца:
    `chown alice file.txt`
    
- Изменить группу:
    `chown :staff file.txt`
    
- Изменить владельца и группу:
    `chown alice:staff file.txt`

#### `umask` — маска прав по умолчанию:

- Устанавливает права по умолчанию для новых файлов и каталогов.
- Пример:
	`umask 022`

#### `su` — смена пользователя:

- Переключиться на другого пользователя:
    `su username`
- Переключиться на root:
    `su root`
- Запустить команду от имени другого пользователя:
    `su -c 'command' username`

#### `sudo` — выполнение команд с привилегиями:

- Выполнить команду от имени root:
    `sudo command`
- Переключиться на root:
    `sudo su`
- Редактировать конфигурацию sudo `/etc/sudoers`:
    `visudo`

#### `chroot` — изоляция файловой системы:

- Изменяет корневую директорию для процесса:
    `chroot /new/root /bin/bash`
    
- Используется для:
    - Изоляции среды.
    - Восстановления системы.
    - Повышения безопасности.

1. **Изоляция среды**:
    - `chroot` позволяет создать изолированное окружение, в котором ==процесс "думает", что корневая директория — это указанная папка==, и не видит файлы и каталоги за её пределами. Это полезно для:
        - Тестирования программного обеспечения в контролируемой среде.
        - Запуска приложений, которые должны работать в изолированной файловой системе.

2. **Безопасность**:
    - Если злоумышленник получит доступ к процессу, работающему в `chroot`, он не сможет выйти за пределы этой изолированной среды (если только не найдёт способ "сломать" `chroot`).
    - Однако `chroot` не является полноценным механизмом безопасности, так как он **не изолирует процессы на уровне ядра** (например, не ограничивает доступ к системным вызовам или сетевым ресурсам).

##### Как работает `chroot`?

1. **Изменение корневой директории**:
    - Когда вы выполняете команду `chroot /new/root /bin/bash`, процесс `bash` начинает "думать", что `/new/root` — это корневая директория (`/`). Все пути, которые он использует, будут относиться к этой новой корневой директории.

1. **Ограничение видимости файлов**:
    - Процесс в `chroot` не видит файлы и каталоги за пределами новой корневой директории. Например, если в `/new/root` нет каталога `/home`, то процесс не сможет получить доступ к файлам в `/home`.

2. **Зависимости и библиотеки**:
    - Для работы в `chroot` необходимо, чтобы в новой корневой директории были все необходимые библиотеки и утилиты. Например, если вы запускаете `bash`, то в `/new/root` должны быть доступны:
        
        - Сам `bash`.
        - Зависимые библиотеки (например, `libc`).
        - Утилиты, которые вы планируете использовать (например, `ls`, `cat` и т.д.).

##### ==Ограничения `chroot`==

1. **Неполная изоляция**:
    - `chroot` изолирует только файловую систему. Он не ограничивает доступ к:
        - Сетевых интерфейсам.
        - Процессам (через [[Процессы#`/proc`|`/proc`]]).
        - Устройствам (через `/dev`).
        - Системным вызовам.
    - Злоумышленник может использовать уязвимости в ядре или приложениях для "побега" из `chroot`.

2. **Сложность настройки**:
    - Для работы в `chroot` необходимо вручную копировать все необходимые библиотеки и утилиты, что может быть трудоёмким.

3. **Отсутствие контроля ресурсов**:
    - `chroot` не ограничивает использование ресурсов (CPU, память, диск и т.д.). Для этого требуются дополнительные механизмы, такие как `cgroups`.

#### `cgroups` — позволяет ограничивать, учитывать и изолировать использование ресурсов (CPU, память, диск, сеть и т.д.) для групп процессов.

##### Основные функции `cgroups`:
- **Ограничение ресурсов**:
    - Можно ограничить использование CPU, памяти, дискового ввода-вывода и других ресурсов для группы процессов.
- **Учёт ресурсов**:
    - `cgroups` позволяет отслеживать, сколько ресурсов использует каждая группа процессов.
- **Приоритизация**:
    - Можно задавать приоритеты для групп процессов, чтобы распределять ресурсы между ними.

##### Пример использования `cgroups`:

1. Создать группу:
    `sudo cgcreate -g cpu,memory:/mygroup`
2. Ограничить использование CPU:
    `echo 50000 > /sys/fs/cgroup/cpu/mygroup/cpu.cfs_quota_us`
3. Ограничить использование памяти:
    `echo 100M > /sys/fs/cgroup/memory/mygroup/memory.limit_in_bytes`
4. Добавить процесс в группу:
    `echo <PID> > /sys/fs/cgroup/cpu/mygroup/tasks`

#### `namespaces` — изолирует различные аспекты системы для группы процессов. 

Каждый namespace предоставляет изолированное представление ресурсов, таких как процессы, сетевые интерфейсы, файловая система и т.д. Можно думать об **namespace, как о ящике**. В этом ящике находятся системные ресурсы, которые точно зависят от типа ящика (namespace). В настоящее время существует семь типов пространств имён (namespaces): Cgroups, IPC, Network, Mount, PID, User, UTS. 

Одним их замечательных свойств ящиков является то, что вы можете **добавлять и удалять вещи из ящика и это никак не повлияет на содержимое других ящиков**. Тут та же идея с namespaces – процесс **P** может «сойти с ума» и выполнить `sudo rm –rf /`, но другой процесс **Q**, принадлежащий другому Mount namespace, не будет затронут, поскольку они они используют отдельные копии этих файлов.

##### Основные типы `namespaces`:

- **PID namespace**:
    - Изолирует идентификаторы процессов. Процессы в разных PID namespaces могут иметь одинаковые PID.
- **Mount namespace**:
    - Изолирует точки монтирования. Процессы в разных mount namespaces могут иметь разные файловые системы.
- **UTS namespace**:
    - Изолирует hostname и domainname.
- **IPC namespace**:
    - Изолирует межпроцессное взаимодействие (очереди сообщений, семафоры, shared memory).
- **Network namespace**:
    - Изолирует сетевые интерфейсы, IP-адреса, таблицы маршрутизации и т.д.
- **User namespace**:
    - Изолирует идентификаторы пользователей и групп. Позволяет процессам иметь привилегии root внутри namespace, но не на хостовой системе.

##### Пример использования `namespaces`:

1. Создать новый PID namespace:
    `unshare --pid --fork --mount-proc /bin/bash`
    
2. Проверить изоляцию:
    `ps aux`

---

## Специальные биты разрешений:

#### SETUID:
Позволяет запускать файл с правами владельца.
- Установить:
    `chmod u+s file`
- Снять:
    `chmod u-s file`

Пример:
![[Pasted image 20241221143034.png]]
#### SETGID:
Позволяет запускать файл с правами группы.
- Установить:
    `chmod g+s file`
- Снять:
    `chmod g-s file`

#### Sticky Bit:
Ограничивает удаление файлов в каталоге.
    
- Установить:
    `chmod +t directory`
- Снять:
    `chmod -t directory`

---

## UID и GID

- **UID (User ID)** — уникальный идентификатор пользователя в системе. Каждый пользователь имеет свой UID, который используется для определения прав доступа.
    
    - Обычные пользователи имеют UID, начиная с 1000 (в большинстве дистрибутивов Linux).
        
    - UID 0 зарезервирован для суперпользователя (root), который имеет полные права на все действия в системе.
        
- **GID (Group ID)** — уникальный идентификатор группы. Каждый пользователь может принадлежать к одной или нескольким группам, и GID используется для управления групповыми правами доступа.

==UID (User ID) пользователей в Linux можно посмотреть в файле `/etc/passwd` или с помощью команды `id`.==

/etc/passwd/
```
username:x:UID:GID:description:home_directory:login_shell
```
- **`username`** — имя пользователя.
- **`x`** — означает, что пароль хранится в `/etc/shadow`.
- **`UID`** — числовой идентификатор пользователя.
- **`GID`** — числовой идентификатор основной группы.
- Остальные поля — описание, домашняя директория и оболочка.

### Смысл чисел в UID/GID

- **UID 0 (root)** — суперпользователь, который имеет неограниченные права в системе. Это самый привилегированный пользователь, который может изменять любые файлы, настраивать систему и управлять другими пользователями.

- **UID 1–999** — системные пользователи, которые используются для запуска служб и демонов. Они имеют ограниченные права и используются для изоляции процессов.

- **UID 1000+** — обычные пользователи, которые создаются для работы в системе. Их права ограничены в соответствии с настройками DAC.

---

## Команды по работе с пользователями 

#### **Команда `useradd`**

**Назначение:** Добавление пользователей (требует прав суперпользователя).

**Параметры:**

- **`-c "комментарий"`**  
    Добавляет комментарий к учетной записи (обычно используется для указания полного имени пользователя).

- **`-d домашний_каталог`**  
    Указывает домашний каталог пользователя. По умолчанию это `/home/имя_пользователя`.

- **`-D`**  
    Выводит значения по умолчанию для создания пользователей (например, путь к домашнему каталогу, оболочка, группа и т.д.).

- **`-e дата_устаревания`**  
    Устанавливает дату истечения срока действия учетной записи (формат: ГГГГ-ММ-ДД).

- **`-f -1`**  
    Устанавливает количество дней после истечения срока действия пароля до блокировки учетной записи.
    - `-1` — отключает блокировку.
    - `0` — блокирует учетную запись сразу после истечения срока действия пароля.

- **`-g группа`**  
    Указывает основную группу пользователя (группа должна существовать в `/etc/group`).

- **`-G список_групп`**  
    Добавляет пользователя в дополнительные группы (список групп через запятую).  
    **Важно:** При использовании с `usermod` обязательно добавлять параметр `-aG`, чтобы не удалить существующие группы.

- **`-k skel_dir`**  
    Указывает каталог с шаблонами для копирования в домашний каталог пользователя (используется с `-m`).

- **`-m`**  
    Создает домашний каталог пользователя и копирует туда файлы из `/etc/skel`.

- **`-M`**  
    Не создает домашний каталог пользователя, даже если это поведение по умолчанию.

- **`-p пароль`**  
    Устанавливает зашифрованный пароль для учетной записи.

- **`-s оболочка`**  
    Указывает командную оболочку пользователя (например, `/bin/bash` или `/bin/zsh`).

---

#### **Команда `usermod`**

**Назначение:** Изменение учетной записи пользователя.

**Параметры:**

- **`-c "имя_пользователя"`**  
    Изменяет описание учетной записи.

- **`-d домашний_каталог`**  
    Изменяет домашний каталог пользователя.

- **`-e дата_устаревания`**  
    Устанавливает новую дату истечения срока действия учетной записи (формат: ГГГГ-ММ-ДД).    

- **`-f -1`**  
    Устанавливает количество дней до блокировки учетной записи после истечения срока действия пароля.

- **`-g группа`**  
    Изменяет основную группу пользователя.

- **`-G список_групп`**  
    Добавляет пользователя в дополнительные группы.  
    **Важно:** Используйте `-aG`, чтобы не удалить существующие группы.

- **`-l новое_имя`**  
    Изменяет имя учетной записи.

- **`-L`**  
    Блокирует учетную запись (добавляет восклицательный знак перед паролем в `/etc/shadow`).

- **`-U`**  
    Разблокирует учетную запись.

- **`-m`**  
    Копирует содержимое домашнего каталога в новый каталог (используется с `-d`).


**Примеры:**
- `usermod -s /bin/csh chris` — изменяет оболочку пользователя `chris` на `/bin/csh`.
- `usermod -Ga sales,marketing chris` — добавляет пользователя `chris` в группы `sales` и `marketing`.

#### **Команда `userdel`**

**Назначение:** Удаление пользователей.

**Параметры:**

- **`-f`**  
    Принудительное удаление пользователя, даже если он в системе.

- **`-r`**  
    Удаляет домашний каталог и почтовый ящик пользователя.

- **`-R, --root КАТ_CHROOT`**  
    Указывает корневой каталог для выполнения команды в chroot-окружении.

- **`-P, --prefix PREFIX_DIR`**  
    Указывает префиксный каталог для конфигурационных файлов (например, `/etc/passwd`).

- **`-Z, --selinux-user`**  
    Удаляет все сопоставления SELinux для пользователя.

#### **Команда `groupadd`**

**Назначение:** Создание учетных записей групп.

**Особенности:**

- Идентификаторы групп (GID) от 0 до 999 зарезервированы для системных групп.

- Группы обычных пользователей начинаются с GID 1000.

**Пример:**
- `groupadd developers` — создает группу с именем `developers`.

#### **Дополнительные команды:**

- **`id username`**  
    Показывает UID (идентификатор пользователя) и GID (идентификатор группы) для указанного пользователя.
